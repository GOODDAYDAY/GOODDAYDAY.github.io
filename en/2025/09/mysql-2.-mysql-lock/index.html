<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>[MySQL] 2. Lock Mechanism Execution Analysis - GoodyHao's Blog</title><meta name=Description content="Elegance Never Fades"><meta property="og:url" content="https://gooddayday.github.io/en/2025/09/mysql-2.-mysql-lock/"><meta property="og:site_name" content="GoodyHao's Blog"><meta property="og:title" content="[MySQL] 2. Lock Mechanism Execution Analysis"><meta property="og:description" content="Introduction In high-concurrency environments, database locking mechanisms are crucial for ensuring data consistency and integrity. MySQL, as a widely-used relational database, provides various lock types and mechanisms to manage concurrent access. However, improper use of locks may lead to performance bottlenecks, deadlocks, and other issues that affect system stability and response time.
Basic Lock-Related Concepts Lock Definition: A lock is a mechanism used to control access to shared resources, preventing multiple transactions from modifying the same data simultaneously, thereby ensuring data consistency and integrity. Lock Types: Table-level Lock: Locks the entire table. Shared Lock (S Lock): Allows multiple transactions to read data simultaneously but prevents modification. Exclusive Lock (X Lock): Allows one transaction to modify data while preventing other transactions from reading or modifying. Intention Locks (IS and IX Locks): Used at the table level to indicate that a transaction intends to acquire locks at the row level. Auto-increment Lock (AUTO-INC Lock): Used to handle concurrent inserts on auto-increment columns, preventing conflicts. Gap Lock: Locks the gaps between index records to prevent phantom reads. Next-Key Lock: Combines record locks and gap locks, locking index records and the gaps before them. Record Lock: Locks specific index records. Row-level Lock: Locks specific rows. Optimistic Lock: Implemented through version numbers or timestamps, suitable for read-heavy scenarios. Pessimistic Lock: Implemented through explicit locking, suitable for write-heavy scenarios. Deadlock: Multiple transactions wait for each other to release locks, resulting in inability to continue execution. Lock Compatibility: Compatibility rules exist between different types of locks, determining which locks can coexist. Lock Granularity: The scope of locked resources; finer granularity provides higher system concurrency but increases management overhead. MySQL Lock Introduction Basic Commands Create test table 1 2 3 4 5 6 7 8 9 -- auto-generated definition create table example_single_pk ( id bigint not null comment 'id' primary key, created timestamp default CURRENT_TIMESTAMP not null comment 'create time', updated timestamp default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'update time' ) comment 'example_single_pk' charset = utf8mb4; Execute commands 1 2 3 4 5 6 7 8 9 10 11 12 13 SELECT id, created, updated FROM example_single_pk; INSERT INTO example_single_pk (id) VALUES (1); SELECT id, created, updated FROM example_single_pk; UPDATE example_single_pk SET id = 6 WHERE id = 1; SELECT id, created, updated FROM example_single_pk; DELETE FROM example_single_pk WHERE id = 1 or id = 6; SELECT id, created, updated FROM example_single_pk; Results 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 mysql> SELECT id, created, updated FROM example_single_pk; Empty set (0.00 sec) mysql> mysql> INSERT INTO example_single_pk (id) VALUES (1); Query OK, 1 row affected (0.00 sec) mysql> mysql> SELECT id, created, updated FROM example_single_pk; +----+---------------------+---------------------+ | id | created | updated | +----+---------------------+---------------------+ | 1 | 2025-09-27 11:14:40 | 2025-09-27 11:14:40 | +----+---------------------+---------------------+ 1 row in set (0.00 sec) mysql> mysql> UPDATE example_single_pk SET id = 6 WHERE id = 1; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql> mysql> SELECT id, created, updated FROM example_single_pk; +----+---------------------+---------------------+ | id | created | updated | +----+---------------------+---------------------+ | 6 | 2025-09-27 11:14:40 | 2025-09-27 11:14:40 | +----+---------------------+---------------------+ 1 row in set (0.00 sec) mysql> mysql> DELETE FROM example_single_pk WHERE id = 1 or id = 6; Query OK, 1 row affected (0.00 sec) mysql> mysql> SELECT id, created, updated FROM example_single_pk; Empty set (0.00 sec) Classification by Granularity Table-level Lock - READ Locking 1 2 mysql> LOCK TABLES example_single_pk READ; Query OK, 0 rows affected (0.00 sec)"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-27T19:02:17+08:00"><meta property="article:modified_time" content="2025-12-06T22:29:56+08:00"><meta property="article:tag" content="MySQL"><meta property="article:tag" content="Lock"><meta property="og:image" content="https://gooddayday.github.io/logo.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gooddayday.github.io/logo.jpg"><meta name=twitter:title content="[MySQL] 2. Lock Mechanism Execution Analysis"><meta name=twitter:description content="Introduction In high-concurrency environments, database locking mechanisms are crucial for ensuring data consistency and integrity. MySQL, as a widely-used relational database, provides various lock types and mechanisms to manage concurrent access. However, improper use of locks may lead to performance bottlenecks, deadlocks, and other issues that affect system stability and response time.
Basic Lock-Related Concepts Lock Definition: A lock is a mechanism used to control access to shared resources, preventing multiple transactions from modifying the same data simultaneously, thereby ensuring data consistency and integrity. Lock Types: Table-level Lock: Locks the entire table. Shared Lock (S Lock): Allows multiple transactions to read data simultaneously but prevents modification. Exclusive Lock (X Lock): Allows one transaction to modify data while preventing other transactions from reading or modifying. Intention Locks (IS and IX Locks): Used at the table level to indicate that a transaction intends to acquire locks at the row level. Auto-increment Lock (AUTO-INC Lock): Used to handle concurrent inserts on auto-increment columns, preventing conflicts. Gap Lock: Locks the gaps between index records to prevent phantom reads. Next-Key Lock: Combines record locks and gap locks, locking index records and the gaps before them. Record Lock: Locks specific index records. Row-level Lock: Locks specific rows. Optimistic Lock: Implemented through version numbers or timestamps, suitable for read-heavy scenarios. Pessimistic Lock: Implemented through explicit locking, suitable for write-heavy scenarios. Deadlock: Multiple transactions wait for each other to release locks, resulting in inability to continue execution. Lock Compatibility: Compatibility rules exist between different types of locks, determining which locks can coexist. Lock Granularity: The scope of locked resources; finer granularity provides higher system concurrency but increases management overhead. MySQL Lock Introduction Basic Commands Create test table 1 2 3 4 5 6 7 8 9 -- auto-generated definition create table example_single_pk ( id bigint not null comment 'id' primary key, created timestamp default CURRENT_TIMESTAMP not null comment 'create time', updated timestamp default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'update time' ) comment 'example_single_pk' charset = utf8mb4; Execute commands 1 2 3 4 5 6 7 8 9 10 11 12 13 SELECT id, created, updated FROM example_single_pk; INSERT INTO example_single_pk (id) VALUES (1); SELECT id, created, updated FROM example_single_pk; UPDATE example_single_pk SET id = 6 WHERE id = 1; SELECT id, created, updated FROM example_single_pk; DELETE FROM example_single_pk WHERE id = 1 or id = 6; SELECT id, created, updated FROM example_single_pk; Results 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 mysql> SELECT id, created, updated FROM example_single_pk; Empty set (0.00 sec) mysql> mysql> INSERT INTO example_single_pk (id) VALUES (1); Query OK, 1 row affected (0.00 sec) mysql> mysql> SELECT id, created, updated FROM example_single_pk; +----+---------------------+---------------------+ | id | created | updated | +----+---------------------+---------------------+ | 1 | 2025-09-27 11:14:40 | 2025-09-27 11:14:40 | +----+---------------------+---------------------+ 1 row in set (0.00 sec) mysql> mysql> UPDATE example_single_pk SET id = 6 WHERE id = 1; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql> mysql> SELECT id, created, updated FROM example_single_pk; +----+---------------------+---------------------+ | id | created | updated | +----+---------------------+---------------------+ | 6 | 2025-09-27 11:14:40 | 2025-09-27 11:14:40 | +----+---------------------+---------------------+ 1 row in set (0.00 sec) mysql> mysql> DELETE FROM example_single_pk WHERE id = 1 or id = 6; Query OK, 1 row affected (0.00 sec) mysql> mysql> SELECT id, created, updated FROM example_single_pk; Empty set (0.00 sec) Classification by Granularity Table-level Lock - READ Locking 1 2 mysql> LOCK TABLES example_single_pk READ; Query OK, 0 rows affected (0.00 sec)"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://gooddayday.github.io/en/2025/09/mysql-2.-mysql-lock/><link rel=prev href=https://gooddayday.github.io/en/2025/09/github-4.-value-checker/><link rel=next href=https://gooddayday.github.io/en/2025/09/mysql-3.-mysql-index/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[MySQL] 2. Lock Mechanism Execution Analysis","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/gooddayday.github.io\/en\/2025\/09\/mysql-2.-mysql-lock\/"},"image":["https:\/\/gooddayday.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"MySQL, Lock","wordcount":8294,"url":"https:\/\/gooddayday.github.io\/en\/2025\/09\/mysql-2.-mysql-lock\/","datePublished":"2025-09-27T19:02:17+08:00","dateModified":"2025-12-06T22:29:56+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/gooddayday.github.io\/images\/logo.jpg"},"author":{"@type":"Person","name":"GoodyHao"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/en/ title="GoodyHao's Blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>Elegance Never Fades</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/en/posts/>Posts </a><a class=menu-item href=/en/tags/>Tags </a><a class=menu-item href=/en/categories/>Categories </a><a class=menu-item href=/en/categories/documentation/>Docs </a><a class=menu-item href=/en/about/>About </a><a class=menu-item href=https://github.com/GOODDAYDAY/GOODDAYDAY.github.io title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a class=menu-item href=/zh-cn/2025/09/mysql-2.-mysql-lock/ title=简体中文>中文</a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/en/ title="GoodyHao's Blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>Elegance Never Fades</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/en/posts/ title>Posts</a><a class=menu-item href=/en/tags/ title>Tags</a><a class=menu-item href=/en/categories/ title>Categories</a><a class=menu-item href=/en/categories/documentation/ title>Docs</a><a class=menu-item href=/en/about/ title>About</a><a class=menu-item href=https://github.com/GOODDAYDAY/GOODDAYDAY.github.io title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a class=menu-item href=/zh-cn/2025/09/mysql-2.-mysql-lock/ title=简体中文>中文</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">[MySQL] 2. Lock Mechanism Execution Analysis</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/en/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>GoodyHao</a></span>&nbsp;<span class=post-category>included in <a href=/en/categories/mysql/><i class="far fa-folder fa-fw" aria-hidden=true></i>MySQL</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2025-09-27>2025-09-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;8294 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;39 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#basic-lock-related-concepts>Basic Lock-Related Concepts</a></li><li><a href=#mysql-lock-introduction>MySQL Lock Introduction</a><ul><li><a href=#basic-commands>Basic Commands</a></li><li><a href=#classification-by-granularity>Classification by Granularity</a><ul><li><a href=#table-level-lock---read>Table-level Lock - READ</a><ul><li><a href=#locking><strong>Locking</strong></a></li><li><a href=#unlocking><strong>Unlocking</strong></a></li></ul></li><li><a href=#table-level-lock---write>Table-level Lock - WRITE</a><ul><li><a href=#locking-1><strong>Locking</strong></a></li><li><a href=#unlocking-1><strong>Unlocking</strong></a></li></ul></li><li><a href=#row-level-lock---select--for-share>Row-level Lock - SELECT &mldr; FOR SHARE</a><ul><li><a href=#locking-2><strong>Locking</strong></a></li><li><a href=#unlocking-2><strong>Unlocking</strong></a></li></ul></li><li><a href=#row-level-lock---select--for-update>Row-level Lock - SELECT &mldr; FOR UPDATE</a><ul><li><a href=#locking-3><strong>Locking</strong></a></li><li><a href=#unlocking-3><strong>Unlocking</strong></a></li></ul></li></ul></li><li><a href=#classification-by-attributes>Classification by Attributes</a><ul><li><a href=#shared-locks--exclusive-locks>Shared Locks & Exclusive Locks</a></li><li><a href=#auto-increment-lock-auto-inc-lock>Auto-increment Lock (AUTO-INC Lock)</a></li><li><a href=#intention-lock>Intention Lock</a><ul><li><a href=#hierarchical-positioning-server-layers-row-lock-signal-officer>Hierarchical Positioning: Server Layer&rsquo;s &ldquo;Row Lock Signal Officer&rdquo;</a></li><li><a href=#core-design-goal-solving-information-gap-in-layered-architecture>Core Design Goal: Solving &ldquo;Information Gap&rdquo; in Layered Architecture</a></li><li><a href=#linkage-mechanism-with-row-lockstable-locks>Linkage Mechanism with Row Locks/Table Locks</a></li><li><a href=#why-are-intention-locks-lightweight>Why Are Intention Locks &ldquo;Lightweight&rdquo;?</a></li><li><a href=#value-summary-trading-minimal-overhead-for-maximum-correctness>Value Summary: Trading Minimal Overhead for Maximum Correctness</a></li></ul></li></ul></li><li><a href=#classification-by-algorithm-innodb-engine>Classification by Algorithm (InnoDB Engine)</a><ul><li><a href=#practical-operation-instructions>Practical Operation Instructions</a><ul><li><a href=#insert>INSERT</a><ul><li><a href=#insert-into--1>insert into -1</a></li><li><a href=#insert-into-0>insert into 0</a></li></ul></li><li><a href=#select-for-update>SELECT FOR UPDATE</a><ul><li><a href=#select-for-update--1>select for update -1</a></li><li><a href=#select-for-update-0>select for update 0</a></li><li><a href=#select-for-update-1>select for update 1</a></li><li><a href=#select-for-update-2>select for update 2</a></li><li><a href=#select-for-update-3>select for update 3</a></li><li><a href=#select-for-update-4>select for update 4</a></li><li><a href=#select-for-update-5>select for update 5</a></li><li><a href=#select-for-update-6>select for update 6</a></li></ul></li><li><a href=#select-for-update-range>SELECT FOR UPDATE RANGE</a><ul><li><a href=#select-for-update-range--1-1>SELECT FOR UPDATE RANGE [-1, 1)</a></li><li><a href=#select-for-update-range-0-2>SELECT FOR UPDATE RANGE [0, 2)</a></li><li><a href=#select-for-update-range-1-3>SELECT FOR UPDATE RANGE [1, 3)</a></li><li><a href=#select-for-update-range-2-4>SELECT FOR UPDATE RANGE [2, 4)</a></li><li><a href=#select-for-update-range-3-5>SELECT FOR UPDATE RANGE [3, 5)</a></li><li><a href=#select-for-update-range-4-6>SELECT FOR UPDATE RANGE [4, 6)</a></li><li><a href=#select-for-update-range-5-7>SELECT FOR UPDATE RANGE [5, 7)</a></li><li><a href=#select-for-update-range-6-8>SELECT FOR UPDATE RANGE [6, 8)</a></li></ul></li></ul></li></ul></li><li><a href=#appendix>Appendix</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=introduction>Introduction</h2><p>In high-concurrency environments, database locking mechanisms are crucial for ensuring data consistency and integrity. MySQL, as a widely-used relational database, provides various lock types and mechanisms to manage concurrent access. However, improper use of locks may lead to performance bottlenecks, deadlocks, and other issues that affect system stability and response time.</p><h2 id=basic-lock-related-concepts>Basic Lock-Related Concepts</h2><ul><li><strong>Lock Definition</strong>: A lock is a mechanism used to control access to shared resources, preventing multiple transactions from modifying the same data simultaneously, thereby ensuring data consistency and integrity.</li><li><strong>Lock Types</strong>:<ul><li><strong>Table-level Lock</strong>: Locks the entire table.</li><li><strong>Shared Lock (S Lock)</strong>: Allows multiple transactions to read data simultaneously but prevents modification.</li><li><strong>Exclusive Lock (X Lock)</strong>: Allows one transaction to modify data while preventing other transactions from reading or modifying.</li><li><strong>Intention Locks (IS and IX Locks)</strong>: Used at the table level to indicate that a transaction intends to acquire locks at the row level.</li><li><strong>Auto-increment Lock (AUTO-INC Lock)</strong>: Used to handle concurrent inserts on auto-increment columns, preventing conflicts.</li><li><strong>Gap Lock</strong>: Locks the gaps between index records to prevent phantom reads.</li><li><strong>Next-Key Lock</strong>: Combines record locks and gap locks, locking index records and the gaps before them.</li><li><strong>Record Lock</strong>: Locks specific index records.</li><li><strong>Row-level Lock</strong>: Locks specific rows.</li><li><strong>Optimistic Lock</strong>: Implemented through version numbers or timestamps, suitable for read-heavy scenarios.</li><li><strong>Pessimistic Lock</strong>: Implemented through explicit locking, suitable for write-heavy scenarios.</li></ul></li><li><strong>Deadlock</strong>: Multiple transactions wait for each other to release locks, resulting in inability to continue execution.</li><li><strong>Lock Compatibility</strong>: Compatibility rules exist between different types of locks, determining which locks can coexist.</li><li><strong>Lock Granularity</strong>: The scope of locked resources; finer granularity provides higher system concurrency but increases management overhead.</li></ul><h2 id=mysql-lock-introduction>MySQL Lock Introduction</h2><h3 id=basic-commands>Basic Commands</h3><ul><li>Create test table</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- auto-generated definition
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>example_single_pk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w>      </span><span class=nb>bigint</span><span class=w>                              </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;id&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>created</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;create time&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>updated</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>update</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;update time&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;example_single_pk&#39;</span><span class=w> </span><span class=n>charset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>utf8mb4</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Execute commands</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DELETE</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Results</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Empty</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>created</span><span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>updated</span><span class=w>             </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>27</span><span class=w> </span><span class=mi>11</span><span class=p>:</span><span class=mi>14</span><span class=p>:</span><span class=mi>40</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>27</span><span class=w> </span><span class=mi>11</span><span class=p>:</span><span class=mi>14</span><span class=p>:</span><span class=mi>40</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>created</span><span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>updated</span><span class=w>             </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>6</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>27</span><span class=w> </span><span class=mi>11</span><span class=p>:</span><span class=mi>14</span><span class=p>:</span><span class=mi>40</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>27</span><span class=w> </span><span class=mi>11</span><span class=p>:</span><span class=mi>14</span><span class=p>:</span><span class=mi>40</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Empty</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=classification-by-granularity>Classification by Granularity</h3><h4 id=table-level-lock---read>Table-level Lock - READ</h4><h5 id=locking><strong>Locking</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=n>TABLES</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>READ</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/1.1%20lock%20tables%20read.png data-srcset="/images/12.%20mysql%20lock/1.1%20lock%20tables%20read.png, /images/12.%20mysql%20lock/1.1%20lock%20tables%20read.png 1.5x, /images/12.%20mysql%20lock/1.1%20lock%20tables%20read.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/1.1%20lock%20tables%20read.png title="1. lock tables read.png"></p><ul><li>At this point, other sessions can read data but cannot perform write operations.</li></ul><h5 id=unlocking><strong>Unlocking</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=n>UNLOCK</span><span class=w> </span><span class=n>tables</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/1.2%20unlock%20tables%20read.png data-srcset="/images/12.%20mysql%20lock/1.2%20unlock%20tables%20read.png, /images/12.%20mysql%20lock/1.2%20unlock%20tables%20read.png 1.5x, /images/12.%20mysql%20lock/1.2%20unlock%20tables%20read.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/1.2%20unlock%20tables%20read.png title="1.2 unlock tables read.png"></p><ul><li>As can be seen, other sessions can read normally but <code>cannot</code> write data.</li></ul><h4 id=table-level-lock---write>Table-level Lock - WRITE</h4><h5 id=locking-1><strong>Locking</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=n>TABLES</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>WRITE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/2.1%20lock%20tables%20write.png data-srcset="/images/12.%20mysql%20lock/2.1%20lock%20tables%20write.png, /images/12.%20mysql%20lock/2.1%20lock%20tables%20write.png 1.5x, /images/12.%20mysql%20lock/2.1%20lock%20tables%20write.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/2.1%20lock%20tables%20write.png title="2.1 lock tables write.png"></p><h5 id=unlocking-1><strong>Unlocking</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=n>UNLOCK</span><span class=w> </span><span class=n>tables</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/2.2%20unlock%20tables%20write.png data-srcset="/images/12.%20mysql%20lock/2.2%20unlock%20tables%20write.png, /images/12.%20mysql%20lock/2.2%20unlock%20tables%20write.png 1.5x, /images/12.%20mysql%20lock/2.2%20unlock%20tables%20write.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/2.2%20unlock%20tables%20write.png title="2.2 unlock tables write.png"></p><ul><li>As can be seen, other sessions can neither read <code>nor</code> write data.</li><li>Overall, table-level locks have larger granularity, suitable for scenarios involving bulk operations on entire tables, but they affect concurrency performance.</li><li>Not recommended for use.</li></ul><h4 id=row-level-lock---select--for-share>Row-level Lock - SELECT &mldr; FOR SHARE</h4><h5 id=locking-2><strong>Locking</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>SHARE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Empty</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/3.1%20select%20for%20share.png data-srcset="/images/12.%20mysql%20lock/3.1%20select%20for%20share.png, /images/12.%20mysql%20lock/3.1%20select%20for%20share.png 1.5x, /images/12.%20mysql%20lock/3.1%20select%20for%20share.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/3.1%20select%20for%20share.png title="3.1 select for share.png"></p><ul><li>At this point, it affects locks within other sessions.</li><li>Other sessions can read data but cannot perform write operations. We won&rsquo;t elaborate further or take screenshots.</li></ul><h5 id=unlocking-2><strong>Unlocking</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/3.2%20select%20for%20share%20commit.png data-srcset="/images/12.%20mysql%20lock/3.2%20select%20for%20share%20commit.png, /images/12.%20mysql%20lock/3.2%20select%20for%20share%20commit.png 1.5x, /images/12.%20mysql%20lock/3.2%20select%20for%20share%20commit.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/3.2%20select%20for%20share%20commit.png title="3.2 select for share commit.png"></p><ul><li>After unlocking, read locks and write locks can be acquired normally.</li></ul><h4 id=row-level-lock---select--for-update>Row-level Lock - SELECT &mldr; FOR UPDATE</h4><h5 id=locking-3><strong>Locking</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>UPDATE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Empty</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/4.1%20select%20for%20update.png data-srcset="/images/12.%20mysql%20lock/4.1%20select%20for%20update.png, /images/12.%20mysql%20lock/4.1%20select%20for%20update.png 1.5x, /images/12.%20mysql%20lock/4.1%20select%20for%20update.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/4.1%20select%20for%20update.png title="4.1 select for update.png"></p><ul><li>From the data query perspective, there&rsquo;s no difference from <code>FOR SHARE</code>, as it affects locks within other sessions.</li><li><code>FOR UPDATE</code> locks the selected rows, preventing other transactions from reading or modifying these rows.</li></ul><h5 id=unlocking-3><strong>Unlocking</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/4.2%20select%20for%20update%20commit.png data-srcset="/images/12.%20mysql%20lock/4.2%20select%20for%20update%20commit.png, /images/12.%20mysql%20lock/4.2%20select%20for%20update%20commit.png 1.5x, /images/12.%20mysql%20lock/4.2%20select%20for%20update%20commit.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/4.2%20select%20for%20update%20commit.png title="4.2 select for update commit.png"></p><ul><li>After unlocking, read locks and write locks can be acquired normally.</li></ul><h3 id=classification-by-attributes>Classification by Attributes</h3><h4 id=shared-locks--exclusive-locks>Shared Locks & Exclusive Locks</h4><table><thead><tr><th>No.</th><th>Lock Name</th><th>Trigger Method</th><th>Lock Type</th><th>Scope</th><th>Key Features</th></tr></thead><tbody><tr><td>1</td><td>Table-level Shared Lock (S Lock)</td><td>LOCK TABLES tbl_name READ</td><td>Server layer lock</td><td>Entire table</td><td>Allows other sessions to read, blocks writes; requires manual UNLOCK TABLES.</td></tr><tr><td>2</td><td>Table-level Exclusive Lock (X Lock)</td><td>LOCK TABLES tbl_name WRITE</td><td>Server layer lock</td><td>Entire table</td><td>Blocks other sessions from reading/writing; requires manual UNLOCK TABLES.</td></tr><tr><td>3</td><td>Row-level Shared Lock (S Lock)</td><td>SELECT &mldr; FOR SHARE (within transaction)</td><td>InnoDB row lock</td><td>Single row</td><td>Allows other sessions to read the row, blocks writes; auto-unlocked after transaction commit/rollback.</td></tr><tr><td>4</td><td>Row-level Exclusive Lock (X Lock)</td><td>SELECT &mldr; FOR UPDATE (within transaction)</td><td>InnoDB row lock</td><td>Single row</td><td>Blocks other sessions from reading/writing the row; auto-unlocked after transaction commit/rollback.</td></tr></tbody></table><h4 id=auto-increment-lock-auto-inc-lock>Auto-increment Lock (AUTO-INC Lock)</h4><ul><li><strong>Trigger Method</strong>: Automatically triggered when <code>INSERT</code> statements operate on AUTO_INCREMENT columns</li><li><strong>Features</strong>: AUTO-INC lock ensures continuity and uniqueness of auto-increment values. Different from row locks, but behavior results are similar.</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/5.1%20auto%20inc%20double%20insert%20success.png data-srcset="/images/12.%20mysql%20lock/5.1%20auto%20inc%20double%20insert%20success.png, /images/12.%20mysql%20lock/5.1%20auto%20inc%20double%20insert%20success.png 1.5x, /images/12.%20mysql%20lock/5.1%20auto%20inc%20double%20insert%20success.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/5.1%20auto%20inc%20double%20insert%20success.png title="5.1 auto inc double insert success.png"></p><ul><li>As can be seen, there&rsquo;s no conflict between auto-increment locks, and both sessions successfully insert data.</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/5.2%20auto%20inc%20double%20insert%20same%20id.png data-srcset="/images/12.%20mysql%20lock/5.2%20auto%20inc%20double%20insert%20same%20id.png, /images/12.%20mysql%20lock/5.2%20auto%20inc%20double%20insert%20same%20id.png 1.5x, /images/12.%20mysql%20lock/5.2%20auto%20inc%20double%20insert%20same%20id.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/5.2%20auto%20inc%20double%20insert%20same%20id.png title="5.2 auto inc double insert same id.png"></p><ul><li>Obviously, when the ID is determined, the behavior becomes similar to row locks, and the second session fails to insert.</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/5.3%20auto%20inc%20double%20insert%20same%20id%20fail.png data-srcset="/images/12.%20mysql%20lock/5.3%20auto%20inc%20double%20insert%20same%20id%20fail.png, /images/12.%20mysql%20lock/5.3%20auto%20inc%20double%20insert%20same%20id%20fail.png 1.5x, /images/12.%20mysql%20lock/5.3%20auto%20inc%20double%20insert%20same%20id%20fail.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/5.3%20auto%20inc%20double%20insert%20same%20id%20fail.png title="5.3 auto inc double insert same id fail.png"></p><ul><li>After commit, we can see that data insertion failed due to ID conflict.</li></ul><h4 id=intention-lock>Intention Lock</h4><p>Intention locks are server-level table locks designed by the InnoDB storage engine to coordinate conflicts between &ldquo;server layer (MySQL main process) table locks&rdquo; and &ldquo;storage engine layer row locks&rdquo;. Their core purpose is to transmit the signal &ldquo;row locks exist in the storage engine&rdquo;, allowing the server layer to quickly determine compatibility between table locks and row locks, avoiding high-cost conflict detection. The following explains from the perspectives of hierarchical positioning, design goals, linkage mechanisms, and lightweight reasons:</p><p>Intention locks serve as &ldquo;row lock signal lights&rdquo; at the server layer—using minimal overhead of table-level locks to transmit row lock status from the storage engine, enabling efficient coordination between two-layer lock mechanisms, both correctly and performantly.</p><h5 id=hierarchical-positioning-server-layers-row-lock-signal-officer>Hierarchical Positioning: Server Layer&rsquo;s &ldquo;Row Lock Signal Officer&rdquo;</h5><p>• <strong>Server Layer</strong>: MySQL main process manages server-level locks (such as LOCK TABLES), which is a native lock mechanism independent of storage engines.</p><p>• <strong>Storage Engine Layer</strong>: InnoDB manages row-level locks (such as X locks from SELECT &mldr; FOR UPDATE), controlling access to specific data rows.</p><p>• <strong>Role of Intention Locks</strong>: Intention locks belong to server layer table locks, but they don&rsquo;t directly control data rows—instead, they act as &ldquo;translators&rdquo;, converting row lock status in the storage engine (&ldquo;transactions are operating on certain rows&rdquo;) into &ldquo;signals&rdquo; understandable by the server layer (table-level IS/IX locks).</p><h5 id=core-design-goal-solving-information-gap-in-layered-architecture>Core Design Goal: Solving &ldquo;Information Gap&rdquo; in Layered Architecture</h5><p><strong>MySQL&rsquo;s layered architecture (server layer vs storage engine layer) naturally isolates lock status:</strong></p><p>• When the server layer wants to add table locks, it cannot directly perceive whether there are row locks in the storage engine (e.g., transaction A has locked certain rows);</p><p>• Row locks in the storage engine also don&rsquo;t care whether there are table locks at the server layer.</p><p>Without intention locks, when the server layer adds table locks, it must traverse all rows in the storage engine (O(n) time complexity) to check for row lock conflicts—this would be catastrophic performance loss for large tables.</p><p><strong>The emergence of intention locks optimizes this &ldquo;traversal check&rdquo; to O(1) signal judgment:</strong></p><p>• When the storage engine adds row locks, it automatically registers corresponding intention locks with the server layer (IS=row read intention, IX=row write intention);</p><p>• When the server layer adds table locks, it only needs to check table-level intention lock status to immediately determine conflicts.</p><h5 id=linkage-mechanism-with-row-lockstable-locks>Linkage Mechanism with Row Locks/Table Locks</h5><p><strong>The lifecycle of intention locks is completely dependent on row locks, serving as &ldquo;shadows&rdquo; of row locks:</strong></p><p>• Row locks trigger intention locks: When a transaction adds row locks (S/X) to certain rows, the InnoDB engine automatically notifies the server layer to add corresponding intention locks (IS or IX) at the table level.</p><p>• Example: SELECT * FROM t WHERE id=1 FOR UPDATE (adds row X lock) → Server layer adds table-level IX lock (intention exclusive lock).</p><p>• Table locks check intention locks: When a transaction tries to add server layer table locks, the server layer checks table-level intention locks:</p><p>• If there&rsquo;s an IX lock (intention exclusive lock) at table level, it indicates row locks are active in the storage engine, and table locks (such as LOCK TABLES &mldr; WRITE) will be blocked;</p><p>• If there&rsquo;s an IS lock (intention shared lock) at table level, it indicates row read locks exist in the storage engine, table read locks (LOCK TABLES &mldr; READ) are compatible, but table write locks are still blocked.</p><h5 id=why-are-intention-locks-lightweight>Why Are Intention Locks &ldquo;Lightweight&rdquo;?</h5><p><strong>The &ldquo;lightweight&rdquo; nature of intention locks stems from their minimal state space and automatic synchronization mechanism:</strong></p><p>• Limited lock scope: Only locks the concept of &ldquo;entire table&rdquo; (table level), doesn&rsquo;t involve specific data rows, no need to maintain lock status for each row (such as heap_no or trx_id in row locks).</p><p>• Extremely simple state: Only needs to record two &ldquo;intentions&rdquo;—IS (transactions want to read rows), IX (transactions want to write rows), logical complexity far lower than row locks.</p><p>• Automatic synchronization: Automatically triggered by InnoDB engine when adding/releasing row locks, no manual management required, no additional human or system overhead.</p><h5 id=value-summary-trading-minimal-overhead-for-maximum-correctness>Value Summary: Trading Minimal Overhead for Maximum Correctness</h5><p><strong>The essence of intention locks is using &ldquo;lightweight state&rdquo; of table-level locks to connect lock mechanisms between server layer and storage engine layer:</strong></p><p>• For server layer: Quickly determine whether table locks conflict with row locks, avoiding high cost of traversing all rows;</p><p>• For storage engine: No need to care about server layer table locks, focus on managing row locks;</p><p>• For overall concurrency: Ensures data consistency (avoiding conflicts between table locks and row locks) while maintaining high concurrency performance.</p><h3 id=classification-by-algorithm-innodb-engine>Classification by Algorithm (InnoDB Engine)</h3><p><strong>1. Record Lock</strong></p><p><strong>2. Gap Lock</strong></p><p><strong>3. Next-key Lock</strong></p><h4 id=practical-operation-instructions>Practical Operation Instructions</h4><table><thead><tr><th>Operation Type</th><th>Common Scenario</th><th>Lock Type</th><th>Lock Range</th><th>Isolation Level Dependency</th><th>Main Conflict Objects</th><th>Notes</th></tr></thead><tbody><tr><td>SELECT</td><td>Normal query (without FOR UPDATE/SHARE)</td><td>No lock</td><td>None</td><td>None</td><td>None</td><td>Read without lock (snapshot read)</td></tr><tr><td>SELECT FOR UPDATE</td><td>Equality query (record exists)</td><td>Record lock (LOCK_REC_NOT_GAP)</td><td>Specific record (e.g., id=3)</td><td>RR/RC</td><td>Record locks and next-key locks on same record</td><td>Locks target row, blocks modification/deletion</td></tr><tr><td>SELECT FOR UPDATE</td><td>Equality query (record doesn&rsquo;t exist, RR)</td><td>Gap lock (LOCK_GAP)</td><td>Gap between adjacent records (e.g., (1,5))</td><td>RR</td><td>Gap locks and insert intention locks in same gap</td><td>Prevents other transactions from inserting missing records (phantom read)</td></tr><tr><td>SELECT FOR UPDATE</td><td>Equality query (record doesn&rsquo;t exist, RC)</td><td>No lock</td><td>None</td><td>RC</td><td>None</td><td>RC has no gap locks, only read without lock</td></tr><tr><td>SELECT FOR UPDATE</td><td>Range query (e.g., id>2, RR)</td><td>Next-key lock (LOCK_NEXT_KEY)</td><td>Record+predecessor gap (e.g., (3,3], (3,5])</td><td>RR</td><td>Record locks and gap locks on same record</td><td>Locks all records and gaps in range (prevents phantom read)</td></tr><tr><td>SELECT FOR UPDATE</td><td>Range query (e.g., id>2, RC)</td><td>Record lock</td><td>Records meeting conditions (e.g., id=3,5)</td><td>RC</td><td>Record locks on same record</td><td>RC has no gap locks, only locks existing records</td></tr><tr><td>INSERT</td><td>Insert new record (any scenario)</td><td>Insert intention lock (LOCK_INSERT_INTENTION)</td><td>Gap between adjacent records (e.g., (1,5))</td><td>None (always added)</td><td>Normal gap locks and record locks in same gap</td><td>Coordinates insert exclusion, conflicts with normal locks</td></tr><tr><td>DELETE</td><td>Equality deletion (record exists)</td><td>Record lock (LOCK_REC_NOT_GAP)</td><td>Specific record (e.g., id=3)</td><td>RR/RC</td><td>Record locks and next-key locks on same record</td><td>Locks target row, blocks modification/insertion</td></tr><tr><td>DELETE</td><td>Range deletion (e.g., id>2, RR)</td><td>Next-key lock (LOCK_NEXT_KEY)</td><td>Record+predecessor gap (e.g., (3,3], (3,5])</td><td>RR</td><td>Record locks and gap locks on same record</td><td>Locks all records and gaps in range (prevents phantom read)</td></tr><tr><td>DELETE</td><td>Range deletion (e.g., id>2, RC)</td><td>Record lock</td><td>Records meeting conditions (e.g., id=3,5)</td><td>RC</td><td>Record locks on same record</td><td>RC has no gap locks, only locks existing records</td></tr><tr><td>UPDATE</td><td>Equality update (record exists)</td><td>Record lock (LOCK_REC_NOT_GAP)</td><td>Specific record (e.g., id=3)</td><td>RR/RC</td><td>Record locks and next-key locks on same record</td><td>Locks target row, blocks modification/insertion</td></tr><tr><td>UPDATE</td><td>Range update (e.g., id>2, RR)</td><td>Next-key lock (LOCK_NEXT_KEY)</td><td>Record+predecessor gap (e.g., (3,3], (3,5])</td><td>RR</td><td>Record locks and gap locks on same record</td><td>Locks all records and gaps in range (prevents phantom read)</td></tr><tr><td>UPDATE</td><td>Range update (e.g., id>2, RC)</td><td>Record lock</td><td>Records meeting conditions (e.g., id=3,5)</td><td>RC</td><td>Record locks on same record</td><td>RC has no gap locks, only locks existing records</td></tr></tbody></table><h5 id=insert>INSERT</h5><ul><li>Insert operations use <code>insert intention locks</code></li></ul><h6 id=insert-into--1>insert into -1</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>0.0</td><td></td><td>SESSION 2 START - Waiting for Session1&mldr;</td></tr><tr><td style=text-align:center>0.3</td><td>SESSION 1 START - INSERT</td><td>=== Round 0: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk</td><td></td></tr><tr><td style=text-align:center>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>3 rows (0.03s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>=== Round -1: Testing INSERT ID=-1 ===</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 1 row affected (0.03s)</td><td></td></tr></tbody></table><ul><li>Session 1 inserts a record with ID=-1 and keeps the transaction uncommitted, holding an <code>insert intention lock</code>.</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>0.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td style=text-align:center>3.7</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>4.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td style=text-align:center>7.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><ul><li>Session 2 queries the record with ID=-1, finds that the record exists but is held by Session 1&rsquo;s <code>insert intention lock</code>, causing the query to block waiting for lock release, ultimately timing out and failing.</li><li>Session 2 attempts to insert a record with ID=-1, also failing due to conflict timeout.</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>7.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td style=text-align:center>7.5</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>7.7</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.02s)</td></tr><tr><td style=text-align:center>8.0</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 1 FOR UPDATE</td></tr><tr><td style=text-align:center>8.1</td><td></td><td>SELECT returned 1 rows (0.03s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>8.4</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (1)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr><tr><td style=text-align:center>8.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>9.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>9.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>9.7</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>10.1</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 1 rows (0.03s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>10.4</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (4)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr><tr><td style=text-align:center>10.8</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 1 rows (0.02s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>11.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr><tr><td style=text-align:center>11.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>11.9</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.06s)</td></tr><tr><td style=text-align:center>12.3</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.04s)</td></tr><tr><td style=text-align:center>12.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>12.7</td><td>mysql> rollback</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr></tbody></table><ul><li>Subsequent operations proceed without issues.</li></ul><h6 id=insert-into-0>insert into 0</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>12.9</td><td>=== Round 0: Testing INSERT ID=0 ===</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>13.0</td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td><td>=== Round 1: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>Query OK, 1 row affected (0.02s)</td><td></td></tr></tbody></table><ul><li>Session 1 inserts a record with ID=0 and keeps the transaction uncommitted, holding an <code>insert intention lock</code>.</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>13.2</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td style=text-align:center>13.3</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>13.5</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td style=text-align:center>13.6</td><td></td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>13.8</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td style=text-align:center>16.9</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>17.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td style=text-align:center>20.2</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.04s) (3.04s)</td></tr></tbody></table><ul><li>Session 2 queries the record with ID=0, finds that the record exists but is held by Session 1&rsquo;s <code>insert intention lock</code>, causing the query to block waiting for lock release, ultimately timing out and failing.</li><li>Session 2 attempts to insert a record with ID=0, also failing due to conflict timeout.</li><li>Subsequent operations follow the same pattern and won&rsquo;t be elaborated further.</li></ul><h5 id=select-for-update>SELECT FOR UPDATE</h5><h6 id=select-for-update--1>select for update -1</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>0.0</td><td></td><td>SESSION 2 START - Waiting for Session1&mldr;</td></tr><tr><td>0.3</td><td>SESSION 1 START - SELECT_FOR_UPDATE</td><td></td></tr><tr><td>~</td><td>mysql> SELECT * FROM example_single_pk</td><td></td></tr><tr><td>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td>~</td><td>3 rows (0.03s)</td><td></td></tr><tr><td>~</td><td>=== Round -1: Testing SELECT_FOR_UPDATE ID=-1 ===</td><td></td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>0.4</td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td><td>=== Round 0: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>Query returned 0 rows (0.03s)</td><td></td></tr></tbody></table><ul><li>Database contains data with ID=1,4,5</li><li>Session1 performs <code>SELECT FOR UPDATE</code> for ID=-1, holding a <code>gap lock</code> for the range [-∞, 1) where no records exist, locking the gap [-∞, 1) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>0.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td>0.8</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>1.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td>4.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>4.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>4.7</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td>7.7</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-0>select for update 0</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>12.9</td><td>=== Round 0: Testing SELECT_FOR_UPDATE ID=0 ===</td><td>=== Round 1: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td><td></td></tr><tr><td>~</td><td>Query returned 0 rows (0.03s)</td><td></td></tr></tbody></table><ul><li>Session1 performs <code>SELECT FOR UPDATE</code> for ID=0, holding a <code>gap lock</code> for the range [-∞, 1) where no records exist, locking the gap [-∞, 1) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>13.2</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>13.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td>16.6</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>16.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>17.2</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td>20.2</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-1>select for update 1</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>25.3</td><td>=== Round 1: Testing SELECT_FOR_UPDATE ID=1 ===</td><td></td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>25.4</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 1 FOR UPDATE</td><td>=== Round 2: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>Query returned 1 rows (0.02s)</td><td></td></tr><tr><td>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>Session1 performs <code>SELECT FOR UPDATE</code> for ID=1, holding a <code>record lock</code> on ID=1, preventing other transactions from modifying or deleting this record.</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>27.3</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 1 FOR UPDATE</td></tr><tr><td>30.4</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.05s) (3.05s)</td></tr><tr><td>30.7</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (1)</td></tr><tr><td>33.7</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-2>select for update 2</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>38.5</td><td>=== Round 2: Testing SELECT_FOR_UPDATE ID=2 ===</td><td></td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>38.6</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td><td>=== Round 3: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>Query returned 0 rows (0.05s)</td><td></td></tr></tbody></table><ul><li>Session1 performs <code>SELECT FOR UPDATE</code> for ID=2, holding a <code>gap lock</code> for the range (1,4) where no records exist, locking the gap (1,4) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>41.0</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td>41.1</td><td></td><td>SELECT returned 0 rows (0.04s)</td></tr><tr><td>41.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td>44.4</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td>44.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>45.0</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td>48.0</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-3>select for update 3</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>51.2</td><td>=== Round 3: Testing SELECT_FOR_UPDATE ID=3 ===</td><td>=== Round 4: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td><td></td></tr><tr><td>~</td><td>Query returned 0 rows (0.03s)</td><td></td></tr></tbody></table><ul><li>Session1 performs <code>SELECT FOR UPDATE</code> for ID=3, holding a <code>gap lock</code> for the range (1,4) where no records exist, locking the gap (1,4) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>53.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>53.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td>56.9</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>57.2</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>57.5</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td>60.5</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-4>select for update 4</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>63.6</td><td>=== Round 4: Testing SELECT_FOR_UPDATE ID=4 ===</td><td>=== Round 5: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td><td></td></tr><tr><td>~</td><td>Query returned 1 rows (0.03s)</td><td></td></tr><tr><td>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>Session1 performs <code>SELECT FOR UPDATE</code> for ID=4, holding a <code>record lock</code> on ID=4, preventing other transactions from modifying or deleting this record.</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>67.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td></tr><tr><td>70.4</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>70.7</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (4)</td></tr><tr><td>73.8</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-5>select for update 5</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>76.2</td><td>=== Round 5: Testing SELECT_FOR_UPDATE ID=5 ===</td><td></td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>76.3</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td><td>=== Round 6: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>Query returned 1 rows (0.02s)</td><td></td></tr><tr><td>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>Session1 performs <code>SELECT FOR UPDATE</code> for ID=5, holding a <code>record lock</code> on ID=5, preventing other transactions from modifying or deleting this record.</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>80.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td>84.0</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>84.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td>87.3</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-6>select for update 6</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>89.0</td><td>=== Round 6: Testing SELECT_FOR_UPDATE ID=6 ===</td><td>=== Round 7: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td><td></td></tr><tr><td>~</td><td>Query returned 0 rows (0.04s)</td><td></td></tr></tbody></table><ul><li>Session1 performs <code>SELECT FOR UPDATE</code> for ID=6, holding a <code>gap lock</code> for the range [6, ∞) where no records exist, locking the gap [6, ∞) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>94.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td>97.7</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>97.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td>98.0</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>98.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td>101.4</td><td>mysql> rollback</td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h5 id=select-for-update-range>SELECT FOR UPDATE RANGE</h5><h6 id=select-for-update-range--1-1>SELECT FOR UPDATE RANGE [-1, 1)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>0.0</td><td></td><td>SESSION 2 START - Waiting for Session1&mldr;</td></tr><tr><td style=text-align:center>0.2</td><td>SESSION 1 START - SELECT_FOR_UPDATE_RANGE</td><td></td></tr><tr><td style=text-align:center>0.3</td><td>mysql> SELECT * FROM example_single_pk</td><td>=== Round 0: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>3 rows (0.03s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>=== Round -1: Testing SELECT_FOR_UPDATE_RANGE ID=-1 ===</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= -1 AND id &lt; 1 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 0 rows (0.03s)</td><td></td></tr></tbody></table><ul><li>Database contains data with ID=1,4,5</li><li>Session1 performs <code>SELECT FOR UPDATE</code> on range [-1, 1), holding a <code>gap lock</code> for the range [-∞, 1) where no records exist, locking the gap [-∞, 1) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>0.6</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td style=text-align:center>0.7</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>1.0</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td style=text-align:center>4.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>4.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>4.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td style=text-align:center>7.8</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><ul><li><code>Gap lock</code> for the range [-∞, 1) where no records exist, locking the gap [-∞, 1) to prevent other transactions from inserting records within this range.</li><li>Session2&rsquo;s query operations for ID=-1 and ID=0 are not blocked because they share the same <code>gap lock</code>.</li><li>Session2&rsquo;s insert operations for ID=-1 and ID=0 are blocked.</li></ul><h6 id=select-for-update-range-0-2>SELECT FOR UPDATE RANGE [0, 2)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>12.9</td><td>=== Round 0: Testing SELECT_FOR_UPDATE_RANGE ID=0 ===</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>13.0</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 0 AND id &lt; 2 FOR UPDATE</td><td>=== Round 1: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>Range query returned 1 rows (0.02s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>Database contains data with ID=1,4,5</li><li>Session1 performs <code>SELECT FOR UPDATE</code> on range [0, 2), holding a <code>gap lock</code> for the range [-∞, 3) where no records exist, locking the gap [-∞, 3) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>13.3</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>13.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td style=text-align:center>16.6</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>16.8</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td style=text-align:center>16.9</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>17.2</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td style=text-align:center>20.2</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>20.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 1 FOR UPDATE</td></tr><tr><td style=text-align:center>23.5</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>23.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (1)</td></tr><tr><td style=text-align:center>26.9</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>27.1</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td style=text-align:center>27.2</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>27.5</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td style=text-align:center>30.5</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>30.8</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>31.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td style=text-align:center>34.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>34.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 1 rows (0.03s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>34.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (4)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr><tr><td style=text-align:center>35.1</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td style=text-align:center>35.2</td><td></td><td>SELECT returned 1 rows (0.03s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>35.4</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr><tr><td style=text-align:center>35.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td></tr><tr><td style=text-align:center>35.8</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>36.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>36.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>36.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td style=text-align:center>36.9</td><td>mysql> rollback</td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr></tbody></table><h6 id=select-for-update-range-1-3>SELECT FOR UPDATE RANGE [1, 3)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>37.2</td><td>=== Round 1: Testing SELECT_FOR_UPDATE_RANGE ID=1 ===</td><td>=== Round 2: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 1 AND id &lt; 3 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 1 rows (0.02s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>Database contains data with ID=1,4,5</li><li>Session1 performs <code>SELECT FOR UPDATE</code> on range [1, 3), holding a <code>gap lock</code> for the range [1, 3) where no records exist, locking the gap [1, 3) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>39.0</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 1 FOR UPDATE</td></tr><tr><td style=text-align:center>42.0</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>42.4</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (1)</td></tr><tr><td style=text-align:center>45.4</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>45.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td style=text-align:center>45.8</td><td></td><td>SELECT returned 0 rows (0.04s)</td></tr><tr><td style=text-align:center>46.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td style=text-align:center>49.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>49.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>49.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td style=text-align:center>52.9</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-range-2-4>SELECT FOR UPDATE RANGE [2, 4)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>55.9</td><td>=== Round 2: Testing SELECT_FOR_UPDATE_RANGE ID=2 ===</td><td>=== Round 3: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 2 AND id &lt; 4 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 0 rows (0.04s)</td><td></td></tr></tbody></table><ul><li>Database contains data with ID=1,4,5</li><li>Session1 performs <code>SELECT FOR UPDATE</code> on range [2, 4), holding a <code>gap lock</code> for the range [2, 4) where no records exist, locking the gap [2, 4) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>58.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td style=text-align:center>58.5</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>58.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td style=text-align:center>61.8</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>62.1</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>62.4</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td style=text-align:center>65.4</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-range-3-5>SELECT FOR UPDATE RANGE [3, 5)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>68.6</td><td>=== Round 3: Testing SELECT_FOR_UPDATE_RANGE ID=3 ===</td><td>=== Round 4: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 3 AND id &lt; 5 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 1 rows (0.02s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>Database contains data with ID=1,4,5</li><li>Session1 performs <code>SELECT FOR UPDATE</code> on range [3, 5), holding a <code>gap lock</code> for the range [2, 5) where no records exist, locking the gap [2, 5) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>70.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td style=text-align:center>71.0</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>71.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td style=text-align:center>74.3</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>74.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>75.0</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td style=text-align:center>78.0</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>78.3</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td></tr><tr><td style=text-align:center>81.3</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>81.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (4)</td></tr><tr><td style=text-align:center>84.6</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>84.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 1 rows (0.03s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>85.2</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr></tbody></table><h6 id=select-for-update-range-4-6>SELECT FOR UPDATE RANGE [4, 6)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>86.8</td><td>=== Round 4: Testing SELECT_FOR_UPDATE_RANGE ID=4 ===</td><td>=== Round 5: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 4 AND id &lt; 6 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 2 rows (0.03s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>Database contains data with ID=1,4,5</li><li>Session1 performs <code>SELECT FOR UPDATE</code> on range [4, 6), holding a <code>gap lock</code> for the range [4, +∞) where no records exist, locking the gap [4, +∞) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>90.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td></tr><tr><td style=text-align:center>93.5</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>93.9</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (4)</td></tr><tr><td style=text-align:center>96.9</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>97.2</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td style=text-align:center>100.3</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>100.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td style=text-align:center>103.6</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>103.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>104.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td style=text-align:center>107.3</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>107.6</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td style=text-align:center>107.7</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>108.0</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td style=text-align:center>111.0</td><td>mysql> rollback</td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr></tbody></table><h6 id=select-for-update-range-5-7>SELECT FOR UPDATE RANGE [5, 7)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>111.3</td><td>=== Round 5: Testing SELECT_FOR_UPDATE_RANGE ID=5 ===</td><td>=== Round 6: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 5 AND id &lt; 7 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 1 rows (0.03s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>Database contains data with ID=1,4,5</li><li>Session1 performs <code>SELECT FOR UPDATE</code> on range [5, 7), holding a <code>gap lock</code> for the range [5, +∞) where no records exist, locking the gap [5, +∞) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>116.0</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td style=text-align:center>119.0</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>119.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td style=text-align:center>122.3</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>122.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>123.0</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td style=text-align:center>126.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>126.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>126.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td style=text-align:center>129.8</td><td>mysql> rollback</td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr></tbody></table><h6 id=select-for-update-range-6-8>SELECT FOR UPDATE RANGE [6, 8)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>130.1</td><td>=== Round 6: Testing SELECT_FOR_UPDATE_RANGE ID=6 ===</td><td>=== Round 7: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 6 AND id &lt; 8 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 0 rows (0.03s)</td><td></td></tr></tbody></table><ul><li>Database contains data with ID=1,4,5</li><li>Session1 performs <code>SELECT FOR UPDATE</code> on range [6, 8), holding a <code>gap lock</code> for the range [6, +∞) where no records exist, locking the gap [6, +∞) to prevent other transactions from inserting records within this range.</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>135.3</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td></tr><tr><td style=text-align:center>135.4</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>135.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td style=text-align:center>138.7</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.11s) (3.11s)</td></tr><tr><td style=text-align:center>139.1</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>139.5</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td style=text-align:center>142.5</td><td>mysql> rollback</td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td></td><td>SESSION 2 COMPLETE</td></tr><tr><td style=text-align:center>142.8</td><td>SESSION 1 COMPLETE</td><td></td></tr></tbody></table><h3 id=appendix>Appendix</h3><ul><li>Python script for data collection</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span><span class=lnt>433
</span><span class=lnt>434
</span><span class=lnt>435
</span><span class=lnt>436
</span><span class=lnt>437
</span><span class=lnt>438
</span><span class=lnt>439
</span><span class=lnt>440
</span><span class=lnt>441
</span><span class=lnt>442
</span><span class=lnt>443
</span><span class=lnt>444
</span><span class=lnt>445
</span><span class=lnt>446
</span><span class=lnt>447
</span><span class=lnt>448
</span><span class=lnt>449
</span><span class=lnt>450
</span><span class=lnt>451
</span><span class=lnt>452
</span><span class=lnt>453
</span><span class=lnt>454
</span><span class=lnt>455
</span><span class=lnt>456
</span><span class=lnt>457
</span><span class=lnt>458
</span><span class=lnt>459
</span><span class=lnt>460
</span><span class=lnt>461
</span><span class=lnt>462
</span><span class=lnt>463
</span><span class=lnt>464
</span><span class=lnt>465
</span><span class=lnt>466
</span><span class=lnt>467
</span><span class=lnt>468
</span><span class=lnt>469
</span><span class=lnt>470
</span><span class=lnt>471
</span><span class=lnt>472
</span><span class=lnt>473
</span><span class=lnt>474
</span><span class=lnt>475
</span><span class=lnt>476
</span><span class=lnt>477
</span><span class=lnt>478
</span><span class=lnt>479
</span><span class=lnt>480
</span><span class=lnt>481
</span><span class=lnt>482
</span><span class=lnt>483
</span><span class=lnt>484
</span><span class=lnt>485
</span><span class=lnt>486
</span><span class=lnt>487
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>MySQL Lock Testing - Timeline Analysis Version
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pymysql</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DB_CONFIG</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;host&#39;</span><span class=p>:</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;user&#39;</span><span class=p>:</span> <span class=s1>&#39;haotian&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;password&#39;</span><span class=p>:</span> <span class=s1>&#39;qwe123qwe123&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;database&#39;</span><span class=p>:</span> <span class=s1>&#39;toy&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;autocommit&#39;</span><span class=p>:</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Test Configuration - Modify as needed</span>
</span></span><span class=line><span class=cl><span class=n>TEST_CONFIG</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># Session1 Configuration</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;session1_operation&#39;</span><span class=p>:</span> <span class=s1>&#39;select_for_update_range&#39;</span><span class=p>,</span>  <span class=c1># &#39;insert&#39;, &#39;select_for_update&#39;, &#39;select_for_update_range&#39;</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;insert_start&#39;</span><span class=p>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span>     <span class=c1># Operation start ID</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;insert_end&#39;</span><span class=p>:</span> <span class=mi>7</span><span class=p>,</span>        <span class=c1># Operation end ID (exclusive)</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;range_size&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>        <span class=c1># Range size (for select_for_update_range only)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Session2 Test Configuration</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;test_ids&#39;</span><span class=p>:</span> <span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>],</span>  <span class=c1># ID list to test</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;lock_timeout&#39;</span><span class=p>:</span> <span class=mi>3</span>       <span class=c1># Lock wait timeout in seconds</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Global log collector</span>
</span></span><span class=line><span class=cl><span class=n>timeline_log</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>log_lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log_event</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>event_type</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Record event to timeline&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>log_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>timestamp</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>timeline_log</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;session&#39;</span><span class=p>:</span> <span class=n>session</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=n>event_type</span><span class=p>,</span>  <span class=c1># &#39;sql&#39;, &#39;info&#39;, &#39;error&#39;</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sql&#39;</span><span class=p>:</span> <span class=n>sql</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;result&#39;</span><span class=p>:</span> <span class=n>result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=n>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;duration&#39;</span><span class=p>:</span> <span class=n>duration</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Real-time progress display</span>
</span></span><span class=line><span class=cl>        <span class=n>time_str</span> <span class=o>=</span> <span class=n>timestamp</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%H:%M:%S.</span><span class=si>%f</span><span class=s2>&#34;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event_type</span> <span class=o>==</span> <span class=s1>&#39;sql&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>progress_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mysql&gt; </span><span class=si>{</span><span class=n>sql</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>duration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>progress_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>event_type</span> <span class=o>==</span> <span class=s1>&#39;error&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>progress_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;ERROR: </span><span class=si>{</span><span class=n>error</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>duration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>progress_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>progress_text</span> <span class=o>=</span> <span class=n>result</span> <span class=ow>or</span> <span class=n>sql</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>time_str</span><span class=si>}</span><span class=s2>] [</span><span class=si>{</span><span class=n>session</span><span class=si>}</span><span class=s2>] </span><span class=si>{</span><span class=n>progress_text</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>session1</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Session1: Loop operations (INSERT or SELECT FOR UPDATE)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=n>DB_CONFIG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>operation_type</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;session1_operation&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;SESSION 1 START - </span><span class=si>{</span><span class=n>operation_type</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Check table status</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM example_single_pk&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=s1>&#39;SELECT * FROM example_single_pk&#39;</span><span class=p>,</span> <span class=n>results</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Loop operations</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>target_id</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_start&#39;</span><span class=p>],</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_end&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;=== Round </span><span class=si>{</span><span class=n>target_id</span><span class=si>}</span><span class=s1>: Testing </span><span class=si>{</span><span class=n>operation_type</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s1> ID=</span><span class=si>{</span><span class=n>target_id</span><span class=si>}</span><span class=s1> ===&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Start transaction</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=s1>&#39;start transaction&#39;</span><span class=p>,</span> <span class=s1>&#39;Query OK, 0 rows affected&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;START TRANSACTION&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>operation_type</span> <span class=o>==</span> <span class=s1>&#39;insert&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># INSERT operation</span>
</span></span><span class=line><span class=cl>                    <span class=n>sql</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;INSERT INTO example_single_pk (id) VALUES (</span><span class=si>{</span><span class=n>target_id</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=s1>&#39;Query OK, 1 row affected&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>except</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>err</span><span class=o>.</span><span class=n>IntegrityError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span> <span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>operation_type</span> <span class=o>==</span> <span class=s1>&#39;select_for_update&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># SELECT FOR UPDATE operation</span>
</span></span><span class=line><span class=cl>                    <span class=n>sql</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SELECT * FROM example_single_pk WHERE id = </span><span class=si>{</span><span class=n>target_id</span><span class=si>}</span><span class=s2> FOR UPDATE&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>results</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;Query returned </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span><span class=si>}</span><span class=s1> rows (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                <span class=n>formatted_row</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=s1>&#39;strftime&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=nb>tuple</span><span class=p>(</span><span class=n>formatted_row</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span> <span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>operation_type</span> <span class=o>==</span> <span class=s1>&#39;select_for_update_range&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># SELECT FOR UPDATE range operation</span>
</span></span><span class=line><span class=cl>                    <span class=n>range_size</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;range_size&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=n>end_id</span> <span class=o>=</span> <span class=n>target_id</span> <span class=o>+</span> <span class=n>range_size</span>
</span></span><span class=line><span class=cl>                    <span class=n>sql</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SELECT * FROM example_single_pk WHERE id &gt;= </span><span class=si>{</span><span class=n>target_id</span><span class=si>}</span><span class=s2> AND id &lt; </span><span class=si>{</span><span class=n>end_id</span><span class=si>}</span><span class=s2> FOR UPDATE&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>results</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;Range query returned </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span><span class=si>}</span><span class=s1> rows (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                <span class=n>formatted_row</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=s1>&#39;strftime&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=nb>tuple</span><span class=p>(</span><span class=n>formatted_row</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span> <span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># Notify Session2 and wait</span>
</span></span><span class=line><span class=cl>                <span class=n>session2_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>session1_event</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>session1_event</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># ROLLBACK</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=s1>&#39;rollback&#39;</span><span class=p>,</span> <span class=s1>&#39;Query OK, 0 rows affected&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;ROLLBACK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;transaction&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;ROLLBACK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;main_loop&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;Session1 main loop error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;SESSION 1 COMPLETE&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>session2_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>  <span class=c1># Final notification</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>session2</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Session2: SELECT FOR UPDATE testing&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;SESSION 2 START - Waiting for Session1...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>round_num</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>total_rounds</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_end&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_start&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>round_num</span> <span class=o>&lt;</span> <span class=n>total_rounds</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session2_event</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>session2_event</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>round_num</span> <span class=o>&gt;=</span> <span class=n>total_rounds</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;=== Round </span><span class=si>{</span><span class=n>round_num</span><span class=si>}</span><span class=s1>: Testing SELECT &amp; INSERT ===&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Test all configured IDs, testing both SELECT FOR UPDATE and INSERT for each ID</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>test_id</span> <span class=ow>in</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;test_ids&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Test 1: SELECT FOR UPDATE</span>
</span></span><span class=line><span class=cl>            <span class=n>conn1</span> <span class=o>=</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=n>DB_CONFIG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor1</span> <span class=o>=</span> <span class=n>conn1</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor1</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SET innodb_lock_wait_timeout = </span><span class=si>{</span><span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;lock_timeout&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor1</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;START TRANSACTION&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># SELECT FOR UPDATE</span>
</span></span><span class=line><span class=cl>                <span class=n>sql</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SELECT * FROM example_single_pk WHERE id = </span><span class=si>{</span><span class=n>test_id</span><span class=si>}</span><span class=s2> FOR UPDATE&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>cursor1</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>results</span> <span class=o>=</span> <span class=n>cursor1</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;SELECT returned </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span><span class=si>}</span><span class=s1> rows (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>formatted_row</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=s1>&#39;strftime&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                                    <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                    <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=nb>tuple</span><span class=p>(</span><span class=n>formatted_row</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>err</span><span class=o>.</span><span class=n>OperationalError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=s2>&#34;Lock wait timeout&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;SELECT timeout (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;SELECT error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>cursor1</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;ROLLBACK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;connection&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;SELECT connection error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>conn1</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Test 2: INSERT</span>
</span></span><span class=line><span class=cl>            <span class=n>conn2</span> <span class=o>=</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=n>DB_CONFIG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor2</span> <span class=o>=</span> <span class=n>conn2</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor2</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SET innodb_lock_wait_timeout = </span><span class=si>{</span><span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;lock_timeout&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor2</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;START TRANSACTION&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># INSERT</span>
</span></span><span class=line><span class=cl>                <span class=n>sql</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;INSERT INTO example_single_pk (id) VALUES (</span><span class=si>{</span><span class=n>test_id</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>cursor2</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;INSERT success (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>err</span><span class=o>.</span><span class=n>OperationalError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=s2>&#34;Lock wait timeout&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;INSERT timeout (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;INSERT error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>err</span><span class=o>.</span><span class=n>IntegrityError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;INSERT duplicate (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>cursor2</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;ROLLBACK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;connection&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;INSERT connection error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>conn2</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>round_num</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>session1_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;SESSION 2 COMPLETE&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_round_analysis</span><span class=p>(</span><span class=n>round_num</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Print single round analysis&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>80</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Round </span><span class=si>{</span><span class=n>round_num</span><span class=si>}</span><span class=s2> Analysis&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>80</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Find events for this round</span>
</span></span><span class=line><span class=cl>    <span class=n>round_events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>timeline_log</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S1&#39;</span> <span class=ow>and</span> <span class=sa>f</span><span class=s1>&#39;Round </span><span class=si>{</span><span class=n>round_num</span><span class=si>}</span><span class=s1>:&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;result&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)))</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S2&#39;</span> <span class=ow>and</span> <span class=sa>f</span><span class=s1>&#39;Round </span><span class=si>{</span><span class=n>round_num</span><span class=si>}</span><span class=s1>:&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;result&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>))):</span>
</span></span><span class=line><span class=cl>            <span class=n>round_start_time</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Collect all events for this round</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>timeline_log</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>relative_time</span> <span class=o>=</span> <span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>round_start_time</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>relative_time</span> <span class=o>&lt;=</span> <span class=mi>20</span><span class=p>:</span>  <span class=c1># Assume max 20 seconds per round</span>
</span></span><span class=line><span class=cl>            <span class=n>round_events</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>relative_time</span><span class=p>,</span> <span class=n>event</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Display by time columns</span>
</span></span><span class=line><span class=cl>    <span class=n>operation_type</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;session1_operation&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>operation_type</span> <span class=o>==</span> <span class=s1>&#39;SELECT_FOR_UPDATE_RANGE&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>range_size</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;range_size&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>s1_header</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SESSION 1 (RANGE+</span><span class=si>{</span><span class=n>range_size</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>s1_header</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SESSION 1 (</span><span class=si>{</span><span class=n>operation_type</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;Time&#39;</span><span class=si>:</span><span class=s2>&gt;6</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>s1_header</span><span class=si>:</span><span class=s2>^35</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=s1>&#39;SESSION 2 (SELECT &amp; INSERT)&#39;</span><span class=si>:</span><span class=s2>^35</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>grouped</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>rel_time</span><span class=p>,</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>round_events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>time_bucket</span> <span class=o>=</span> <span class=nb>round</span><span class=p>(</span><span class=n>rel_time</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>grouped</span><span class=p>[</span><span class=n>time_bucket</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>time_bucket</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>grouped</span><span class=o>.</span><span class=n>keys</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=n>grouped</span><span class=p>[</span><span class=n>time_bucket</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>s1_events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span> <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S1&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>s2_events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span> <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S2&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>max_events</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>s1_events</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_events</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>s1_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>s2_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s1_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span> <span class=o>=</span> <span class=n>s1_events</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;sql&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s1_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mysql&gt; </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;duration&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;info&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s1_text</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>or</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span> <span class=o>=</span> <span class=n>s2_events</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;sql&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s2_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mysql&gt; </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;info&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=s1>&#39;Query returned&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                        <span class=n>s2_text</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=s1>&#39;(&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                        <span class=n>s2_text</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;error&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s2_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;ERROR: </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;error&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>time_str</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>time_bucket</span><span class=si>:</span><span class=s2>6.1f</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>s1_text</span> <span class=o>=</span> <span class=n>s1_text</span><span class=p>[:</span><span class=mi>33</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>s2_text</span> <span class=o>=</span> <span class=n>s2_text</span><span class=p>[:</span><span class=mi>33</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>time_str</span><span class=si>:</span><span class=s2>&gt;6</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>s1_text</span><span class=si>:</span><span class=s2>&lt;35</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>s2_text</span><span class=si>:</span><span class=s2>&lt;35</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_timeline_analysis</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Analyze and print timeline&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Print analysis for each round first</span>
</span></span><span class=line><span class=cl>    <span class=n>total_rounds</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_end&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_start&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>round_num</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>total_rounds</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>print_round_analysis</span><span class=p>(</span><span class=n>round_num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>150</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Complete Timeline Analysis&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>150</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>timeline_log</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;No events recorded&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Group by time, find simultaneous events</span>
</span></span><span class=line><span class=cl>    <span class=n>grouped_events</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>base_time</span> <span class=o>=</span> <span class=n>timeline_log</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>timeline_log</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Calculate relative time (seconds)</span>
</span></span><span class=line><span class=cl>        <span class=n>relative_time</span> <span class=o>=</span> <span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>base_time</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># Group by 0.1 second intervals</span>
</span></span><span class=line><span class=cl>        <span class=n>time_bucket</span> <span class=o>=</span> <span class=nb>round</span><span class=p>(</span><span class=n>relative_time</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>grouped_events</span><span class=p>[</span><span class=n>time_bucket</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Print column format</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;Time&#39;</span><span class=si>:</span><span class=s2>&gt;6</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=s1>&#39;SESSION 1 (LEFT)&#39;</span><span class=si>:</span><span class=s2>^70</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=s1>&#39;SESSION 2 (RIGHT)&#39;</span><span class=si>:</span><span class=s2>^70</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span> <span class=o>*</span> <span class=mi>150</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>time_bucket</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>grouped_events</span><span class=o>.</span><span class=n>keys</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=n>grouped_events</span><span class=p>[</span><span class=n>time_bucket</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>s1_events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span> <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S1&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>s2_events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span> <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S2&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>max_events</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>s1_events</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_events</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>s1_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>s2_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s1_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span> <span class=o>=</span> <span class=n>s1_events</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;sql&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s1_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mysql&gt; </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>],</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>],</span> <span class=s1>&#39;__iter__&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>])</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Empty set&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=c1># Display all data, format datetime</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                                <span class=n>formatted_row</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=s1>&#39;strftime&#39;</span><span class=p>):</span>  <span class=c1># datetime object</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=nb>tuple</span><span class=p>(</span><span class=n>formatted_row</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                            <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>])</span><span class=si>}</span><span class=s2> rows&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                        <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;error&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s1_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;ERROR: </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;error&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                        <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>  <span class=c1># info</span>
</span></span><span class=line><span class=cl>                    <span class=n>s1_text</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>or</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span> <span class=o>=</span> <span class=n>s2_events</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;sql&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s2_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mysql&gt; </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>],</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>],</span> <span class=s1>&#39;__iter__&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>])</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Empty set&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=c1># Display all data, format datetime</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                                <span class=n>formatted_row</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=s1>&#39;strftime&#39;</span><span class=p>):</span>  <span class=c1># datetime object</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=nb>tuple</span><span class=p>(</span><span class=n>formatted_row</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                            <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>])</span><span class=si>}</span><span class=s2> rows&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                        <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;error&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s2_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;ERROR: </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;error&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                        <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>  <span class=c1># info</span>
</span></span><span class=line><span class=cl>                    <span class=n>s2_text</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>or</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Handle multi-line text</span>
</span></span><span class=line><span class=cl>            <span class=n>s1_lines</span> <span class=o>=</span> <span class=n>s1_text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span> <span class=k>if</span> <span class=n>s1_text</span> <span class=k>else</span> <span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>s2_lines</span> <span class=o>=</span> <span class=n>s2_text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span> <span class=k>if</span> <span class=n>s2_text</span> <span class=k>else</span> <span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>max_lines</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>s1_lines</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_lines</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_lines</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>time_str</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>time_bucket</span><span class=si>:</span><span class=s2>6.1f</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>j</span> <span class=o>==</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>s1_line</span> <span class=o>=</span> <span class=n>s1_lines</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=k>if</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s1_lines</span><span class=p>)</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>s2_line</span> <span class=o>=</span> <span class=n>s2_lines</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=k>if</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_lines</span><span class=p>)</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># Increase display width, reduce truncation</span>
</span></span><span class=line><span class=cl>                <span class=n>s1_line</span> <span class=o>=</span> <span class=n>s1_line</span><span class=p>[:</span><span class=mi>80</span><span class=p>]</span> <span class=k>if</span> <span class=n>s1_line</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;mysql&gt;&#39;</span><span class=p>)</span> <span class=k>else</span> <span class=n>s1_line</span><span class=p>[:</span><span class=mi>70</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>s2_line</span> <span class=o>=</span> <span class=n>s2_line</span><span class=p>[:</span><span class=mi>80</span><span class=p>]</span> <span class=k>if</span> <span class=n>s2_line</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;mysql&gt;&#39;</span><span class=p>)</span> <span class=k>else</span> <span class=n>s2_line</span><span class=p>[:</span><span class=mi>70</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>time_str</span><span class=si>:</span><span class=s2>&gt;6</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>s1_line</span><span class=si>:</span><span class=s2>&lt;70</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>s2_line</span><span class=si>:</span><span class=s2>&lt;70</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>150</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Event objects</span>
</span></span><span class=line><span class=cl><span class=n>session1_event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>session2_event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>operation_type</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;session1_operation&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;MySQL Lock Test - Timeline Collection Mode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Session1: </span><span class=si>{</span><span class=n>operation_type</span><span class=si>}</span><span class=s2> operations&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Session2: SELECT FOR UPDATE &amp; INSERT tests&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Collecting all events with timestamps...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>t1</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>session1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t2</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>session2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>t2</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t1</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>t1</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>t2</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>print_timeline_analysis</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Analysis Complete!&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2025-12-06&nbsp;<a class=git-hash href=https://github.com/GOODDAYDAY/GOODDAYDAY.github.io/commit/af3d5c9bd409e602f90f3dec7c5441cd7924d96f target=_blank title="commit by haotian(865700600@qq.com) af3d5c9bd409e602f90f3dec7c5441cd7924d96f: Refactor Redis Cluster documentation for clarity and consistency">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>af3d5c9</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/en/2025/09/mysql-2.-mysql-lock/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://gooddayday.github.io/en/2025/09/mysql-2.-mysql-lock/ data-title="[MySQL] 2. Lock Mechanism Execution Analysis" data-hashtags=MySQL,Lock><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://gooddayday.github.io/en/2025/09/mysql-2.-mysql-lock/ data-hashtag=MySQL><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://gooddayday.github.io/en/2025/09/mysql-2.-mysql-lock/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://gooddayday.github.io/en/2025/09/mysql-2.-mysql-lock/ data-title="[MySQL] 2. Lock Mechanism Execution Analysis"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://gooddayday.github.io/en/2025/09/mysql-2.-mysql-lock/ data-title="[MySQL] 2. Lock Mechanism Execution Analysis"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://gooddayday.github.io/en/2025/09/mysql-2.-mysql-lock/ data-title="[MySQL] 2. Lock Mechanism Execution Analysis"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/en/tags/mysql/>MySQL</a>,&nbsp;<a href=/en/tags/lock/>Lock</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/en/>Home</a></span></section></div><div class=post-nav><a href=/en/2025/09/github-4.-value-checker/ class=prev rel=prev title="[Github] 4. Value-Checker-Java: Customizable AOP Validation Framework"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>[Github] 4. Value-Checker-Java: Customizable AOP Validation Framework</a>
<a href=/en/2025/09/mysql-3.-mysql-index/ class=next rel=next title="[MySQL] 3. MySQL Index">[MySQL] 3. MySQL Index<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><span class=author itemprop=copyrightHolder>&nbsp;<a href=/en/ target=_blank>GoodyHao</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><link rel=stylesheet href=/css/auto-numbering.css><link rel=stylesheet href=/css/svg-fullwidth.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOPtWtCc4CvteQ",darkTheme:"dark",emitMetadata:"0",inputPosition:"bottom",lang:"en",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"GOODDAYDAY/GOODDAYDAY.github.io",repoId:"R_kgDOPtWtCQ"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.en",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>