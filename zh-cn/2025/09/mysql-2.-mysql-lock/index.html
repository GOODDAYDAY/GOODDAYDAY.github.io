<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>[MySQL] 2. 锁机制执行分析 - GoodyHao's Blog</title><meta name=Description content="Elegance Never Fades"><meta property="og:url" content="https://gooddayday.github.io/zh-cn/2025/09/mysql-2.-mysql-lock/"><meta property="og:site_name" content="GoodyHao's Blog"><meta property="og:title" content="[MySQL] 2. 锁机制执行分析"><meta property="og:description" content="引言 在高并发环境下，数据库锁机制是确保数据一致性和完整性的关键手段。MySQL作为广泛使用的关系型数据库，提供了多种锁类型和机制来管理并发访问。然而，锁的使用不当可能导致性能瓶颈、死锁等问题，影响系统的稳定性和响应速度。 锁相关基本概念 锁的定义：锁是一种机制，用于控制对共享资源的访问，防止多个事务同时修改同一数据，确保数据的一致性和完整性。 锁的类型： 表级锁：锁定整个表。 共享锁（S锁）：允许多个事务同时读取数据，但不允许修改。 排他锁（X锁）：允许一个事务修改数据，其他事务既不能读取也不能修改。 意向锁（IS锁和IX锁）：用于表级别，表示事务打算在行级别上加锁。 自增锁（AUTO-INC锁）：用于处理自增列的并发插入，防止冲突。 间隙锁（Gap Lock）：锁定索引记录之间的间隙，防止幻读。 临键锁（Next-Key Lock）：结合了记录锁和间隙锁，锁定索引记录及其前面的间隙。 记录锁（Record Lock）：锁定具体的索引记录。 行级锁：锁定具体的行。 乐观锁：通过版本号或时间戳实现，适用于读多写少的场景。 悲观锁：通过显式加锁实现，适用于写多读少的场景。 死锁：多个事务互相等待对方释放锁，导致无法继续执行。 锁的兼容性：不同类型的锁之间存在兼容性规则，决定了哪些锁可以同时存在。 锁的粒度：锁定资源的范围，粒度越细，系统并发性越高，但管理开销也越大。 MySQL锁介绍 基本命令 创建测试表 1 2 3 4 5 6 7 8 9 -- auto-generated definition create table example_single_pk ( id bigint not null comment 'id' primary key, created timestamp default CURRENT_TIMESTAMP not null comment 'create time', updated timestamp default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'update time' ) comment 'example_single_pk' charset = utf8mb4; 执行命令 1 2 3 4 5 6 7 8 9 10 11 12 13 SELECT id, created, updated FROM example_single_pk; INSERT INTO example_single_pk (id) VALUES (1); SELECT id, created, updated FROM example_single_pk; UPDATE example_single_pk SET id = 6 WHERE id = 1; SELECT id, created, updated FROM example_single_pk; DELETE FROM example_single_pk WHERE id = 1 or id = 6; SELECT id, created, updated FROM example_single_pk; 结果 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 mysql> SELECT id, created, updated FROM example_single_pk; Empty set (0.00 sec) mysql> mysql> INSERT INTO example_single_pk (id) VALUES (1); Query OK, 1 row affected (0.00 sec) mysql> mysql> SELECT id, created, updated FROM example_single_pk; +----+---------------------+---------------------+ | id | created | updated | +----+---------------------+---------------------+ | 1 | 2025-09-27 11:14:40 | 2025-09-27 11:14:40 | +----+---------------------+---------------------+ 1 row in set (0.00 sec) mysql> mysql> UPDATE example_single_pk SET id = 6 WHERE id = 1; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql> mysql> SELECT id, created, updated FROM example_single_pk; +----+---------------------+---------------------+ | id | created | updated | +----+---------------------+---------------------+ | 6 | 2025-09-27 11:14:40 | 2025-09-27 11:14:40 | +----+---------------------+---------------------+ 1 row in set (0.00 sec) mysql> mysql> DELETE FROM example_single_pk WHERE id = 1 or id = 6; Query OK, 1 row affected (0.00 sec) mysql> mysql> SELECT id, created, updated FROM example_single_pk; Empty set (0.00 sec) 按粒度分 表级锁 - READ 加锁 1 2 mysql> LOCK TABLES example_single_pk READ; Query OK, 0 rows affected (0.00 sec)"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-27T19:02:17+08:00"><meta property="article:modified_time" content="2025-12-06T22:29:56+08:00"><meta property="article:tag" content="MySQL"><meta property="article:tag" content="Lock"><meta property="og:image" content="https://gooddayday.github.io/logo.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gooddayday.github.io/logo.jpg"><meta name=twitter:title content="[MySQL] 2. 锁机制执行分析"><meta name=twitter:description content="引言 在高并发环境下，数据库锁机制是确保数据一致性和完整性的关键手段。MySQL作为广泛使用的关系型数据库，提供了多种锁类型和机制来管理并发访问。然而，锁的使用不当可能导致性能瓶颈、死锁等问题，影响系统的稳定性和响应速度。 锁相关基本概念 锁的定义：锁是一种机制，用于控制对共享资源的访问，防止多个事务同时修改同一数据，确保数据的一致性和完整性。 锁的类型： 表级锁：锁定整个表。 共享锁（S锁）：允许多个事务同时读取数据，但不允许修改。 排他锁（X锁）：允许一个事务修改数据，其他事务既不能读取也不能修改。 意向锁（IS锁和IX锁）：用于表级别，表示事务打算在行级别上加锁。 自增锁（AUTO-INC锁）：用于处理自增列的并发插入，防止冲突。 间隙锁（Gap Lock）：锁定索引记录之间的间隙，防止幻读。 临键锁（Next-Key Lock）：结合了记录锁和间隙锁，锁定索引记录及其前面的间隙。 记录锁（Record Lock）：锁定具体的索引记录。 行级锁：锁定具体的行。 乐观锁：通过版本号或时间戳实现，适用于读多写少的场景。 悲观锁：通过显式加锁实现，适用于写多读少的场景。 死锁：多个事务互相等待对方释放锁，导致无法继续执行。 锁的兼容性：不同类型的锁之间存在兼容性规则，决定了哪些锁可以同时存在。 锁的粒度：锁定资源的范围，粒度越细，系统并发性越高，但管理开销也越大。 MySQL锁介绍 基本命令 创建测试表 1 2 3 4 5 6 7 8 9 -- auto-generated definition create table example_single_pk ( id bigint not null comment 'id' primary key, created timestamp default CURRENT_TIMESTAMP not null comment 'create time', updated timestamp default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'update time' ) comment 'example_single_pk' charset = utf8mb4; 执行命令 1 2 3 4 5 6 7 8 9 10 11 12 13 SELECT id, created, updated FROM example_single_pk; INSERT INTO example_single_pk (id) VALUES (1); SELECT id, created, updated FROM example_single_pk; UPDATE example_single_pk SET id = 6 WHERE id = 1; SELECT id, created, updated FROM example_single_pk; DELETE FROM example_single_pk WHERE id = 1 or id = 6; SELECT id, created, updated FROM example_single_pk; 结果 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 mysql> SELECT id, created, updated FROM example_single_pk; Empty set (0.00 sec) mysql> mysql> INSERT INTO example_single_pk (id) VALUES (1); Query OK, 1 row affected (0.00 sec) mysql> mysql> SELECT id, created, updated FROM example_single_pk; +----+---------------------+---------------------+ | id | created | updated | +----+---------------------+---------------------+ | 1 | 2025-09-27 11:14:40 | 2025-09-27 11:14:40 | +----+---------------------+---------------------+ 1 row in set (0.00 sec) mysql> mysql> UPDATE example_single_pk SET id = 6 WHERE id = 1; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql> mysql> SELECT id, created, updated FROM example_single_pk; +----+---------------------+---------------------+ | id | created | updated | +----+---------------------+---------------------+ | 6 | 2025-09-27 11:14:40 | 2025-09-27 11:14:40 | +----+---------------------+---------------------+ 1 row in set (0.00 sec) mysql> mysql> DELETE FROM example_single_pk WHERE id = 1 or id = 6; Query OK, 1 row affected (0.00 sec) mysql> mysql> SELECT id, created, updated FROM example_single_pk; Empty set (0.00 sec) 按粒度分 表级锁 - READ 加锁 1 2 mysql> LOCK TABLES example_single_pk READ; Query OK, 0 rows affected (0.00 sec)"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://gooddayday.github.io/zh-cn/2025/09/mysql-2.-mysql-lock/><link rel=prev href=https://gooddayday.github.io/zh-cn/2025/09/github-4.-value-checker/><link rel=next href=https://gooddayday.github.io/zh-cn/2025/09/mysql-3.-mysql-index/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[MySQL] 2. 锁机制执行分析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/gooddayday.github.io\/zh-cn\/2025\/09\/mysql-2.-mysql-lock\/"},"image":["https:\/\/gooddayday.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"MySQL, Lock","wordcount":10497,"url":"https:\/\/gooddayday.github.io\/zh-cn\/2025\/09\/mysql-2.-mysql-lock\/","datePublished":"2025-09-27T19:02:17+08:00","dateModified":"2025-12-06T22:29:56+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/gooddayday.github.io\/images\/logo.jpg"},"author":{"@type":"Person","name":"GoodyHao"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/zh-cn/ title="GoodyHao's Blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>Elegance Never Fades</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/zh-cn/posts/>所有文章 </a><a class=menu-item href=/zh-cn/tags/>标签 </a><a class=menu-item href=/zh-cn/categories/>分类 </a><a class=menu-item href=/zh-cn/categories/documentation/>文档 </a><a class=menu-item href=/zh-cn/about/>关于 </a><a class=menu-item href=https://github.com/GOODDAYDAY/GOODDAYDAY.github.io title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a class=menu-item href=/en/2025/09/mysql-2.-mysql-lock/ title=English>English</a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/zh-cn/ title="GoodyHao's Blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>Elegance Never Fades</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/zh-cn/posts/ title>所有文章</a><a class=menu-item href=/zh-cn/tags/ title>标签</a><a class=menu-item href=/zh-cn/categories/ title>分类</a><a class=menu-item href=/zh-cn/categories/documentation/ title>文档</a><a class=menu-item href=/zh-cn/about/ title>关于</a><a class=menu-item href=https://github.com/GOODDAYDAY/GOODDAYDAY.github.io title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a class=menu-item href=/en/2025/09/mysql-2.-mysql-lock/ title=English>English</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">[MySQL] 2. 锁机制执行分析</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/zh-cn/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>GoodyHao</a></span>&nbsp;<span class=post-category>收录于 <a href=/zh-cn/categories/mysql/><i class="far fa-folder fa-fw" aria-hidden=true></i>MySQL</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2025-09-27>2025-09-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 10497 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 21 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#引言>引言</a></li><li><a href=#锁相关基本概念>锁相关基本概念</a></li><li><a href=#mysql锁介绍>MySQL锁介绍</a><ul><li><a href=#基本命令>基本命令</a></li><li><a href=#按粒度分>按粒度分</a><ul><li><a href=#表级锁---read>表级锁 - READ</a><ul><li><a href=#加锁><strong>加锁</strong></a></li><li><a href=#解锁><strong>解锁</strong></a></li></ul></li><li><a href=#表级锁---write>表级锁 - WRITE</a><ul><li><a href=#加锁-1><strong>加锁</strong></a></li><li><a href=#解锁-1><strong>解锁</strong></a></li></ul></li><li><a href=#行级锁---select--for-share>行级锁 - SELECT &mldr; FOR SHARE</a><ul><li><a href=#加锁-2><strong>加锁</strong></a></li><li><a href=#解锁-2><strong>解锁</strong></a></li></ul></li><li><a href=#行级锁---select--for-update>行级锁 - SELECT &mldr; FOR UPDATE</a><ul><li><a href=#加锁-3><strong>加锁</strong></a></li><li><a href=#解锁-3><strong>解锁</strong></a></li></ul></li></ul></li><li><a href=#按属性分>按属性分</a><ul><li><a href=#共享锁--排他锁>共享锁 & 排他锁</a></li><li><a href=#自增锁-auto-inc-lock>自增锁 (AUTO-INC Lock)</a></li><li><a href=#意向锁-intention-lock>意向锁 (Intention Lock)</a><ul><li><a href=#层级定位服务器层的行锁信号员>层级定位：服务器层的“行锁信号员”</a></li><li><a href=#核心设计目标解决分层架构的信息差>核心设计目标：解决分层架构的“信息差”</a></li><li><a href=#与行锁表锁的联动机制>与行锁/表锁的联动机制</a></li><li><a href=#为什么意向锁轻量>为什么意向锁“轻量”？</a></li><li><a href=#价值总结用最小开销换最大正确性>价值总结：用最小开销换最大正确性</a></li></ul></li></ul></li><li><a href=#按算法分-innodb引擎>按算法分 (InnoDB引擎)</a><ul><li><a href=#实操说明>实操说明</a><ul><li><a href=#insert>INSERT</a><ul><li><a href=#insert-into--1>insert into -1</a></li><li><a href=#insert-into-0>insert into 0</a></li></ul></li><li><a href=#select-for-update>SELECT FOR UPDATE</a><ul><li><a href=#select-for-update--1>select for update -1</a></li><li><a href=#select-for-update-0>select for update 0</a></li><li><a href=#select-for-update-1>select for update 1</a></li><li><a href=#select-for-update-2>select for update 2</a></li><li><a href=#select-for-update-3>select for update 3</a></li><li><a href=#select-for-update-4>select for update 4</a></li><li><a href=#select-for-update-5>select for update 5</a></li><li><a href=#select-for-update-6>select for update 6</a></li></ul></li><li><a href=#select-for-update-range>SELECT FOR UPDATE RANGE</a><ul><li><a href=#select-for-update-range--1-1>SELECT FOR UPDATE RANGE [-1, 1)</a></li><li><a href=#select-for-update-range-0-2>SELECT FOR UPDATE RANGE [0, 2)</a></li><li><a href=#select-for-update-range-1-3>SELECT FOR UPDATE RANGE [1, 3)</a></li><li><a href=#select-for-update-range-2-4>SELECT FOR UPDATE RANGE [2, 4)</a></li><li><a href=#select-for-update-range-3-5>SELECT FOR UPDATE RANGE [3, 5)</a></li><li><a href=#select-for-update-range-4-6>SELECT FOR UPDATE RANGE [4, 6)</a></li><li><a href=#select-for-update-range-5-7>SELECT FOR UPDATE RANGE [5, 7)</a></li><li><a href=#select-for-update-range-6-8>SELECT FOR UPDATE RANGE [6, 8)</a></li></ul></li></ul></li></ul></li><li><a href=#附录>附录</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=引言>引言</h2><ul><li>在高并发环境下，数据库锁机制是确保数据一致性和完整性的关键手段。MySQL作为广泛使用的关系型数据库，提供了多种锁类型和机制来管理并发访问。然而，锁的使用不当可能导致性能瓶颈、死锁等问题，影响系统的稳定性和响应速度。</li></ul><h2 id=锁相关基本概念>锁相关基本概念</h2><ul><li><strong>锁的定义</strong>：锁是一种机制，用于控制对共享资源的访问，防止多个事务同时修改同一数据，确保数据的一致性和完整性。</li><li><strong>锁的类型</strong>：<ul><li><strong>表级锁</strong>：锁定整个表。</li><li><strong>共享锁（S锁）</strong>：允许多个事务同时读取数据，但不允许修改。</li><li><strong>排他锁（X锁）</strong>：允许一个事务修改数据，其他事务既不能读取也不能修改。</li><li><strong>意向锁（IS锁和IX锁）</strong>：用于表级别，表示事务打算在行级别上加锁。</li><li><strong>自增锁（AUTO-INC锁）</strong>：用于处理自增列的并发插入，防止冲突。</li><li><strong>间隙锁（Gap Lock）</strong>：锁定索引记录之间的间隙，防止幻读。</li><li><strong>临键锁（Next-Key Lock）</strong>：结合了记录锁和间隙锁，锁定索引记录及其前面的间隙。</li><li><strong>记录锁（Record Lock）</strong>：锁定具体的索引记录。</li><li><strong>行级锁</strong>：锁定具体的行。</li><li><strong>乐观锁</strong>：通过版本号或时间戳实现，适用于读多写少的场景。</li><li><strong>悲观锁</strong>：通过显式加锁实现，适用于写多读少的场景。</li></ul></li><li><strong>死锁</strong>：多个事务互相等待对方释放锁，导致无法继续执行。</li><li><strong>锁的兼容性</strong>：不同类型的锁之间存在兼容性规则，决定了哪些锁可以同时存在。</li><li><strong>锁的粒度</strong>：锁定资源的范围，粒度越细，系统并发性越高，但管理开销也越大。</li></ul><h2 id=mysql锁介绍>MySQL锁介绍</h2><h3 id=基本命令>基本命令</h3><ul><li>创建测试表</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- auto-generated definition
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>example_single_pk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w>      </span><span class=nb>bigint</span><span class=w>                              </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;id&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>created</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;create time&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>updated</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>update</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;update time&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>comment</span><span class=w> </span><span class=s1>&#39;example_single_pk&#39;</span><span class=w> </span><span class=n>charset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>utf8mb4</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>执行命令</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DELETE</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>结果</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Empty</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>created</span><span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>updated</span><span class=w>             </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>27</span><span class=w> </span><span class=mi>11</span><span class=p>:</span><span class=mi>14</span><span class=p>:</span><span class=mi>40</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>27</span><span class=w> </span><span class=mi>11</span><span class=p>:</span><span class=mi>14</span><span class=p>:</span><span class=mi>40</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Rows</span><span class=w> </span><span class=n>matched</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>  </span><span class=n>Changed</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>created</span><span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>updated</span><span class=w>             </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>6</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>27</span><span class=w> </span><span class=mi>11</span><span class=p>:</span><span class=mi>14</span><span class=p>:</span><span class=mi>40</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>27</span><span class=w> </span><span class=mi>11</span><span class=p>:</span><span class=mi>14</span><span class=p>:</span><span class=mi>40</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+---------------------+---------------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>created</span><span class=p>,</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Empty</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=按粒度分>按粒度分</h3><h4 id=表级锁---read>表级锁 - READ</h4><h5 id=加锁><strong>加锁</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=n>TABLES</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>READ</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/1.1%20lock%20tables%20read.png data-srcset="/images/12.%20mysql%20lock/1.1%20lock%20tables%20read.png, /images/12.%20mysql%20lock/1.1%20lock%20tables%20read.png 1.5x, /images/12.%20mysql%20lock/1.1%20lock%20tables%20read.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/1.1%20lock%20tables%20read.png title="1. lock tables read.png"></p><ul><li>此时，其他会话可以读取数据，但不能进行写操作。</li></ul><h5 id=解锁><strong>解锁</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=n>UNLOCK</span><span class=w> </span><span class=n>tables</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/1.2%20unlock%20tables%20read.png data-srcset="/images/12.%20mysql%20lock/1.2%20unlock%20tables%20read.png, /images/12.%20mysql%20lock/1.2%20unlock%20tables%20read.png 1.5x, /images/12.%20mysql%20lock/1.2%20unlock%20tables%20read.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/1.2%20unlock%20tables%20read.png title="1.2 unlock tables read.png"></p><ul><li>可以看出此时，其他会话可以正常读取但<code>不能</code>写入数据。</li></ul><h4 id=表级锁---write>表级锁 - WRITE</h4><h5 id=加锁-1><strong>加锁</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=n>TABLES</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>WRITE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/2.1%20lock%20tables%20write.png data-srcset="/images/12.%20mysql%20lock/2.1%20lock%20tables%20write.png, /images/12.%20mysql%20lock/2.1%20lock%20tables%20write.png 1.5x, /images/12.%20mysql%20lock/2.1%20lock%20tables%20write.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/2.1%20lock%20tables%20write.png title="2.1 lock tables write.png"></p><h5 id=解锁-1><strong>解锁</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=n>UNLOCK</span><span class=w> </span><span class=n>tables</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/2.2%20unlock%20tables%20write.png data-srcset="/images/12.%20mysql%20lock/2.2%20unlock%20tables%20write.png, /images/12.%20mysql%20lock/2.2%20unlock%20tables%20write.png 1.5x, /images/12.%20mysql%20lock/2.2%20unlock%20tables%20write.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/2.2%20unlock%20tables%20write.png title="2.2 unlock tables write.png"></p><ul><li>可以看出此时，其他会话既不能读取<code>也</code>不能写入数据。</li><li>总体来看，表级别锁的粒度较大，适用于对整个表进行批量操作的场景，但会影响并发性能。</li><li>不推荐使用。</li></ul><h4 id=行级锁---select--for-share>行级锁 - SELECT &mldr; FOR SHARE</h4><h5 id=加锁-2><strong>加锁</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>SHARE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Empty</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/3.1%20select%20for%20share.png data-srcset="/images/12.%20mysql%20lock/3.1%20select%20for%20share.png, /images/12.%20mysql%20lock/3.1%20select%20for%20share.png 1.5x, /images/12.%20mysql%20lock/3.1%20select%20for%20share.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/3.1%20select%20for%20share.png title="3.1 select for share.png"></p><ul><li>此时影响的是另外会话内的锁。</li><li>其他会话可以读取数据，但不能进行写操作，不在赘述并截图。</li></ul><h5 id=解锁-2><strong>解锁</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/3.2%20select%20for%20share%20commit.png data-srcset="/images/12.%20mysql%20lock/3.2%20select%20for%20share%20commit.png, /images/12.%20mysql%20lock/3.2%20select%20for%20share%20commit.png 1.5x, /images/12.%20mysql%20lock/3.2%20select%20for%20share%20commit.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/3.2%20select%20for%20share%20commit.png title="3.2 select for share commit.png"></p><ul><li>解锁后可以正常加读锁和写锁。</li></ul><h4 id=行级锁---select--for-update>行级锁 - SELECT &mldr; FOR UPDATE</h4><h5 id=加锁-3><strong>加锁</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>start</span><span class=w> </span><span class=k>transaction</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>example_single_pk</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>UPDATE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Empty</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/4.1%20select%20for%20update.png data-srcset="/images/12.%20mysql%20lock/4.1%20select%20for%20update.png, /images/12.%20mysql%20lock/4.1%20select%20for%20update.png 1.5x, /images/12.%20mysql%20lock/4.1%20select%20for%20update.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/4.1%20select%20for%20update.png title="4.1 select for update.png"></p><ul><li>其实此时从查询数据的角度，与 <code>FOR SHARE</code>没有区别，影响的是另外会话内的锁。</li><li><code>FOR UPDATE</code>会锁定所选行，其他事务不能读取或修改这些行。</li></ul><h5 id=解锁-3><strong>解锁</strong></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=n>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/4.2%20select%20for%20update%20commit.png data-srcset="/images/12.%20mysql%20lock/4.2%20select%20for%20update%20commit.png, /images/12.%20mysql%20lock/4.2%20select%20for%20update%20commit.png 1.5x, /images/12.%20mysql%20lock/4.2%20select%20for%20update%20commit.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/4.2%20select%20for%20update%20commit.png title="4.2 select for update commit.png"></p><ul><li>解锁后可以正常加读锁和写锁。</li></ul><h3 id=按属性分>按属性分</h3><h4 id=共享锁--排他锁>共享锁 & 排他锁</h4><table><thead><tr><th>序号</th><th>锁名称</th><th>触发方式</th><th>锁类型</th><th>作用域</th><th>核心特点</th></tr></thead><tbody><tr><td>1</td><td>表级共享锁（S锁）</td><td>LOCK TABLES tbl_name READ</td><td>服务器层锁</td><td>整表</td><td>允许其他会话读，阻止写；需手动UNLOCK TABLES解锁。</td></tr><tr><td>2</td><td>表级排他锁（X锁）</td><td>LOCK TABLES tbl_name WRITE</td><td>服务器层锁</td><td>整表</td><td>阻止其他会话读写；需手动UNLOCK TABLES解锁。</td></tr><tr><td>3</td><td>行级共享锁（S锁）</td><td>SELECT &mldr; FOR SHARE（事务内）</td><td>InnoDB行锁</td><td>单行</td><td>允许其他会话读该行，阻止写；事务提交/回滚后自动解锁。</td></tr><tr><td>4</td><td>行级排他锁（X锁）</td><td>SELECT &mldr; FOR UPDATE（事务内）</td><td>InnoDB行锁</td><td>单行</td><td>阻止其他会话读写该行；事务提交/回滚后自动解锁。</td></tr></tbody></table><h4 id=自增锁-auto-inc-lock>自增锁 (AUTO-INC Lock)</h4><ul><li>触发方式：<code>INSERT</code>语句操作AUTO_INCREMENT列时自动触发</li><li>特点：AUTO-INC锁，保证自增值的连续性和唯一性。与行锁不同，但是行为结果接近。</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/5.1%20auto%20inc%20double%20insert%20success.png data-srcset="/images/12.%20mysql%20lock/5.1%20auto%20inc%20double%20insert%20success.png, /images/12.%20mysql%20lock/5.1%20auto%20inc%20double%20insert%20success.png 1.5x, /images/12.%20mysql%20lock/5.1%20auto%20inc%20double%20insert%20success.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/5.1%20auto%20inc%20double%20insert%20success.png title="5.1 auto inc double insert success.png"></p><ul><li>可以看到，此时自增锁之间没有冲突，两个会话都成功插入数据。</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/5.2%20auto%20inc%20double%20insert%20same%20id.png data-srcset="/images/12.%20mysql%20lock/5.2%20auto%20inc%20double%20insert%20same%20id.png, /images/12.%20mysql%20lock/5.2%20auto%20inc%20double%20insert%20same%20id.png 1.5x, /images/12.%20mysql%20lock/5.2%20auto%20inc%20double%20insert%20same%20id.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/5.2%20auto%20inc%20double%20insert%20same%20id.png title="5.2 auto inc double insert same id.png"></p><ul><li>而很明显，当确定了id之后，则与行锁行为接近，第二个会话插入失败。</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/12.%20mysql%20lock/5.3%20auto%20inc%20double%20insert%20same%20id%20fail.png data-srcset="/images/12.%20mysql%20lock/5.3%20auto%20inc%20double%20insert%20same%20id%20fail.png, /images/12.%20mysql%20lock/5.3%20auto%20inc%20double%20insert%20same%20id%20fail.png 1.5x, /images/12.%20mysql%20lock/5.3%20auto%20inc%20double%20insert%20same%20id%20fail.png 2x" data-sizes=auto alt=/images/12.%20mysql%20lock/5.3%20auto%20inc%20double%20insert%20same%20id%20fail.png title="5.3 auto inc double insert same id fail.png"></p><ul><li>提交之后，可以看到数据插入失败，因为id冲突。</li></ul><h4 id=意向锁-intention-lock>意向锁 (Intention Lock)</h4><ul><li><p>意向锁是 InnoDB 存储引擎为协调「服务器层（MySQL 主进程）表锁」与「存储引擎层行锁」的冲突，设计的服务器级表级锁。它的核心是传递“存储引擎中有行锁存在”的信号，让服务器层能快速判断表锁与行锁的兼容性，避免高成本冲突检测。以下从层级定位、设计目标、联动机制、轻量原因展开说明：</p></li><li><p>意向锁是服务器层的“行锁信号灯”——用表级锁的极小开销，传递存储引擎的行锁状态，让两层锁机制高效协同，既正确又高性能。</p></li></ul><h5 id=层级定位服务器层的行锁信号员>层级定位：服务器层的“行锁信号员”</h5><p>• 服务器层：MySQL 主进程负责管理服务器级锁（如 LOCK TABLES），这是独立于存储引擎的原生锁机制。</p><p>• 存储引擎层：InnoDB 负责管理行级锁（如 SELECT &mldr; FOR UPDATE 的 X 锁），控制具体数据行的访问。</p><p>• 意向锁的角色：意向锁属于服务器层的表级锁，但它不直接控制数据行——而是作为“翻译官”，将存储引擎中的行锁状态（“有事务在操作某行”）转化为服务器层能理解的“信号”（表级的 IS/IX 锁）。</p><h5 id=核心设计目标解决分层架构的信息差>核心设计目标：解决分层架构的“信息差”</h5><p><strong>MySQL 的分层架构（服务器层 vs 存储引擎层）导致锁状态天然隔离：</strong></p><p>• 服务器层想加表锁时，无法直接感知存储引擎里是否有行锁（比如事务 A 已锁定某行）；</p><p>• 存储引擎的行锁，也不关心服务器层是否有表锁。</p><p>若没有意向锁，服务器层加表锁时，必须遍历存储引擎的所有行（O(n) 时间复杂度），检查是否有行锁冲突——这对大表来说是灾难性的性能损耗。</p><p><strong>意向锁的出现，将这种“遍历检查”优化为O(1) 的信号判断：</strong></p><p>• 存储引擎加行锁时，自动向服务器层注册对应的意向锁（IS=行读意图，IX=行写意图）；</p><p>• 服务器层加表锁时，只需检查表级的意向锁状态，就能立刻判断是否冲突。</p><h5 id=与行锁表锁的联动机制>与行锁/表锁的联动机制</h5><p><strong>意向锁的生命周期完全依附于行锁，是行锁的“影子”：</strong></p><p>• 行锁触发意向锁：当事务对某行加行锁（S/X）时，InnoDB 引擎会自动通知服务器层，在表级加对应的意向锁（IS 或 IX）。</p><p>• 例：SELECT * FROM t WHERE id=1 FOR UPDATE（加行 X 锁）→ 服务器层加表级 IX 锁（意向排他锁）。</p><p>• 表锁检查意向锁：当事务尝试加服务器层表锁时，服务器层会检查表级的意向锁：</p><p>• 若表级有 IX 锁（意向排他锁），说明存储引擎中有行锁在活动，表锁（如 LOCK TABLES &mldr; WRITE）会被阻塞；</p><p>• 若表级有 IS 锁（意向共享锁），说明存储引擎中有行读锁，表读锁（LOCK TABLES &mldr; READ）可兼容，表写锁仍被阻塞。</p><h5 id=为什么意向锁轻量>为什么意向锁“轻量”？</h5><p><strong>意向锁的“轻量”源于其极小的状态空间和自动同步机制：</strong></p><p>• 锁范围有限：仅锁定“整张表”的概念（表级），不涉及具体数据行，无需维护每行的锁状态（如行锁的 heap_no 或 trx_id）。</p><p>• 状态极简：仅需记录两种“意图”——IS（有事务要读行）、IX（有事务要写行），逻辑复杂度远低于行锁。</p><p>• 自动同步：由 InnoDB 引擎在加/解锁行锁时自动触发，无需手动管理，无额外的人工或系统开销。</p><h5 id=价值总结用最小开销换最大正确性>价值总结：用最小开销换最大正确性</h5><p><strong>意向锁的本质是用表级锁的“轻量状态”，连接服务器层与存储引擎层的锁机制：</strong></p><p>• 对服务器层：快速判断表锁是否与行锁冲突，避免遍历所有行的高成本；</p><p>• 对存储引擎：无需关心服务器层的表锁，专注管理行锁；</p><p>• 对整体并发：既保证了数据一致性（避免表锁与行锁冲突），又维持了高并发性能。</p><h3 id=按算法分-innodb引擎>按算法分 (InnoDB引擎)</h3><p><strong>1 记录锁 (Record Lock)</strong></p><p><strong>2 间隙锁 (Gap Lock)</strong></p><p><strong>3 临键锁 (Next-key Lock)</strong></p><h4 id=实操说明>实操说明</h4><table><thead><tr><th>操作类型</th><th>常见场景</th><th>锁类型</th><th>锁范围</th><th>隔离级别依赖</th><th>主要冲突对象</th><th>备注</th></tr></thead><tbody><tr><td>SELECT</td><td>普通查询（无 FOR UPDATE/SHARE）</td><td>无锁</td><td>无</td><td>无</td><td>无</td><td>读不加锁（快照读）</td></tr><tr><td>SELECT FOR UPDATE</td><td>等值查询（记录存在）</td><td>记录锁（LOCK_REC_NOT_GAP）</td><td>具体记录（如 id=3）</td><td>RR/RC</td><td>同记录的记录锁、临键锁</td><td>锁住目标行，阻止修改/删除</td></tr><tr><td>SELECT FOR UPDATE</td><td>等值查询（记录不存在，RR）</td><td>间隙锁（LOCK_GAP）</td><td>相邻记录的间隙（如 (1,5)）</td><td>RR</td><td>同间隙的间隙锁、插入意向锁</td><td>防其他事务插入缺失的记录（幻读）</td></tr><tr><td>SELECT FOR UPDATE</td><td>等值查询（记录不存在，RC）</td><td>无锁</td><td>无</td><td>RC</td><td>无</td><td>RC 无间隙锁，仅读不加锁</td></tr><tr><td>SELECT FOR UPDATE</td><td>范围查询（如 id>2，RR）</td><td>临键锁（LOCK_NEXT_KEY）</td><td>记录+前驱间隙（如 (3,3]、(3,5]）</td><td>RR</td><td>同记录的记录锁、间隙锁</td><td>锁住范围所有记录及间隙（防幻读）</td></tr><tr><td>SELECT FOR UPDATE</td><td>范围查询（如 id>2，RC）</td><td>记录锁</td><td>符合条件的记录（如 id=3,5）</td><td>RC</td><td>同记录的记录锁</td><td>RC 无间隙锁，仅锁存在的记录</td></tr><tr><td>INSERT</td><td>插入新记录（任意场景）</td><td>插入意向锁（LOCK_INSERT_INTENTION）</td><td>相邻记录的间隙（如 (1,5)）</td><td>无（始终加）</td><td>同间隙的普通间隙锁、记录锁</td><td>协调插入互斥，与普通锁冲突</td></tr><tr><td>DELETE</td><td>等值删除（记录存在）</td><td>记录锁（LOCK_REC_NOT_GAP）</td><td>具体记录（如 id=3）</td><td>RR/RC</td><td>同记录的记录锁、临键锁</td><td>锁住目标行，阻止修改/插入</td></tr><tr><td>DELETE</td><td>范围删除（如 id>2，RR）</td><td>临键锁（LOCK_NEXT_KEY）</td><td>记录+前驱间隙（如 (3,3]、(3,5]）</td><td>RR</td><td>同记录的记录锁、间隙锁</td><td>锁住范围所有记录及间隙（防幻读）</td></tr><tr><td>DELETE</td><td>范围删除（如 id>2，RC）</td><td>记录锁</td><td>符合条件的记录（如 id=3,5）</td><td>RC</td><td>同记录的记录锁</td><td>RC 无间隙锁，仅锁存在的记录</td></tr><tr><td>UPDATE</td><td>等值更新（记录存在）</td><td>记录锁（LOCK_REC_NOT_GAP）</td><td>具体记录（如 id=3）</td><td>RR/RC</td><td>同记录的记录锁、临键锁</td><td>锁住目标行，阻止修改/插入</td></tr><tr><td>UPDATE</td><td>范围更新（如 id>2，RR）</td><td>临键锁（LOCK_NEXT_KEY）</td><td>记录+前驱间隙（如 (3,3]、(3,5]）</td><td>RR</td><td>同记录的记录锁、间隙锁</td><td>锁住范围所有记录及间隙（防幻读）</td></tr><tr><td>UPDATE</td><td>范围更新（如 id>2，RC）</td><td>记录锁</td><td>符合条件的记录（如 id=3,5）</td><td>RC</td><td>同记录的记录锁</td><td>RC 无间隙锁，仅锁存在的记录</td></tr></tbody></table><h5 id=insert>INSERT</h5><ul><li>插入使用的是<code>插入意向锁</code></li></ul><h6 id=insert-into--1>insert into -1</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>0.0</td><td></td><td>SESSION 2 START - Waiting for Session1&mldr;</td></tr><tr><td style=text-align:center>0.3</td><td>SESSION 1 START - INSERT</td><td>=== Round 0: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk</td><td></td></tr><tr><td style=text-align:center>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>3 rows (0.03s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>=== Round -1: Testing INSERT ID=-1 ===</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 1 row affected (0.03s)</td><td></td></tr></tbody></table><ul><li>Session 1 插入 ID=-1 的记录，并保持事务未提交，持有<code>插入意向锁</code>。</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>0.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td style=text-align:center>3.7</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>4.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td style=text-align:center>7.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><ul><li>Session 2 查询 ID=-1 的记录，发现记录存在，但被 Session 1 持有<code>插入意向锁</code>，导致查询阻塞等待锁释放，最终超时失败。</li><li>Session 2 尝试插入 ID=-1 的记录，同样因为冲突而超时失败。</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>7.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td style=text-align:center>7.5</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>7.7</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.02s)</td></tr><tr><td style=text-align:center>8.0</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 1 FOR UPDATE</td></tr><tr><td style=text-align:center>8.1</td><td></td><td>SELECT returned 1 rows (0.03s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>8.4</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (1)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr><tr><td style=text-align:center>8.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>9.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>9.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>9.7</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>10.1</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 1 rows (0.03s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>10.4</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (4)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr><tr><td style=text-align:center>10.8</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 1 rows (0.02s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>11.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr><tr><td style=text-align:center>11.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>11.9</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.06s)</td></tr><tr><td style=text-align:center>12.3</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.04s)</td></tr><tr><td style=text-align:center>12.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>12.7</td><td>mysql> rollback</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr></tbody></table><ul><li>后续无问题</li></ul><h6 id=insert-into-0>insert into 0</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>12.9</td><td>=== Round 0: Testing INSERT ID=0 ===</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>13.0</td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td><td>=== Round 1: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>Query OK, 1 row affected (0.02s)</td><td></td></tr></tbody></table><ul><li>Session 1 插入 ID=0 的记录，并保持事务未提交，持有<code>插入意向锁</code>。</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>13.2</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td style=text-align:center>13.3</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>13.5</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td style=text-align:center>13.6</td><td></td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>13.8</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td style=text-align:center>16.9</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>17.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td style=text-align:center>20.2</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.04s) (3.04s)</td></tr></tbody></table><ul><li>Session 2 查询 ID=0 的记录，发现记录存在，但被 Session 1 持有<code>插入意向锁</code>，导致查询阻塞等待锁释放，最终超时失败。</li><li>Session 2 尝试插入 ID=0 的记录，同样因为冲突而超时失败。</li><li>后续皆如此，不再做赘述。</li></ul><h5 id=select-for-update>SELECT FOR UPDATE</h5><h6 id=select-for-update--1>select for update -1</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>0.0</td><td></td><td>SESSION 2 START - Waiting for Session1&mldr;</td></tr><tr><td>0.3</td><td>SESSION 1 START - SELECT_FOR_UPDATE</td><td></td></tr><tr><td>~</td><td>mysql> SELECT * FROM example_single_pk</td><td></td></tr><tr><td>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td>~</td><td>3 rows (0.03s)</td><td></td></tr><tr><td>~</td><td>=== Round -1: Testing SELECT_FOR_UPDATE ID=-1 ===</td><td></td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>0.4</td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td><td>=== Round 0: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>Query returned 0 rows (0.03s)</td><td></td></tr></tbody></table><ul><li>数据库内数据为 ID=1,4,5</li><li>Session1 ID=-1 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> [-∞, 1) 范围内没有记录，锁定间隙 [-∞, 1)，防止其他事务插入该范围内的记录。</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>0.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td>0.8</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>1.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td>4.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>4.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>4.7</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td>7.7</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-0>select for update 0</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>12.9</td><td>=== Round 0: Testing SELECT_FOR_UPDATE ID=0 ===</td><td>=== Round 1: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td><td></td></tr><tr><td>~</td><td>Query returned 0 rows (0.03s)</td><td></td></tr></tbody></table><ul><li>Session1 ID=0 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> [-∞, 1) 范围内没有记录，锁定间隙 [-∞, 1)，防止其他事务插入该范围内的记录。</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>13.2</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>13.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td>16.6</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>16.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>17.2</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td>20.2</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-1>select for update 1</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>25.3</td><td>=== Round 1: Testing SELECT_FOR_UPDATE ID=1 ===</td><td></td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>25.4</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 1 FOR UPDATE</td><td>=== Round 2: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>Query returned 1 rows (0.02s)</td><td></td></tr><tr><td>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>Session1 ID=1 进行 <code>SELECT FOR UPDATE</code>，持有<code>记录锁</code> ID=1，防止其他事务修改或删除该记录。</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>27.3</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 1 FOR UPDATE</td></tr><tr><td>30.4</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.05s) (3.05s)</td></tr><tr><td>30.7</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (1)</td></tr><tr><td>33.7</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-2>select for update 2</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>38.5</td><td>=== Round 2: Testing SELECT_FOR_UPDATE ID=2 ===</td><td></td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>38.6</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td><td>=== Round 3: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>Query returned 0 rows (0.05s)</td><td></td></tr></tbody></table><ul><li>Session1 ID=2 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> (1,4) 范围内没有记录，锁定间隙 (1,4)，防止其他事务插入该范围内的记录。</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>41.0</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td>41.1</td><td></td><td>SELECT returned 0 rows (0.04s)</td></tr><tr><td>41.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td>44.4</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td>44.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>45.0</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td>48.0</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-3>select for update 3</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>51.2</td><td>=== Round 3: Testing SELECT_FOR_UPDATE ID=3 ===</td><td>=== Round 4: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td><td></td></tr><tr><td>~</td><td>Query returned 0 rows (0.03s)</td><td></td></tr></tbody></table><ul><li>Session1 ID=3 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> (1,4) 范围内没有记录，锁定间隙 (1,4)，防止其他事务插入该范围内的记录。</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>53.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>53.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td>56.9</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>57.2</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>57.5</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td>60.5</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-4>select for update 4</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>63.6</td><td>=== Round 4: Testing SELECT_FOR_UPDATE ID=4 ===</td><td>=== Round 5: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td><td></td></tr><tr><td>~</td><td>Query returned 1 rows (0.03s)</td><td></td></tr><tr><td>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>Session1 ID=4 进行 <code>SELECT FOR UPDATE</code>，持有<code>记录锁</code> ID=4，防止其他事务修改或删除该记录。</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>67.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td></tr><tr><td>70.4</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>70.7</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (4)</td></tr><tr><td>73.8</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-5>select for update 5</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>76.2</td><td>=== Round 5: Testing SELECT_FOR_UPDATE ID=5 ===</td><td></td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>76.3</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td><td>=== Round 6: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>Query returned 1 rows (0.02s)</td><td></td></tr><tr><td>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>Session1 ID=5 进行 <code>SELECT FOR UPDATE</code>，持有<code>记录锁</code> ID=5，防止其他事务修改或删除该记录。</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>80.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td>84.0</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>84.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td>87.3</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-6>select for update 6</h6><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>89.0</td><td>=== Round 6: Testing SELECT_FOR_UPDATE ID=6 ===</td><td>=== Round 7: Testing SELECT & INSERT ===</td></tr><tr><td>~</td><td>mysql> start transaction</td><td></td></tr><tr><td>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td><td></td></tr><tr><td>~</td><td>Query returned 0 rows (0.04s)</td><td></td></tr></tbody></table><ul><li>Session1 ID=6 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> [6, ∞) 范围内没有记录，锁定间隙 [6, ∞)，防止其他事务插入该范围内的记录。</li></ul><table><thead><tr><th>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td>94.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td>97.7</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td>97.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td>98.0</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td>98.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td>101.4</td><td>mysql> rollback</td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h5 id=select-for-update-range>SELECT FOR UPDATE RANGE</h5><h6 id=select-for-update-range--1-1>SELECT FOR UPDATE RANGE [-1, 1)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>0.0</td><td></td><td>SESSION 2 START - Waiting for Session1&mldr;</td></tr><tr><td style=text-align:center>0.2</td><td>SESSION 1 START - SELECT_FOR_UPDATE_RANGE</td><td></td></tr><tr><td style=text-align:center>0.3</td><td>mysql> SELECT * FROM example_single_pk</td><td>=== Round 0: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>3 rows (0.03s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>=== Round -1: Testing SELECT_FOR_UPDATE_RANGE ID=-1 ===</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= -1 AND id &lt; 1 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 0 rows (0.03s)</td><td></td></tr></tbody></table><ul><li>数据库内数据为 ID=1,4,5</li><li>Session1 对范围 [-1, 1) 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> [-∞, 1) 范围内没有记录，锁定间隙 [-∞, 1)，防止其他事务插入该范围内的记录。</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>0.6</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td style=text-align:center>0.7</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>1.0</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td style=text-align:center>4.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>4.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>4.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td style=text-align:center>7.8</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><ul><li><code>间隙锁</code> [-∞, 1) 范围内没有记录，锁定间隙 [-∞, 1)，防止其他事务插入该范围内的记录。</li><li>Session2 对ID=-1和ID=0的查询操作，未阻塞，因为共同持有了<code>间隙锁</code>。</li><li>Session2 对ID=-1和ID=0的插入操作被阻塞。</li></ul><h6 id=select-for-update-range-0-2>SELECT FOR UPDATE RANGE [0, 2)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>12.9</td><td>=== Round 0: Testing SELECT_FOR_UPDATE_RANGE ID=0 ===</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>13.0</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 0 AND id &lt; 2 FOR UPDATE</td><td>=== Round 1: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>Range query returned 1 rows (0.02s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>数据库内数据为 ID=1,4,5</li><li>Session1 对范围 [0, 2) 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> [-∞, 3) 范围内没有记录，锁定间隙 [-∞, 3)，防止其他事务插入该范围内的记录。</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>13.3</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = -1 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>13.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (-1)</td></tr><tr><td style=text-align:center>16.6</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>16.8</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 0 FOR UPDATE</td></tr><tr><td style=text-align:center>16.9</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>17.2</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (0)</td></tr><tr><td style=text-align:center>20.2</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>20.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 1 FOR UPDATE</td></tr><tr><td style=text-align:center>23.5</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>23.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (1)</td></tr><tr><td style=text-align:center>26.9</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>27.1</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td style=text-align:center>27.2</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>27.5</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td style=text-align:center>30.5</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>30.8</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>31.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td style=text-align:center>34.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>34.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 1 rows (0.03s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>34.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (4)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr><tr><td style=text-align:center>35.1</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td style=text-align:center>35.2</td><td></td><td>SELECT returned 1 rows (0.03s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>35.4</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr><tr><td style=text-align:center>35.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td></tr><tr><td style=text-align:center>35.8</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>36.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td style=text-align:center>~</td><td></td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>36.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>36.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td style=text-align:center>36.9</td><td>mysql> rollback</td><td>INSERT success (0.03s)</td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr></tbody></table><h6 id=select-for-update-range-1-3>SELECT FOR UPDATE RANGE [1, 3)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>37.2</td><td>=== Round 1: Testing SELECT_FOR_UPDATE_RANGE ID=1 ===</td><td>=== Round 2: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 1 AND id &lt; 3 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 1 rows (0.02s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(1, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>数据库内数据为 ID=1,4,5</li><li>Session1 对范围 [1, 3) 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> [1, 3) 范围内没有记录，锁定间隙 [1, 3)，防止其他事务插入该范围内的记录。</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>39.0</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 1 FOR UPDATE</td></tr><tr><td style=text-align:center>42.0</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>42.4</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (1)</td></tr><tr><td style=text-align:center>45.4</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>45.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td style=text-align:center>45.8</td><td></td><td>SELECT returned 0 rows (0.04s)</td></tr><tr><td style=text-align:center>46.1</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td style=text-align:center>49.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>49.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>49.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td style=text-align:center>52.9</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-range-2-4>SELECT FOR UPDATE RANGE [2, 4)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>55.9</td><td>=== Round 2: Testing SELECT_FOR_UPDATE_RANGE ID=2 ===</td><td>=== Round 3: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 2 AND id &lt; 4 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 0 rows (0.04s)</td><td></td></tr></tbody></table><ul><li>数据库内数据为 ID=1,4,5</li><li>Session1 对范围 [2, 4) 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> [2, 4) 范围内没有记录，锁定间隙 [2, 4)，防止其他事务插入该范围内的记录。</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>58.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td style=text-align:center>58.5</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>58.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td style=text-align:center>61.8</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>62.1</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>62.4</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td style=text-align:center>65.4</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr></tbody></table><h6 id=select-for-update-range-3-5>SELECT FOR UPDATE RANGE [3, 5)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>68.6</td><td>=== Round 3: Testing SELECT_FOR_UPDATE_RANGE ID=3 ===</td><td>=== Round 4: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 3 AND id &lt; 5 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 1 rows (0.02s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>数据库内数据为 ID=1,4,5</li><li>Session1 对范围 [3, 5) 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> [2, 5) 范围内没有记录，锁定间隙 [2, 5)，防止其他事务插入该范围</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>70.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 2 FOR UPDATE</td></tr><tr><td style=text-align:center>71.0</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>71.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (2)</td></tr><tr><td style=text-align:center>74.3</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.04s) (3.04s)</td></tr><tr><td style=text-align:center>74.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 3 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>75.0</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (3)</td></tr><tr><td style=text-align:center>78.0</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>78.3</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td></tr><tr><td style=text-align:center>81.3</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>81.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (4)</td></tr><tr><td style=text-align:center>84.6</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>84.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 1 rows (0.03s)</td></tr><tr><td style=text-align:center>~</td><td></td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td></tr><tr><td style=text-align:center>85.2</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td style=text-align:center>~</td><td></td><td>ERROR: INSERT duplicate (0.03s) (0.03s)</td></tr></tbody></table><h6 id=select-for-update-range-4-6>SELECT FOR UPDATE RANGE [4, 6)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>86.8</td><td>=== Round 4: Testing SELECT_FOR_UPDATE_RANGE ID=4 ===</td><td>=== Round 5: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 4 AND id &lt; 6 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 2 rows (0.03s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(4, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>数据库内数据为 ID=1,4,5</li><li>Session1 对范围 [4, 6) 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> [4, +∞) 范围内没有记录，锁定间隙 [4, +∞)，防止其他事务插入该范围内的记录。</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>90.5</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 4 FOR UPDATE</td></tr><tr><td style=text-align:center>93.5</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>93.9</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (4)</td></tr><tr><td style=text-align:center>96.9</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>97.2</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td style=text-align:center>100.3</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>100.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td style=text-align:center>103.6</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>103.9</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>104.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td style=text-align:center>107.3</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>107.6</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td style=text-align:center>107.7</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>108.0</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td style=text-align:center>111.0</td><td>mysql> rollback</td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr></tbody></table><h6 id=select-for-update-range-5-7>SELECT FOR UPDATE RANGE [5, 7)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>111.3</td><td>=== Round 5: Testing SELECT_FOR_UPDATE_RANGE ID=5 ===</td><td>=== Round 6: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 5 AND id &lt; 7 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 1 rows (0.03s)</td><td></td></tr><tr><td style=text-align:center>~</td><td>(5, &lsquo;2025-09-27 11:22:48&rsquo;, &lsquo;2025-09-27 11:22:48&rsquo;)</td><td></td></tr></tbody></table><ul><li>数据库内数据为 ID=1,4,5</li><li>Session1 对范围 [5, 7) 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> [5, +∞) 范围内没有记录，锁定间隙 [5, +∞)，防止其他事务插入该范围</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>116.0</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 5 FOR UPDATE</td></tr><tr><td style=text-align:center>119.0</td><td></td><td>ERROR: SELECT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>119.3</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (5)</td></tr><tr><td style=text-align:center>122.3</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>122.7</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>123.0</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td style=text-align:center>126.1</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>126.4</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>126.8</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td style=text-align:center>129.8</td><td>mysql> rollback</td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr></tbody></table><h6 id=select-for-update-range-6-8>SELECT FOR UPDATE RANGE [6, 8)</h6><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>130.1</td><td>=== Round 6: Testing SELECT_FOR_UPDATE_RANGE ID=6 ===</td><td>=== Round 7: Testing SELECT & INSERT ===</td></tr><tr><td style=text-align:center>~</td><td>mysql> start transaction</td><td></td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td>mysql> SELECT * FROM example_single_pk WHERE id >= 6 AND id &lt; 8 FOR UPDATE</td><td></td></tr><tr><td style=text-align:center>~</td><td>Range query returned 0 rows (0.03s)</td><td></td></tr></tbody></table><ul><li>数据库内数据为 ID=1,4,5</li><li>Session1 对范围 [6, 8) 进行 <code>SELECT FOR UPDATE</code>，持有<code>间隙锁</code> [6, +∞) 范围内没有记录，锁定间隙 [6, +∞)，防止其他事务插入该范围</li></ul><table><thead><tr><th style=text-align:center>Time</th><th>SESSION 1 (LEFT)</th><th>SESSION 2 (RIGHT)</th></tr></thead><tbody><tr><td style=text-align:center>135.3</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 6 FOR UPDATE</td></tr><tr><td style=text-align:center>135.4</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>135.6</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (6)</td></tr><tr><td style=text-align:center>138.7</td><td></td><td>ERROR: INSERT <code>timeout</code> (3.11s) (3.11s)</td></tr><tr><td style=text-align:center>139.1</td><td></td><td>mysql> SELECT * FROM example_single_pk WHERE id = 7 FOR UPDATE</td></tr><tr><td style=text-align:center>~</td><td></td><td>SELECT returned 0 rows (0.03s)</td></tr><tr><td style=text-align:center>139.5</td><td></td><td>mysql> INSERT INTO example_single_pk (id) VALUES (7)</td></tr><tr><td style=text-align:center>142.5</td><td>mysql> rollback</td><td>ERROR: INSERT <code>timeout</code> (3.03s) (3.03s)</td></tr><tr><td style=text-align:center>~</td><td>Query OK, 0 rows affected</td><td></td></tr><tr><td style=text-align:center>~</td><td></td><td>SESSION 2 COMPLETE</td></tr><tr><td style=text-align:center>142.8</td><td>SESSION 1 COMPLETE</td><td></td></tr></tbody></table><h3 id=附录>附录</h3><ul><li>python脚本，用于数据获取</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span><span class=lnt>433
</span><span class=lnt>434
</span><span class=lnt>435
</span><span class=lnt>436
</span><span class=lnt>437
</span><span class=lnt>438
</span><span class=lnt>439
</span><span class=lnt>440
</span><span class=lnt>441
</span><span class=lnt>442
</span><span class=lnt>443
</span><span class=lnt>444
</span><span class=lnt>445
</span><span class=lnt>446
</span><span class=lnt>447
</span><span class=lnt>448
</span><span class=lnt>449
</span><span class=lnt>450
</span><span class=lnt>451
</span><span class=lnt>452
</span><span class=lnt>453
</span><span class=lnt>454
</span><span class=lnt>455
</span><span class=lnt>456
</span><span class=lnt>457
</span><span class=lnt>458
</span><span class=lnt>459
</span><span class=lnt>460
</span><span class=lnt>461
</span><span class=lnt>462
</span><span class=lnt>463
</span><span class=lnt>464
</span><span class=lnt>465
</span><span class=lnt>466
</span><span class=lnt>467
</span><span class=lnt>468
</span><span class=lnt>469
</span><span class=lnt>470
</span><span class=lnt>471
</span><span class=lnt>472
</span><span class=lnt>473
</span><span class=lnt>474
</span><span class=lnt>475
</span><span class=lnt>476
</span><span class=lnt>477
</span><span class=lnt>478
</span><span class=lnt>479
</span><span class=lnt>480
</span><span class=lnt>481
</span><span class=lnt>482
</span><span class=lnt>483
</span><span class=lnt>484
</span><span class=lnt>485
</span><span class=lnt>486
</span><span class=lnt>487
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>MySQL Lock Testing - Timeline Analysis Version
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pymysql</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DB_CONFIG</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;host&#39;</span><span class=p>:</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;user&#39;</span><span class=p>:</span> <span class=s1>&#39;haotian&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;password&#39;</span><span class=p>:</span> <span class=s1>&#39;qwe123qwe123&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;database&#39;</span><span class=p>:</span> <span class=s1>&#39;toy&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;autocommit&#39;</span><span class=p>:</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Test Configuration - Modify as needed</span>
</span></span><span class=line><span class=cl><span class=n>TEST_CONFIG</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># Session1 Configuration</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;session1_operation&#39;</span><span class=p>:</span> <span class=s1>&#39;select_for_update_range&#39;</span><span class=p>,</span>  <span class=c1># &#39;insert&#39;, &#39;select_for_update&#39;, &#39;select_for_update_range&#39;</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;insert_start&#39;</span><span class=p>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span>     <span class=c1># Operation start ID</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;insert_end&#39;</span><span class=p>:</span> <span class=mi>7</span><span class=p>,</span>        <span class=c1># Operation end ID (exclusive)</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;range_size&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>        <span class=c1># Range size (for select_for_update_range only)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Session2 Test Configuration</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;test_ids&#39;</span><span class=p>:</span> <span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>],</span>  <span class=c1># ID list to test</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;lock_`timeout`&#39;</span><span class=p>:</span> <span class=mi>3</span>       <span class=c1># Lock wait `timeout` in seconds</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Global log collector</span>
</span></span><span class=line><span class=cl><span class=n>timeline_log</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>log_lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log_event</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>event_type</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Record event to timeline&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>log_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>timestamp</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>timeline_log</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;session&#39;</span><span class=p>:</span> <span class=n>session</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=n>event_type</span><span class=p>,</span>  <span class=c1># &#39;sql&#39;, &#39;info&#39;, &#39;error&#39;</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sql&#39;</span><span class=p>:</span> <span class=n>sql</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;result&#39;</span><span class=p>:</span> <span class=n>result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=n>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;duration&#39;</span><span class=p>:</span> <span class=n>duration</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Real-time progress display</span>
</span></span><span class=line><span class=cl>        <span class=n>time_str</span> <span class=o>=</span> <span class=n>timestamp</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%H:%M:%S.</span><span class=si>%f</span><span class=s2>&#34;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event_type</span> <span class=o>==</span> <span class=s1>&#39;sql&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>progress_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mysql&gt; </span><span class=si>{</span><span class=n>sql</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>duration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>progress_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>event_type</span> <span class=o>==</span> <span class=s1>&#39;error&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>progress_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;ERROR: </span><span class=si>{</span><span class=n>error</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>duration</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>progress_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>progress_text</span> <span class=o>=</span> <span class=n>result</span> <span class=ow>or</span> <span class=n>sql</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>time_str</span><span class=si>}</span><span class=s2>] [</span><span class=si>{</span><span class=n>session</span><span class=si>}</span><span class=s2>] </span><span class=si>{</span><span class=n>progress_text</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>session1</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Session1: Loop operations (INSERT or SELECT FOR UPDATE)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=n>DB_CONFIG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>operation_type</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;session1_operation&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;SESSION 1 START - </span><span class=si>{</span><span class=n>operation_type</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Check table status</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM example_single_pk&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=s1>&#39;SELECT * FROM example_single_pk&#39;</span><span class=p>,</span> <span class=n>results</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Loop operations</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>target_id</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_start&#39;</span><span class=p>],</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_end&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;=== Round </span><span class=si>{</span><span class=n>target_id</span><span class=si>}</span><span class=s1>: Testing </span><span class=si>{</span><span class=n>operation_type</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s1> ID=</span><span class=si>{</span><span class=n>target_id</span><span class=si>}</span><span class=s1> ===&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Start transaction</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=s1>&#39;start transaction&#39;</span><span class=p>,</span> <span class=s1>&#39;Query OK, 0 rows affected&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;START TRANSACTION&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>operation_type</span> <span class=o>==</span> <span class=s1>&#39;insert&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># INSERT operation</span>
</span></span><span class=line><span class=cl>                    <span class=n>sql</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;INSERT INTO example_single_pk (id) VALUES (</span><span class=si>{</span><span class=n>target_id</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=s1>&#39;Query OK, 1 row affected&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>except</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>err</span><span class=o>.</span><span class=n>IntegrityError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span> <span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>operation_type</span> <span class=o>==</span> <span class=s1>&#39;select_for_update&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># SELECT FOR UPDATE operation</span>
</span></span><span class=line><span class=cl>                    <span class=n>sql</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SELECT * FROM example_single_pk WHERE id = </span><span class=si>{</span><span class=n>target_id</span><span class=si>}</span><span class=s2> FOR UPDATE&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>results</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;Query returned </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span><span class=si>}</span><span class=s1> rows (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                <span class=n>formatted_row</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=s1>&#39;strftime&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=nb>tuple</span><span class=p>(</span><span class=n>formatted_row</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span> <span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>operation_type</span> <span class=o>==</span> <span class=s1>&#39;select_for_update_range&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># SELECT FOR UPDATE range operation</span>
</span></span><span class=line><span class=cl>                    <span class=n>range_size</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;range_size&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=n>end_id</span> <span class=o>=</span> <span class=n>target_id</span> <span class=o>+</span> <span class=n>range_size</span>
</span></span><span class=line><span class=cl>                    <span class=n>sql</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SELECT * FROM example_single_pk WHERE id &gt;= </span><span class=si>{</span><span class=n>target_id</span><span class=si>}</span><span class=s2> AND id &lt; </span><span class=si>{</span><span class=n>end_id</span><span class=si>}</span><span class=s2> FOR UPDATE&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>results</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;Range query returned </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span><span class=si>}</span><span class=s1> rows (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                <span class=n>formatted_row</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=s1>&#39;strftime&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=nb>tuple</span><span class=p>(</span><span class=n>formatted_row</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span> <span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># Notify Session2 and wait</span>
</span></span><span class=line><span class=cl>                <span class=n>session2_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>session1_event</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>session1_event</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># ROLLBACK</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=s1>&#39;rollback&#39;</span><span class=p>,</span> <span class=s1>&#39;Query OK, 0 rows affected&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;ROLLBACK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;transaction&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;ROLLBACK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;main_loop&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;Session1 main loop error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S1&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;SESSION 1 COMPLETE&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>session2_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>  <span class=c1># Final notification</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>session2</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Session2: SELECT FOR UPDATE testing&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;SESSION 2 START - Waiting for Session1...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>round_num</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>total_rounds</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_end&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_start&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>round_num</span> <span class=o>&lt;</span> <span class=n>total_rounds</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session2_event</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>session2_event</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>round_num</span> <span class=o>&gt;=</span> <span class=n>total_rounds</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;=== Round </span><span class=si>{</span><span class=n>round_num</span><span class=si>}</span><span class=s1>: Testing SELECT &amp; INSERT ===&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Test all configured IDs, testing both SELECT FOR UPDATE and INSERT for each ID</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>test_id</span> <span class=ow>in</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;test_ids&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Test 1: SELECT FOR UPDATE</span>
</span></span><span class=line><span class=cl>            <span class=n>conn1</span> <span class=o>=</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=n>DB_CONFIG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor1</span> <span class=o>=</span> <span class=n>conn1</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor1</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SET innodb_lock_wait_`timeout` = </span><span class=si>{</span><span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;lock_`timeout`&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor1</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;START TRANSACTION&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># SELECT FOR UPDATE</span>
</span></span><span class=line><span class=cl>                <span class=n>sql</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SELECT * FROM example_single_pk WHERE id = </span><span class=si>{</span><span class=n>test_id</span><span class=si>}</span><span class=s2> FOR UPDATE&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>cursor1</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>results</span> <span class=o>=</span> <span class=n>cursor1</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;SELECT returned </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span><span class=si>}</span><span class=s1> rows (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>formatted_row</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=s1>&#39;strftime&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                                    <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                    <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=nb>tuple</span><span class=p>(</span><span class=n>formatted_row</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>err</span><span class=o>.</span><span class=n>OperationalError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=s2>&#34;Lock wait `timeout`&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;SELECT `timeout` (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;SELECT error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>cursor1</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;ROLLBACK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;connection&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;SELECT connection error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>conn1</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Test 2: INSERT</span>
</span></span><span class=line><span class=cl>            <span class=n>conn2</span> <span class=o>=</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=n>DB_CONFIG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor2</span> <span class=o>=</span> <span class=n>conn2</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor2</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SET innodb_lock_wait_`timeout` = </span><span class=si>{</span><span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;lock_`timeout`&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor2</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;START TRANSACTION&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># INSERT</span>
</span></span><span class=line><span class=cl>                <span class=n>sql</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;INSERT INTO example_single_pk (id) VALUES (</span><span class=si>{</span><span class=n>test_id</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>cursor2</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;INSERT success (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>err</span><span class=o>.</span><span class=n>OperationalError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=s2>&#34;Lock wait `timeout`&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;INSERT `timeout` (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;INSERT error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>err</span><span class=o>.</span><span class=n>IntegrityError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>                    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;INSERT duplicate (</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s)&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>cursor2</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;ROLLBACK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;connection&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;INSERT connection error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>conn2</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>round_num</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>session1_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>log_event</span><span class=p>(</span><span class=s1>&#39;S2&#39;</span><span class=p>,</span> <span class=s1>&#39;info&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;SESSION 2 COMPLETE&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_round_analysis</span><span class=p>(</span><span class=n>round_num</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Print single round analysis&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>80</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Round </span><span class=si>{</span><span class=n>round_num</span><span class=si>}</span><span class=s2> Analysis&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>80</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Find events for this round</span>
</span></span><span class=line><span class=cl>    <span class=n>round_events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>timeline_log</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S1&#39;</span> <span class=ow>and</span> <span class=sa>f</span><span class=s1>&#39;Round </span><span class=si>{</span><span class=n>round_num</span><span class=si>}</span><span class=s1>:&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;result&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)))</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S2&#39;</span> <span class=ow>and</span> <span class=sa>f</span><span class=s1>&#39;Round </span><span class=si>{</span><span class=n>round_num</span><span class=si>}</span><span class=s1>:&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;result&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>))):</span>
</span></span><span class=line><span class=cl>            <span class=n>round_start_time</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Collect all events for this round</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>timeline_log</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>relative_time</span> <span class=o>=</span> <span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>round_start_time</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>relative_time</span> <span class=o>&lt;=</span> <span class=mi>20</span><span class=p>:</span>  <span class=c1># Assume max 20 seconds per round</span>
</span></span><span class=line><span class=cl>            <span class=n>round_events</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>relative_time</span><span class=p>,</span> <span class=n>event</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Display by time columns</span>
</span></span><span class=line><span class=cl>    <span class=n>operation_type</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;session1_operation&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>operation_type</span> <span class=o>==</span> <span class=s1>&#39;SELECT_FOR_UPDATE_RANGE&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>range_size</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;range_size&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>s1_header</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SESSION 1 (RANGE+</span><span class=si>{</span><span class=n>range_size</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>s1_header</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SESSION 1 (</span><span class=si>{</span><span class=n>operation_type</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;Time&#39;</span><span class=si>:</span><span class=s2>&gt;6</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>s1_header</span><span class=si>:</span><span class=s2>^35</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=s1>&#39;SESSION 2 (SELECT &amp; INSERT)&#39;</span><span class=si>:</span><span class=s2>^35</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>grouped</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>rel_time</span><span class=p>,</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>round_events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>time_bucket</span> <span class=o>=</span> <span class=nb>round</span><span class=p>(</span><span class=n>rel_time</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>grouped</span><span class=p>[</span><span class=n>time_bucket</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>time_bucket</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>grouped</span><span class=o>.</span><span class=n>keys</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=n>grouped</span><span class=p>[</span><span class=n>time_bucket</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>s1_events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span> <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S1&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>s2_events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span> <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S2&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>max_events</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>s1_events</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_events</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>s1_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>s2_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s1_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span> <span class=o>=</span> <span class=n>s1_events</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;sql&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s1_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mysql&gt; </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;duration&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;info&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s1_text</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>or</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span> <span class=o>=</span> <span class=n>s2_events</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;sql&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s2_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mysql&gt; </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;info&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=s1>&#39;Query returned&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                        <span class=n>s2_text</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=s1>&#39;(&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                        <span class=n>s2_text</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;error&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s2_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;ERROR: </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;error&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>time_str</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>time_bucket</span><span class=si>:</span><span class=s2>6.1f</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>s1_text</span> <span class=o>=</span> <span class=n>s1_text</span><span class=p>[:</span><span class=mi>33</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>s2_text</span> <span class=o>=</span> <span class=n>s2_text</span><span class=p>[:</span><span class=mi>33</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>time_str</span><span class=si>:</span><span class=s2>&gt;6</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>s1_text</span><span class=si>:</span><span class=s2>&lt;35</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>s2_text</span><span class=si>:</span><span class=s2>&lt;35</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_timeline_analysis</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Analyze and print timeline&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Print analysis for each round first</span>
</span></span><span class=line><span class=cl>    <span class=n>total_rounds</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_end&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;insert_start&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>round_num</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>total_rounds</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>print_round_analysis</span><span class=p>(</span><span class=n>round_num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>150</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Complete Timeline Analysis&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>150</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>timeline_log</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;No events recorded&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Group by time, find simultaneous events</span>
</span></span><span class=line><span class=cl>    <span class=n>grouped_events</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>base_time</span> <span class=o>=</span> <span class=n>timeline_log</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>timeline_log</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Calculate relative time (seconds)</span>
</span></span><span class=line><span class=cl>        <span class=n>relative_time</span> <span class=o>=</span> <span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>base_time</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># Group by 0.1 second intervals</span>
</span></span><span class=line><span class=cl>        <span class=n>time_bucket</span> <span class=o>=</span> <span class=nb>round</span><span class=p>(</span><span class=n>relative_time</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>grouped_events</span><span class=p>[</span><span class=n>time_bucket</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Print column format</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;Time&#39;</span><span class=si>:</span><span class=s2>&gt;6</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=s1>&#39;SESSION 1 (LEFT)&#39;</span><span class=si>:</span><span class=s2>^70</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=s1>&#39;SESSION 2 (RIGHT)&#39;</span><span class=si>:</span><span class=s2>^70</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span> <span class=o>*</span> <span class=mi>150</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>time_bucket</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>grouped_events</span><span class=o>.</span><span class=n>keys</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=n>grouped_events</span><span class=p>[</span><span class=n>time_bucket</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>s1_events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span> <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S1&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>s2_events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span> <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;session&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;S2&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>max_events</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>s1_events</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_events</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>s1_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>s2_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s1_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span> <span class=o>=</span> <span class=n>s1_events</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;sql&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s1_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mysql&gt; </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>],</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>],</span> <span class=s1>&#39;__iter__&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>])</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Empty set&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=c1># 显示所有数据，格式化datetime</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                                <span class=n>formatted_row</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=s1>&#39;strftime&#39;</span><span class=p>):</span>  <span class=c1># datetime对象</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=nb>tuple</span><span class=p>(</span><span class=n>formatted_row</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                            <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>])</span><span class=si>}</span><span class=s2> rows&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                        <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;error&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s1_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;ERROR: </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;error&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                        <span class=n>s1_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>  <span class=c1># info</span>
</span></span><span class=line><span class=cl>                    <span class=n>s1_text</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>or</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span> <span class=o>=</span> <span class=n>s2_events</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;sql&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s2_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mysql&gt; </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>],</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>],</span> <span class=s1>&#39;__iter__&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>])</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Empty set&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=c1># 显示所有数据，格式化datetime</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                                <span class=n>formatted_row</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=s1>&#39;strftime&#39;</span><span class=p>):</span>  <span class=c1># datetime对象</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                                        <span class=n>formatted_row</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=nb>tuple</span><span class=p>(</span><span class=n>formatted_row</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                            <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>])</span><span class=si>}</span><span class=s2> rows&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                        <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;error&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>s2_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;ERROR: </span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;error&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                        <span class=n>s2_text</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34; (</span><span class=si>{</span><span class=n>e</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>  <span class=c1># info</span>
</span></span><span class=line><span class=cl>                    <span class=n>s2_text</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=ow>or</span> <span class=n>e</span><span class=p>[</span><span class=s1>&#39;sql&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Handle multi-line text</span>
</span></span><span class=line><span class=cl>            <span class=n>s1_lines</span> <span class=o>=</span> <span class=n>s1_text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span> <span class=k>if</span> <span class=n>s1_text</span> <span class=k>else</span> <span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>s2_lines</span> <span class=o>=</span> <span class=n>s2_text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span> <span class=k>if</span> <span class=n>s2_text</span> <span class=k>else</span> <span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>max_lines</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>s1_lines</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_lines</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_lines</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>time_str</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>time_bucket</span><span class=si>:</span><span class=s2>6.1f</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>j</span> <span class=o>==</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>s1_line</span> <span class=o>=</span> <span class=n>s1_lines</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=k>if</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s1_lines</span><span class=p>)</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>s2_line</span> <span class=o>=</span> <span class=n>s2_lines</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=k>if</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>s2_lines</span><span class=p>)</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># Increase display width, reduce truncation</span>
</span></span><span class=line><span class=cl>                <span class=n>s1_line</span> <span class=o>=</span> <span class=n>s1_line</span><span class=p>[:</span><span class=mi>80</span><span class=p>]</span> <span class=k>if</span> <span class=n>s1_line</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;mysql&gt;&#39;</span><span class=p>)</span> <span class=k>else</span> <span class=n>s1_line</span><span class=p>[:</span><span class=mi>70</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>s2_line</span> <span class=o>=</span> <span class=n>s2_line</span><span class=p>[:</span><span class=mi>80</span><span class=p>]</span> <span class=k>if</span> <span class=n>s2_line</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;mysql&gt;&#39;</span><span class=p>)</span> <span class=k>else</span> <span class=n>s2_line</span><span class=p>[:</span><span class=mi>70</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>time_str</span><span class=si>:</span><span class=s2>&gt;6</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>s1_line</span><span class=si>:</span><span class=s2>&lt;70</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>s2_line</span><span class=si>:</span><span class=s2>&lt;70</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>150</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Event objects</span>
</span></span><span class=line><span class=cl><span class=n>session1_event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>session2_event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>operation_type</span> <span class=o>=</span> <span class=n>TEST_CONFIG</span><span class=p>[</span><span class=s1>&#39;session1_operation&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;MySQL Lock Test - Timeline Collection Mode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Session1: </span><span class=si>{</span><span class=n>operation_type</span><span class=si>}</span><span class=s2> operations&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Session2: SELECT FOR UPDATE &amp; INSERT tests&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Collecting all events with timestamps...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>t1</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>session1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t2</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>session2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>t2</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t1</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>t1</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>t2</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>print_timeline_analysis</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Analysis Complete!&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2025-12-06&nbsp;<a class=git-hash href=https://github.com/GOODDAYDAY/GOODDAYDAY.github.io/commit/af3d5c9bd409e602f90f3dec7c5441cd7924d96f target=_blank title="commit by haotian(865700600@qq.com) af3d5c9bd409e602f90f3dec7c5441cd7924d96f: Refactor Redis Cluster documentation for clarity and consistency">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>af3d5c9</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/zh-cn/2025/09/mysql-2.-mysql-lock/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://gooddayday.github.io/zh-cn/2025/09/mysql-2.-mysql-lock/ data-title="[MySQL] 2. 锁机制执行分析" data-hashtags=MySQL,Lock><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://gooddayday.github.io/zh-cn/2025/09/mysql-2.-mysql-lock/ data-hashtag=MySQL><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://gooddayday.github.io/zh-cn/2025/09/mysql-2.-mysql-lock/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://gooddayday.github.io/zh-cn/2025/09/mysql-2.-mysql-lock/ data-title="[MySQL] 2. 锁机制执行分析"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://gooddayday.github.io/zh-cn/2025/09/mysql-2.-mysql-lock/ data-title="[MySQL] 2. 锁机制执行分析"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://gooddayday.github.io/zh-cn/2025/09/mysql-2.-mysql-lock/ data-title="[MySQL] 2. 锁机制执行分析"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/zh-cn/tags/mysql/>MySQL</a>,&nbsp;<a href=/zh-cn/tags/lock/>Lock</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/zh-cn/>主页</a></span></section></div><div class=post-nav><a href=/zh-cn/2025/09/github-4.-value-checker/ class=prev rel=prev title="[Github] 4. Value-Checker-Java：可自定义的AOP验证框架"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>[Github] 4. Value-Checker-Java：可自定义的AOP验证框架</a>
<a href=/zh-cn/2025/09/mysql-3.-mysql-index/ class=next rel=next title="[MySQL] 3. MySQL 索引">[MySQL] 3. MySQL 索引<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><span class=author itemprop=copyrightHolder>&nbsp;<a href=/zh-cn/ target=_blank>GoodyHao</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><link rel=stylesheet href=/css/auto-numbering.css><link rel=stylesheet href=/css/svg-fullwidth.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOPtWtCc4CvteQ",darkTheme:"dark",emitMetadata:"0",inputPosition:"bottom",lang:"zh-CN",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"GOODDAYDAY/GOODDAYDAY.github.io",repoId:"R_kgDOPtWtCQ"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.zh-cn",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>