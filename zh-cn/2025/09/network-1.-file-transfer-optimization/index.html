<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>[Network] 1. 文件传输优化分享 - GoodyHao's Blog</title><meta name=Description content="Elegance Never Fades"><meta property="og:url" content="https://gooddayday.github.io/zh-cn/2025/09/network-1.-file-transfer-optimization/"><meta property="og:site_name" content="GoodyHao's Blog"><meta property="og:title" content="[Network] 1. 文件传输优化分享"><meta property="og:description" content='背景(敏感数据已脱敏) 由于种种要求，需要将数据上传到海外的 oss 上进行存储。所以开发了一个代理服务维护数据并进行加密等操作。期间内部发现数据上传下载非常慢，经过一系列排查，最终定位到问题根源，并给出解决方案。现将排查过程进行分享。 当然了，前提之一是内网打通，通过专线网络接入，才能做到理论上的物理极限。使用复杂漫长的公共网络既不适合文件安全，也不适合大文件长时间传输。 服务本身问题 最初怀疑是数据落盘导致的太慢。因为上传必须落盘，防止文件过大。下载直接流式传输，非常合理。唯一的改进是上传进行流式加密和传输，但是当前问题不大。 现象 使用编写的脚本上传 1M 的加密数据，耗时接近 2s 1 2 3 4 5 import requests requests.post(f"{url}/upload/files", files={ "data": (&#39;&#39;, upload_data, "application/json"), "file": transfer_data }) 1 2 3 4 5 6 7 $ python oss.py --file_input=./1M.data --region=us --model=3 --range=5 encrypted_upload upload ./1M.data, encrypt cost 4.714599609375, upload cost 1788.95849609375 upload ./1M.data, encrypt cost 10.140625, upload cost 1945.90087890625 upload ./1M.data, encrypt cost 9.924560546875, upload cost 1756.984130859375 upload ./1M.data, encrypt cost 8.694580078125, upload cost 1930.31201171875 upload ./1M.data, encrypt cost 8.279296875, upload cost 1739.38623046875 抓包 与运维进行沟通，运维怀疑是网络问题，进行抓包一探究竟。 抓包演示 ping 包 1 2 3 4 5 6 7 8 9 10 11 12 $ sudo tcpdump -i bond0 | grep x.x.x.x1 tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on bond0, link-type EN10MB (Ethernet), capture size 262144 bytes 16:21:19.255718 IP public2.alidns.com.domain > domain1.36590: 43190 1/0/1 A x.x.x.x1 (88) 16:21:19.256404 IP domain1 > x.x.x.x1: ICMP echo request, id 32590, seq 1, length 64 16:21:19.456754 IP x.x.x.x1 > domain1: ICMP echo reply, id 32590, seq 1, length 64 16:21:20.257688 IP domain1 > x.x.x.x1: ICMP echo request, id 32590, seq 2, length 64 16:21:20.458076 IP x.x.x.x1 > domain1: ICMP echo reply, id 32590, seq 2, length 64 16:21:21.259088 IP domain1 > x.x.x.x1: ICMP echo request, id 32590, seq 3, length 64 16:21:21.459506 IP x.x.x.x1 > domain1: ICMP echo reply, id 32590, seq 3, length 64 16:21:22.260538 IP domain1 > x.x.x.x1: ICMP echo request, id 32590, seq 4, length 64 16:21:22.460976 IP x.x.x.x1 > domain1: ICMP echo reply, id 32590, seq 4, length 64 1 2 3 4 5 6 7 8 9 $ ping domain1 PING domain1 (x.x.x.x1) 56(84) bytes of data. 64 bytes from x.x.x.x1 (x.x.x.x1): icmp_seq=1 ttl=58 time=200 ms 64 bytes from x.x.x.x1 (x.x.x.x1): icmp_seq=2 ttl=58 time=200 ms 64 bytes from x.x.x.x1 (x.x.x.x1): icmp_seq=3 ttl=58 time=200 ms ^C --- domain1 ping statistics --- 4 packets transmitted, 3 received, 25% packet loss, time 3004ms rtt min/avg/max/mdev = 200.395/200.419/200.456/0.517 ms 三次握手 1 2 3 16:54:06.286416 IP domain1.33666 > x.x.x.x1.http: Flags [S], seq 2682796272, win 64240, options [mss 1460,sackOK,TS val 2595135963 ecr 0,nop,wscale 7], length 0 16:54:06.486797 IP x.x.x.x1.http > domain1.33666: Flags [S.], seq 2198055866, ack 2682796273, win 62643, options [mss 1460,sackOK,TS val 2062390218 ecr 2595135963,nop,wscale 7], length 0 16:54:06.486840 IP domain1.33666 > x.x.x.x1.http: Flags [.], ack 1, win 502, options [nop,nop,TS val 2595136163 ecr 2062390218], length 0 四次挥手 1 2 3 16:54:28.356723 IP domain1.54028 > x.x.x.x1.http: Flags [F.], seq 1746, ack 215, win 501, options [nop,nop,TS val 2595158034 ecr 2062412087], length 0 16:54:28.557169 IP x.x.x.x1.http > domain1.54028: Flags [F.], seq 215, ack 1747, win 477, options [nop,nop,TS val 2062412289 ecr 2595158034], length 0 16:54:28.557222 IP domain1.54028 > x.x.x.x1.http: Flags [.], ack 216, win 501, options [nop,nop,TS val 2595158234 ecr 2062412289], length 0 tcpdump Flags Tcpdump flags 是指示 TCP 连接状态或动作的标志。它们通常在 tcpdump 输出中用方括号表示。Tcpdump 输出中有多种 flags，输出也可能包含多个 TCP flags 的组合 1。一些常见的 flags 有： S (SYN): 这个 flag 用于在两个主机之间建立连接。它在三次握手的第一个包中设置。 . (No flag): 这意味着在包中没有设置任何 flag。它通常用于数据传输或确认包。 P (PUSH): 这个 flag 用于表示发送方希望尽快发送数据，而不等待缓冲区填满。 F (FIN): 这个 flag 用于终止两个主机之间的连接。它在四次挥手的最后一个包中设置。 R (RST): 这个 flag 用于重置处于无效状态或遇到错误的连接。它也用于拒绝不想要的连接尝试。 W (ECN CWR): 这个 flag 用于表示发送方已经根据网络的显式拥塞通知 (ECN) 减小了其拥塞窗口大小。 E (ECN-Echo): 这个 flag 用于表示接收方已经收到了一个带有 ECN 位的包，这意味着网络中存在拥塞。 例如，一个带有 flags [S.] 的包意味着它是一个 SYN 包，是建立 TCP 连接的第一步。一个带有 flags [P.] 的包意味着它是一个 PUSH 包，包含了发送方想要快速传送的数据。一个带有 flags [F.] 的包意味着它是一个 FIN 包，是关闭 TCP 连接的最后一步 2。 为什么 tcpdump 四次挥手只有三个包 Tcpdump 四次挥手只有三个包的原因可能有以下几种： 一种可能是被动关闭方（收到 FIN 的一方）在回复 ACK 的同时，也发送了自己的 FIN，将第二次和第三次挥手合并为一个报文，节省了一个包 1。这种情况下，被动关闭方已经没有数据要发送了，所以可以直接进入 LAST_ACK 状态，等待主动关闭方的最后一个 ACK。 另一种可能是主动关闭方（发送 FIN 的一方）在收到被动关闭方的 FIN 后，没有及时回复 ACK，而是在一段时间后才发送 ACK，并且在 ACK 中设置了 RST 标志，表示强制重置连接 2。这种情况下，主动关闭方可能遇到了异常或超时，所以不再等待 2MSL 的时间，而是直接进入 CLOSE 状态。 还有一种可能是 tcpdump 没有抓到所有的包，因为网络延迟或丢包的原因，导致某个挥手的报文没有被捕获到 3。这种情况下，可以尝试重新抓包或增加抓包的时间范围，看是否能够看到完整的四次挥手过程。 实际数据 1 2 3 $ python oss.py --file_input=./1K.data --file_output=./download-1M.data --region=us --model=3 --range=5 encrypted_upload http://domain1 upload ./1K.data, encrypt cost 1.530029296875, upload cost 408.5546875 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ sudo tcpdump -i bond0 | grep x.x.x.x1 tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on bond0, link-type EN10MB (Ethernet), capture size 262144 bytes 16:54:06.286416 IP domain1.33666 > x.x.x.x1.http: Flags [S], seq 2682796272, win 64240, options [mss 1460,sackOK,TS val 2595135963 ecr 0,nop,wscale 7], length 0 16:54:06.486797 IP x.x.x.x1.http > domain1.33666: Flags [S.], seq 2198055866, ack 2682796273, win 62643, options [mss 1460,sackOK,TS val 2062390218 ecr 2595135963,nop,wscale 7], length 0 16:54:06.486840 IP domain1.33666 > x.x.x.x1.http: Flags [.], ack 1, win 502, options [nop,nop,TS val 2595136163 ecr 2062390218], length 0 16:54:06.486930 IP domain1.33666 > x.x.x.x1.http: Flags [P.], seq 1:292, ack 1, win 502, options [nop,nop,TS val 2595136164 ecr 2062390218], length 291: HTTP: POST /upload/files HTTP/1.1 16:54:06.486960 IP domain1.33666 > x.x.x.x1.http: Flags [P.], seq 292:1746, ack 1, win 502, options [nop,nop,TS val 2595136164 ecr 2062390218], length 1454: HTTP 16:54:06.687234 IP x.x.x.x1.http > domain1.33666: Flags [.], ack 292, win 488, options [nop,nop,TS val 2062390419 ecr 2595136164], length 0 16:54:06.687279 IP x.x.x.x1.http > domain1.33666: Flags [.], ack 1746, win 477, options [nop,nop,TS val 2062390419 ecr 2595136164], length 0 16:54:06.690277 IP x.x.x.x1.http > domain1.33666: Flags [P.], seq 1:215, ack 1746, win 477, options [nop,nop,TS val 2062390422 ecr 2595136164], length 214: HTTP: HTTP/1.1 200 OK 16:54:06.690314 IP domain1.33666 > x.x.x.x1.http: Flags [.], ack 215, win 501, options [nop,nop,TS val 2595136367 ecr 2062390422], length 0 16:54:06.692023 IP domain1.33666 > x.x.x.x1.http: Flags [F.], seq 1746, ack 215, win 501, options [nop,nop,TS val 2595136369 ecr 2062390422], length 0 16:54:06.892401 IP x.x.x.x1.http > domain1.33666: Flags [F.], seq 215, ack 1747, win 477, options [nop,nop,TS val 2062390624 ecr 2595136369], length 0 16:54:06.892448 IP domain1.33666 > x.x.x.x1.http: Flags [.], ack 216, win 501, options [nop,nop,TS val 2595136569 ecr 2062390624], length 0 实际是上传 1M 数据，进行分析，此处简化。 因为时间跳跃增长全部发生在服务端返回的数据包。此时问题已经很明了了，由于深圳和美东现实的物理距离，200ms 的来回已经做到了极限。所以其实是合理的。 灵魂拷问 此时，一个灵魂拷问出现了，为什么之前走公网反而更快？ 与兄弟部门同事沟通，模拟他们的代码，使用 aws 的 sdk 进行测试 1 2 3 4 5 6 7 8 9 10 11 12 13 import boto3 from boto3.s3.transfer import TransferConfig def download(): s3_client = client(access_key, access_secret, host) GB = 1024 ** 3 config = TransferConfig(multipart_threshold=2 * GB, max_concurrency=10, use_threads=True) s3_client.download_file(Bucket="bucket", Key="name-100.jpg", Filename="name-100.jpg", Config=config) if __name__ == &#39;__main__&#39;: download() # ... download() 结果'><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-21T16:11:17+08:00"><meta property="article:modified_time" content="2025-12-06T22:29:56+08:00"><meta property="article:tag" content="Network"><meta property="article:tag" content="Tcpdump"><meta property="og:image" content="https://gooddayday.github.io/logo.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gooddayday.github.io/logo.jpg"><meta name=twitter:title content="[Network] 1. 文件传输优化分享"><meta name=twitter:description content='背景(敏感数据已脱敏) 由于种种要求，需要将数据上传到海外的 oss 上进行存储。所以开发了一个代理服务维护数据并进行加密等操作。期间内部发现数据上传下载非常慢，经过一系列排查，最终定位到问题根源，并给出解决方案。现将排查过程进行分享。 当然了，前提之一是内网打通，通过专线网络接入，才能做到理论上的物理极限。使用复杂漫长的公共网络既不适合文件安全，也不适合大文件长时间传输。 服务本身问题 最初怀疑是数据落盘导致的太慢。因为上传必须落盘，防止文件过大。下载直接流式传输，非常合理。唯一的改进是上传进行流式加密和传输，但是当前问题不大。 现象 使用编写的脚本上传 1M 的加密数据，耗时接近 2s 1 2 3 4 5 import requests requests.post(f"{url}/upload/files", files={ "data": (&#39;&#39;, upload_data, "application/json"), "file": transfer_data }) 1 2 3 4 5 6 7 $ python oss.py --file_input=./1M.data --region=us --model=3 --range=5 encrypted_upload upload ./1M.data, encrypt cost 4.714599609375, upload cost 1788.95849609375 upload ./1M.data, encrypt cost 10.140625, upload cost 1945.90087890625 upload ./1M.data, encrypt cost 9.924560546875, upload cost 1756.984130859375 upload ./1M.data, encrypt cost 8.694580078125, upload cost 1930.31201171875 upload ./1M.data, encrypt cost 8.279296875, upload cost 1739.38623046875 抓包 与运维进行沟通，运维怀疑是网络问题，进行抓包一探究竟。 抓包演示 ping 包 1 2 3 4 5 6 7 8 9 10 11 12 $ sudo tcpdump -i bond0 | grep x.x.x.x1 tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on bond0, link-type EN10MB (Ethernet), capture size 262144 bytes 16:21:19.255718 IP public2.alidns.com.domain > domain1.36590: 43190 1/0/1 A x.x.x.x1 (88) 16:21:19.256404 IP domain1 > x.x.x.x1: ICMP echo request, id 32590, seq 1, length 64 16:21:19.456754 IP x.x.x.x1 > domain1: ICMP echo reply, id 32590, seq 1, length 64 16:21:20.257688 IP domain1 > x.x.x.x1: ICMP echo request, id 32590, seq 2, length 64 16:21:20.458076 IP x.x.x.x1 > domain1: ICMP echo reply, id 32590, seq 2, length 64 16:21:21.259088 IP domain1 > x.x.x.x1: ICMP echo request, id 32590, seq 3, length 64 16:21:21.459506 IP x.x.x.x1 > domain1: ICMP echo reply, id 32590, seq 3, length 64 16:21:22.260538 IP domain1 > x.x.x.x1: ICMP echo request, id 32590, seq 4, length 64 16:21:22.460976 IP x.x.x.x1 > domain1: ICMP echo reply, id 32590, seq 4, length 64 1 2 3 4 5 6 7 8 9 $ ping domain1 PING domain1 (x.x.x.x1) 56(84) bytes of data. 64 bytes from x.x.x.x1 (x.x.x.x1): icmp_seq=1 ttl=58 time=200 ms 64 bytes from x.x.x.x1 (x.x.x.x1): icmp_seq=2 ttl=58 time=200 ms 64 bytes from x.x.x.x1 (x.x.x.x1): icmp_seq=3 ttl=58 time=200 ms ^C --- domain1 ping statistics --- 4 packets transmitted, 3 received, 25% packet loss, time 3004ms rtt min/avg/max/mdev = 200.395/200.419/200.456/0.517 ms 三次握手 1 2 3 16:54:06.286416 IP domain1.33666 > x.x.x.x1.http: Flags [S], seq 2682796272, win 64240, options [mss 1460,sackOK,TS val 2595135963 ecr 0,nop,wscale 7], length 0 16:54:06.486797 IP x.x.x.x1.http > domain1.33666: Flags [S.], seq 2198055866, ack 2682796273, win 62643, options [mss 1460,sackOK,TS val 2062390218 ecr 2595135963,nop,wscale 7], length 0 16:54:06.486840 IP domain1.33666 > x.x.x.x1.http: Flags [.], ack 1, win 502, options [nop,nop,TS val 2595136163 ecr 2062390218], length 0 四次挥手 1 2 3 16:54:28.356723 IP domain1.54028 > x.x.x.x1.http: Flags [F.], seq 1746, ack 215, win 501, options [nop,nop,TS val 2595158034 ecr 2062412087], length 0 16:54:28.557169 IP x.x.x.x1.http > domain1.54028: Flags [F.], seq 215, ack 1747, win 477, options [nop,nop,TS val 2062412289 ecr 2595158034], length 0 16:54:28.557222 IP domain1.54028 > x.x.x.x1.http: Flags [.], ack 216, win 501, options [nop,nop,TS val 2595158234 ecr 2062412289], length 0 tcpdump Flags Tcpdump flags 是指示 TCP 连接状态或动作的标志。它们通常在 tcpdump 输出中用方括号表示。Tcpdump 输出中有多种 flags，输出也可能包含多个 TCP flags 的组合 1。一些常见的 flags 有： S (SYN): 这个 flag 用于在两个主机之间建立连接。它在三次握手的第一个包中设置。 . (No flag): 这意味着在包中没有设置任何 flag。它通常用于数据传输或确认包。 P (PUSH): 这个 flag 用于表示发送方希望尽快发送数据，而不等待缓冲区填满。 F (FIN): 这个 flag 用于终止两个主机之间的连接。它在四次挥手的最后一个包中设置。 R (RST): 这个 flag 用于重置处于无效状态或遇到错误的连接。它也用于拒绝不想要的连接尝试。 W (ECN CWR): 这个 flag 用于表示发送方已经根据网络的显式拥塞通知 (ECN) 减小了其拥塞窗口大小。 E (ECN-Echo): 这个 flag 用于表示接收方已经收到了一个带有 ECN 位的包，这意味着网络中存在拥塞。 例如，一个带有 flags [S.] 的包意味着它是一个 SYN 包，是建立 TCP 连接的第一步。一个带有 flags [P.] 的包意味着它是一个 PUSH 包，包含了发送方想要快速传送的数据。一个带有 flags [F.] 的包意味着它是一个 FIN 包，是关闭 TCP 连接的最后一步 2。 为什么 tcpdump 四次挥手只有三个包 Tcpdump 四次挥手只有三个包的原因可能有以下几种： 一种可能是被动关闭方（收到 FIN 的一方）在回复 ACK 的同时，也发送了自己的 FIN，将第二次和第三次挥手合并为一个报文，节省了一个包 1。这种情况下，被动关闭方已经没有数据要发送了，所以可以直接进入 LAST_ACK 状态，等待主动关闭方的最后一个 ACK。 另一种可能是主动关闭方（发送 FIN 的一方）在收到被动关闭方的 FIN 后，没有及时回复 ACK，而是在一段时间后才发送 ACK，并且在 ACK 中设置了 RST 标志，表示强制重置连接 2。这种情况下，主动关闭方可能遇到了异常或超时，所以不再等待 2MSL 的时间，而是直接进入 CLOSE 状态。 还有一种可能是 tcpdump 没有抓到所有的包，因为网络延迟或丢包的原因，导致某个挥手的报文没有被捕获到 3。这种情况下，可以尝试重新抓包或增加抓包的时间范围，看是否能够看到完整的四次挥手过程。 实际数据 1 2 3 $ python oss.py --file_input=./1K.data --file_output=./download-1M.data --region=us --model=3 --range=5 encrypted_upload http://domain1 upload ./1K.data, encrypt cost 1.530029296875, upload cost 408.5546875 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ sudo tcpdump -i bond0 | grep x.x.x.x1 tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on bond0, link-type EN10MB (Ethernet), capture size 262144 bytes 16:54:06.286416 IP domain1.33666 > x.x.x.x1.http: Flags [S], seq 2682796272, win 64240, options [mss 1460,sackOK,TS val 2595135963 ecr 0,nop,wscale 7], length 0 16:54:06.486797 IP x.x.x.x1.http > domain1.33666: Flags [S.], seq 2198055866, ack 2682796273, win 62643, options [mss 1460,sackOK,TS val 2062390218 ecr 2595135963,nop,wscale 7], length 0 16:54:06.486840 IP domain1.33666 > x.x.x.x1.http: Flags [.], ack 1, win 502, options [nop,nop,TS val 2595136163 ecr 2062390218], length 0 16:54:06.486930 IP domain1.33666 > x.x.x.x1.http: Flags [P.], seq 1:292, ack 1, win 502, options [nop,nop,TS val 2595136164 ecr 2062390218], length 291: HTTP: POST /upload/files HTTP/1.1 16:54:06.486960 IP domain1.33666 > x.x.x.x1.http: Flags [P.], seq 292:1746, ack 1, win 502, options [nop,nop,TS val 2595136164 ecr 2062390218], length 1454: HTTP 16:54:06.687234 IP x.x.x.x1.http > domain1.33666: Flags [.], ack 292, win 488, options [nop,nop,TS val 2062390419 ecr 2595136164], length 0 16:54:06.687279 IP x.x.x.x1.http > domain1.33666: Flags [.], ack 1746, win 477, options [nop,nop,TS val 2062390419 ecr 2595136164], length 0 16:54:06.690277 IP x.x.x.x1.http > domain1.33666: Flags [P.], seq 1:215, ack 1746, win 477, options [nop,nop,TS val 2062390422 ecr 2595136164], length 214: HTTP: HTTP/1.1 200 OK 16:54:06.690314 IP domain1.33666 > x.x.x.x1.http: Flags [.], ack 215, win 501, options [nop,nop,TS val 2595136367 ecr 2062390422], length 0 16:54:06.692023 IP domain1.33666 > x.x.x.x1.http: Flags [F.], seq 1746, ack 215, win 501, options [nop,nop,TS val 2595136369 ecr 2062390422], length 0 16:54:06.892401 IP x.x.x.x1.http > domain1.33666: Flags [F.], seq 215, ack 1747, win 477, options [nop,nop,TS val 2062390624 ecr 2595136369], length 0 16:54:06.892448 IP domain1.33666 > x.x.x.x1.http: Flags [.], ack 216, win 501, options [nop,nop,TS val 2595136569 ecr 2062390624], length 0 实际是上传 1M 数据，进行分析，此处简化。 因为时间跳跃增长全部发生在服务端返回的数据包。此时问题已经很明了了，由于深圳和美东现实的物理距离，200ms 的来回已经做到了极限。所以其实是合理的。 灵魂拷问 此时，一个灵魂拷问出现了，为什么之前走公网反而更快？ 与兄弟部门同事沟通，模拟他们的代码，使用 aws 的 sdk 进行测试 1 2 3 4 5 6 7 8 9 10 11 12 13 import boto3 from boto3.s3.transfer import TransferConfig def download(): s3_client = client(access_key, access_secret, host) GB = 1024 ** 3 config = TransferConfig(multipart_threshold=2 * GB, max_concurrency=10, use_threads=True) s3_client.download_file(Bucket="bucket", Key="name-100.jpg", Filename="name-100.jpg", Config=config) if __name__ == &#39;__main__&#39;: download() # ... download() 结果'><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://gooddayday.github.io/zh-cn/2025/09/network-1.-file-transfer-optimization/><link rel=prev href=https://gooddayday.github.io/zh-cn/2025/09/github-1.-deploy-github-blog-site/><link rel=next href=https://gooddayday.github.io/zh-cn/2025/09/mysql-1.-mysql-fast-query-insights/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[Network] 1. 文件传输优化分享","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/gooddayday.github.io\/zh-cn\/2025\/09\/network-1.-file-transfer-optimization\/"},"image":["https:\/\/gooddayday.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"network, tcpdump","wordcount":5696,"url":"https:\/\/gooddayday.github.io\/zh-cn\/2025\/09\/network-1.-file-transfer-optimization\/","datePublished":"2025-09-21T16:11:17+08:00","dateModified":"2025-12-06T22:29:56+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/gooddayday.github.io\/images\/logo.jpg"},"author":{"@type":"Person","name":"GoodyHao"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/zh-cn/ title="GoodyHao's Blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>Elegance Never Fades</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/zh-cn/posts/>所有文章 </a><a class=menu-item href=/zh-cn/tags/>标签 </a><a class=menu-item href=/zh-cn/categories/>分类 </a><a class=menu-item href=/zh-cn/categories/documentation/>文档 </a><a class=menu-item href=/zh-cn/about/>关于 </a><a class=menu-item href=https://github.com/GOODDAYDAY/GOODDAYDAY.github.io title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a class=menu-item href=/en/2025/09/network-1.-file-transfer-optimization/ title=English>English</a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/zh-cn/ title="GoodyHao's Blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>Elegance Never Fades</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/zh-cn/posts/ title>所有文章</a><a class=menu-item href=/zh-cn/tags/ title>标签</a><a class=menu-item href=/zh-cn/categories/ title>分类</a><a class=menu-item href=/zh-cn/categories/documentation/ title>文档</a><a class=menu-item href=/zh-cn/about/ title>关于</a><a class=menu-item href=https://github.com/GOODDAYDAY/GOODDAYDAY.github.io title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a class=menu-item href=/en/2025/09/network-1.-file-transfer-optimization/ title=English>English</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">[Network] 1. 文件传输优化分享</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/zh-cn/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>GoodyHao</a></span>&nbsp;<span class=post-category>收录于 <a href=/zh-cn/categories/network/><i class="far fa-folder fa-fw" aria-hidden=true></i>Network</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2025-09-21>2025-09-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 5696 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 12 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#背景敏感数据已脱敏>背景(敏感数据已脱敏)</a></li><li><a href=#服务本身问题>服务本身问题</a></li><li><a href=#现象>现象</a></li><li><a href=#抓包>抓包</a><ul><li><a href=#抓包演示>抓包演示</a><ul><li><a href=#ping-包>ping 包</a></li><li><a href=#三次握手>三次握手</a></li><li><a href=#四次挥手>四次挥手</a></li><li><a href=#tcpdump-flags>tcpdump Flags</a></li><li><a href=#为什么-tcpdump-四次挥手只有三个包>为什么 tcpdump 四次挥手只有三个包</a></li></ul></li><li><a href=#实际数据>实际数据</a></li></ul></li><li><a href=#灵魂拷问>灵魂拷问</a></li><li><a href=#初步结论>初步结论</a><ul><li><a href=#复用连接与不复用连接对比>复用连接与不复用连接对比</a></li></ul></li><li><a href=#继续拷问>继续拷问</a><ul><li><a href=#为什么效率优化这么大>为什么效率优化这么大？</a></li><li><a href=#100k-数据对比省略返回包>100K 数据对比(省略返回包)</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=背景敏感数据已脱敏>背景(敏感数据已脱敏)</h2><ul><li>由于种种要求，需要将数据上传到海外的 oss 上进行存储。所以开发了一个代理服务维护数据并进行加密等操作。期间内部发现数据上传下载非常慢，经过一系列排查，最终定位到问题根源，并给出解决方案。现将排查过程进行分享。</li><li>当然了，前提之一是<code>内网打通，通过专线网络接入</code>，才能做到理论上的物理极限。使用复杂漫长的公共网络既不适合文件安全，也不适合大文件长时间传输。</li></ul><h2 id=服务本身问题>服务本身问题</h2><img src=/images/2.%20%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93%E4%BC%98%E5%8C%96%E5%88%86%E4%BA%AB/sequence-1-.svg alt=描述 style=width:600px;height:auto><ul><li>最初怀疑是数据落盘导致的太慢。因为上传必须落盘，防止文件过大。下载直接流式传输，非常合理。唯一的改进是上传进行流式加密和传输，但是当前问题不大。</li></ul><h2 id=现象>现象</h2><ul><li>使用编写的脚本上传 1M 的加密数据，耗时接近 2s</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/upload/files&#34;</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;data&#34;</span><span class=p>:</span> <span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>upload_data</span><span class=p>,</span> <span class=s2>&#34;application/json&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;file&#34;</span><span class=p>:</span> <span class=n>transfer_data</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ python oss.py --file_input<span class=o>=</span>./1M.data --region<span class=o>=</span>us --model<span class=o>=</span><span class=m>3</span> --range<span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl>encrypted_upload
</span></span><span class=line><span class=cl>upload ./1M.data, encrypt cost 4.714599609375, upload cost 1788.95849609375
</span></span><span class=line><span class=cl>upload ./1M.data, encrypt cost 10.140625, upload cost 1945.90087890625
</span></span><span class=line><span class=cl>upload ./1M.data, encrypt cost 9.924560546875, upload cost 1756.984130859375
</span></span><span class=line><span class=cl>upload ./1M.data, encrypt cost 8.694580078125, upload cost 1930.31201171875
</span></span><span class=line><span class=cl>upload ./1M.data, encrypt cost 8.279296875, upload cost 1739.38623046875
</span></span></code></pre></td></tr></table></div></div><h2 id=抓包>抓包</h2><ul><li>与运维进行沟通，运维怀疑是网络问题，进行抓包一探究竟。</li></ul><h3 id=抓包演示>抓包演示</h3><h4 id=ping-包>ping 包</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo tcpdump -i bond0 <span class=p>|</span> grep x.x.x.x1
</span></span><span class=line><span class=cl>tcpdump: verbose output suppressed, use -v or -vv <span class=k>for</span> full protocol decode
</span></span><span class=line><span class=cl>listening on bond0, link-type EN10MB <span class=o>(</span>Ethernet<span class=o>)</span>, capture size <span class=m>262144</span> bytes
</span></span><span class=line><span class=cl>16:21:19.255718 IP public2.alidns.com.domain &gt; domain1.36590: <span class=m>43190</span> 1/0/1 A x.x.x.x1 <span class=o>(</span>88<span class=o>)</span>
</span></span><span class=line><span class=cl>16:21:19.256404 IP domain1 &gt; x.x.x.x1: ICMP <span class=nb>echo</span> request, id 32590, seq 1, length <span class=m>64</span>
</span></span><span class=line><span class=cl>16:21:19.456754 IP x.x.x.x1 &gt; domain1: ICMP <span class=nb>echo</span> reply, id 32590, seq 1, length <span class=m>64</span>
</span></span><span class=line><span class=cl>16:21:20.257688 IP domain1 &gt; x.x.x.x1: ICMP <span class=nb>echo</span> request, id 32590, seq 2, length <span class=m>64</span>
</span></span><span class=line><span class=cl>16:21:20.458076 IP x.x.x.x1 &gt; domain1: ICMP <span class=nb>echo</span> reply, id 32590, seq 2, length <span class=m>64</span>
</span></span><span class=line><span class=cl>16:21:21.259088 IP domain1 &gt; x.x.x.x1: ICMP <span class=nb>echo</span> request, id 32590, seq 3, length <span class=m>64</span>
</span></span><span class=line><span class=cl>16:21:21.459506 IP x.x.x.x1 &gt; domain1: ICMP <span class=nb>echo</span> reply, id 32590, seq 3, length <span class=m>64</span>
</span></span><span class=line><span class=cl>16:21:22.260538 IP domain1 &gt; x.x.x.x1: ICMP <span class=nb>echo</span> request, id 32590, seq 4, length <span class=m>64</span>
</span></span><span class=line><span class=cl>16:21:22.460976 IP x.x.x.x1 &gt; domain1: ICMP <span class=nb>echo</span> reply, id 32590, seq 4, length <span class=m>64</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ping domain1
</span></span><span class=line><span class=cl>PING domain1 <span class=o>(</span>x.x.x.x1<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from x.x.x.x1 <span class=o>(</span>x.x.x.x1<span class=o>)</span>: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>58</span> <span class=nv>time</span><span class=o>=</span><span class=m>200</span> ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from x.x.x.x1 <span class=o>(</span>x.x.x.x1<span class=o>)</span>: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>58</span> <span class=nv>time</span><span class=o>=</span><span class=m>200</span> ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from x.x.x.x1 <span class=o>(</span>x.x.x.x1<span class=o>)</span>: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>3</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>58</span> <span class=nv>time</span><span class=o>=</span><span class=m>200</span> ms
</span></span><span class=line><span class=cl>^C
</span></span><span class=line><span class=cl>--- domain1 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>4</span> packets transmitted, <span class=m>3</span> received, 25% packet loss, <span class=nb>time</span> 3004ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 200.395/200.419/200.456/0.517 ms
</span></span></code></pre></td></tr></table></div></div><h4 id=三次握手>三次握手</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>16:54:06.286416 IP domain1.33666 &gt; x.x.x.x1.http: Flags <span class=o>[</span>S<span class=o>]</span>, seq 2682796272, win 64240, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2595135963</span> ecr 0,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:06.486797 IP x.x.x.x1.http &gt; domain1.33666: Flags <span class=o>[</span>S.<span class=o>]</span>, seq 2198055866, ack 2682796273, win 62643, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2062390218</span> ecr 2595135963,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:06.486840 IP domain1.33666 &gt; x.x.x.x1.http: Flags <span class=o>[</span>.<span class=o>]</span>, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2595136163</span> ecr 2062390218<span class=o>]</span>, length <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=四次挥手>四次挥手</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>16:54:28.356723 IP domain1.54028 &gt; x.x.x.x1.http: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 1746, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2595158034</span> ecr 2062412087<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:28.557169 IP x.x.x.x1.http &gt; domain1.54028: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 215, ack 1747, win 477, options <span class=o>[</span>nop,nop,TS val <span class=m>2062412289</span> ecr 2595158034<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:28.557222 IP domain1.54028 &gt; x.x.x.x1.http: Flags <span class=o>[</span>.<span class=o>]</span>, ack 216, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2595158234</span> ecr 2062412289<span class=o>]</span>, length <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=tcpdump-flags>tcpdump Flags</h4><ul><li>Tcpdump flags 是指示 TCP 连接状态或动作的标志。它们通常在 tcpdump 输出中用方括号表示。Tcpdump 输出中有多种 flags，输出也可能包含多个 TCP flags 的组合 1。一些常见的 flags 有：<ul><li>S (SYN): 这个 flag 用于在两个主机之间建立连接。它在三次握手的第一个包中设置。</li><li>. (No flag): 这意味着在包中没有设置任何 flag。它通常用于数据传输或确认包。</li><li>P (PUSH): 这个 flag 用于表示发送方希望尽快发送数据，而不等待缓冲区填满。</li><li>F (FIN): 这个 flag 用于终止两个主机之间的连接。它在四次挥手的最后一个包中设置。</li><li>R (RST): 这个 flag 用于重置处于无效状态或遇到错误的连接。它也用于拒绝不想要的连接尝试。</li><li>W (ECN CWR): 这个 flag 用于表示发送方已经根据网络的显式拥塞通知 (ECN) 减小了其拥塞窗口大小。</li><li>E (ECN-Echo): 这个 flag 用于表示接收方已经收到了一个带有 ECN 位的包，这意味着网络中存在拥塞。</li></ul></li><li>例如，一个带有 flags [S.] 的包意味着它是一个 SYN 包，是建立 TCP 连接的第一步。一个带有 flags [P.] 的包意味着它是一个 PUSH 包，包含了发送方想要快速传送的数据。一个带有 flags [F.] 的包意味着它是一个 FIN 包，是关闭 TCP 连接的最后一步 2。</li></ul><h4 id=为什么-tcpdump-四次挥手只有三个包>为什么 tcpdump 四次挥手只有三个包</h4><ul><li>Tcpdump 四次挥手只有三个包的原因可能有以下几种：<ul><li>一种可能是被动关闭方（收到 FIN 的一方）在回复 ACK 的同时，也发送了自己的 FIN，将第二次和第三次挥手合并为一个报文，节省了一个包 1。这种情况下，被动关闭方已经没有数据要发送了，所以可以直接进入 LAST_ACK 状态，等待主动关闭方的最后一个 ACK。</li><li>另一种可能是主动关闭方（发送 FIN 的一方）在收到被动关闭方的 FIN 后，没有及时回复 ACK，而是在一段时间后才发送 ACK，并且在 ACK 中设置了 RST 标志，表示强制重置连接 2。这种情况下，主动关闭方可能遇到了异常或超时，所以不再等待 2MSL 的时间，而是直接进入 CLOSE 状态。</li><li>还有一种可能是 tcpdump 没有抓到所有的包，因为网络延迟或丢包的原因，导致某个挥手的报文没有被捕获到 3。这种情况下，可以尝试重新抓包或增加抓包的时间范围，看是否能够看到完整的四次挥手过程。</li></ul></li></ul><h3 id=实际数据>实际数据</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ python oss.py --file_input<span class=o>=</span>./1K.data --file_output<span class=o>=</span>./download-1M.data --region<span class=o>=</span>us --model<span class=o>=</span><span class=m>3</span> --range<span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl>encrypted_upload
</span></span><span class=line><span class=cl>http://domain1 upload ./1K.data, encrypt cost 1.530029296875, upload cost 408.5546875
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo tcpdump -i bond0 <span class=p>|</span> grep x.x.x.x1
</span></span><span class=line><span class=cl>tcpdump: verbose output suppressed, use -v or -vv <span class=k>for</span> full protocol decode
</span></span><span class=line><span class=cl>listening on bond0, link-type EN10MB <span class=o>(</span>Ethernet<span class=o>)</span>, capture size <span class=m>262144</span> bytes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>16:54:06.286416 IP domain1.33666 &gt; x.x.x.x1.http: Flags <span class=o>[</span>S<span class=o>]</span>, seq 2682796272, win 64240, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2595135963</span> ecr 0,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:06.486797 IP x.x.x.x1.http &gt; domain1.33666: Flags <span class=o>[</span>S.<span class=o>]</span>, seq 2198055866, ack 2682796273, win 62643, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2062390218</span> ecr 2595135963,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:06.486840 IP domain1.33666 &gt; x.x.x.x1.http: Flags <span class=o>[</span>.<span class=o>]</span>, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2595136163</span> ecr 2062390218<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:06.486930 IP domain1.33666 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:292, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2595136164</span> ecr 2062390218<span class=o>]</span>, length 291: HTTP: POST /upload/files HTTP/1.1
</span></span><span class=line><span class=cl>16:54:06.486960 IP domain1.33666 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 292:1746, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2595136164</span> ecr 2062390218<span class=o>]</span>, length 1454: HTTP
</span></span><span class=line><span class=cl>16:54:06.687234 IP x.x.x.x1.http &gt; domain1.33666: Flags <span class=o>[</span>.<span class=o>]</span>, ack 292, win 488, options <span class=o>[</span>nop,nop,TS val <span class=m>2062390419</span> ecr 2595136164<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:06.687279 IP x.x.x.x1.http &gt; domain1.33666: Flags <span class=o>[</span>.<span class=o>]</span>, ack 1746, win 477, options <span class=o>[</span>nop,nop,TS val <span class=m>2062390419</span> ecr 2595136164<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:06.690277 IP x.x.x.x1.http &gt; domain1.33666: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:215, ack 1746, win 477, options <span class=o>[</span>nop,nop,TS val <span class=m>2062390422</span> ecr 2595136164<span class=o>]</span>, length 214: HTTP: HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>16:54:06.690314 IP domain1.33666 &gt; x.x.x.x1.http: Flags <span class=o>[</span>.<span class=o>]</span>, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2595136367</span> ecr 2062390422<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:06.692023 IP domain1.33666 &gt; x.x.x.x1.http: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 1746, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2595136369</span> ecr 2062390422<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:06.892401 IP x.x.x.x1.http &gt; domain1.33666: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 215, ack 1747, win 477, options <span class=o>[</span>nop,nop,TS val <span class=m>2062390624</span> ecr 2595136369<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>16:54:06.892448 IP domain1.33666 &gt; x.x.x.x1.http: Flags <span class=o>[</span>.<span class=o>]</span>, ack 216, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2595136569</span> ecr 2062390624<span class=o>]</span>, length <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>实际是上传 1M 数据，进行分析，此处简化。</li><li>因为时间跳跃增长全部发生在服务端返回的数据包。此时问题已经很明了了，由于深圳和美东现实的物理距离，200ms 的来回已经做到了极限。所以其实是合理的。</li></ul><h2 id=灵魂拷问>灵魂拷问</h2><ul><li>此时，一个灵魂拷问出现了，为什么之前走公网反而更快？</li><li>与兄弟部门同事沟通，模拟他们的代码，使用 aws 的 sdk 进行测试</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>boto3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>boto3.s3.transfer</span> <span class=kn>import</span> <span class=n>TransferConfig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>download</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>s3_client</span> <span class=o>=</span> <span class=n>client</span><span class=p>(</span><span class=n>access_key</span><span class=p>,</span> <span class=n>access_secret</span><span class=p>,</span> <span class=n>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>GB</span> <span class=o>=</span> <span class=mi>1024</span> <span class=o>**</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span> <span class=o>=</span> <span class=n>TransferConfig</span><span class=p>(</span><span class=n>multipart_threshold</span><span class=o>=</span><span class=mi>2</span> <span class=o>*</span> <span class=n>GB</span><span class=p>,</span> <span class=n>max_concurrency</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>use_threads</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s3_client</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=n>Bucket</span><span class=o>=</span><span class=s2>&#34;bucket&#34;</span><span class=p>,</span> <span class=n>Key</span><span class=o>=</span><span class=s2>&#34;name-100.jpg&#34;</span><span class=p>,</span> <span class=n>Filename</span><span class=o>=</span><span class=s2>&#34;name-100.jpg&#34;</span><span class=p>,</span> <span class=n>Config</span><span class=o>=</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>download</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># ...</span>
</span></span><span class=line><span class=cl>    <span class=n>download</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>结果</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>2.359457492828369
</span></span><span class=line><span class=cl>2.34989070892334
</span></span><span class=line><span class=cl>2.4120875199635825
</span></span><span class=line><span class=cl>2.3953704833984375
</span></span><span class=line><span class=cl>2.382766008377075
</span></span><span class=line><span class=cl>2.3793430725733438
</span></span><span class=line><span class=cl>2.3801622731345042
</span></span><span class=line><span class=cl>2.374732166528702
</span></span><span class=line><span class=cl>2.393121269014147
</span></span><span class=line><span class=cl>2.387941288948059
</span></span><span class=line><span class=cl>2.3849898034876045
</span></span><span class=line><span class=cl>2.3809364239374795
</span></span><span class=line><span class=cl>2.382789208338811
</span></span><span class=line><span class=cl>2.379830701010568
</span></span><span class=line><span class=cl>2.3768802642822267
</span></span><span class=line><span class=cl>2.3746740520000458
</span></span><span class=line><span class=cl>2.374574675279505
</span></span><span class=line><span class=cl>2.3716080056296454
</span></span></code></pre></td></tr></table></div></div><ul><li>可以看出，使用 aws-sdk，反而更慢。这就更奇怪了，为什么没有复现出兄弟部门的结果？</li><li>首先看到 config 里的<code>max_concurrency=10</code>给了我一定的迷惑，client 肯定是自己支持线程池的，但是看起来没有用到，因为每次初始化了新的 client</li></ul><p><strong>优化</strong></p><ul><li>所以复用 client 进行测试</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>download</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>s3_client</span> <span class=o>=</span> <span class=n>client</span><span class=p>(</span><span class=n>access_key</span><span class=p>,</span> <span class=n>access_secret</span><span class=p>,</span> <span class=n>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>GB</span> <span class=o>=</span> <span class=mi>1024</span> <span class=o>**</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span> <span class=o>=</span> <span class=n>TransferConfig</span><span class=p>(</span><span class=n>multipart_threshold</span><span class=o>=</span><span class=mi>2</span> <span class=o>*</span> <span class=n>GB</span><span class=p>,</span> <span class=n>max_concurrency</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>use_threads</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>count</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>s3_client</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=n>Bucket</span><span class=o>=</span><span class=s2>&#34;bucket&#34;</span><span class=p>,</span> <span class=n>Key</span><span class=o>=</span><span class=s2>&#34;name-100.jpg&#34;</span><span class=p>,</span> <span class=n>Filename</span><span class=o>=</span><span class=s2>&#34;name-100.jpg&#34;</span><span class=p>,</span> <span class=n>Config</span><span class=o>=</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>((</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>now</span><span class=p>)</span> <span class=o>/</span> <span class=n>count</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>结果</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>download
</span></span><span class=line><span class=cl>2.465491533279419
</span></span><span class=line><span class=cl>1.5669758319854736
</span></span><span class=line><span class=cl>1.2221351464589436
</span></span><span class=line><span class=cl>1.0315884947776794
</span></span><span class=line><span class=cl>0.9212518692016601
</span></span><span class=line><span class=cl>0.8434466520945231
</span></span><span class=line><span class=cl>0.7922392232077462
</span></span><span class=line><span class=cl>0.7573718726634979
</span></span><span class=line><span class=cl>0.7251839107937283
</span></span><span class=line><span class=cl>0.6981703996658325
</span></span><span class=line><span class=cl>0.6772929538380016
</span></span><span class=line><span class=cl>0.6588474710782369
</span></span><span class=line><span class=cl>0.6429501130030706
</span></span><span class=line><span class=cl>0.6297299180712018
</span></span><span class=line><span class=cl>0.6190152009328206
</span></span><span class=line><span class=cl>0.6086597740650177
</span></span><span class=line><span class=cl>0.5995960656334373
</span></span><span class=line><span class=cl>0.5917102760738797
</span></span><span class=line><span class=cl>0.585765048077232
</span></span><span class=line><span class=cl>0.5791293740272522
</span></span></code></pre></td></tr></table></div></div><ul><li>根据结果发现，只是以为默认框架全复用连接。修改为复用连接后，效果极佳。</li><li>而且正在接近理论极限值 200ms(无限带宽，一次交互)</li></ul><h2 id=初步结论>初步结论</h2><ul><li>首先，关于如何加速传输，已经有了最直接的结论。复用连接即可，下文贴出 1M 文件的对比</li></ul><h3 id=复用连接与不复用连接对比>复用连接与不复用连接对比</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ python oss.py --file_input<span class=o>=</span>./1M.data --file_output<span class=o>=</span>./download-1M.data --region<span class=o>=</span>us --model<span class=o>=</span><span class=m>3</span> --range<span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl>encrypted_upload
</span></span><span class=line><span class=cl>http://domain1 upload ./1M.data, encrypt cost 4.924560546875, upload cost 1919.100341796875
</span></span><span class=line><span class=cl>http://domain1 upload ./1M.data, encrypt cost 4.593017578125, upload cost 1715.593994140625
</span></span><span class=line><span class=cl>http://domain1 upload ./1M.data, encrypt cost 10.076171875, upload cost 2253.67333984375
</span></span><span class=line><span class=cl>http://domain1 upload ./1M.data, encrypt cost 12.694091796875, upload cost 1714.197021484375
</span></span><span class=line><span class=cl>http://domain1 upload ./1M.data, encrypt cost 12.3076171875, upload cost 2152.773193359375
</span></span></code></pre></td></tr></table></div></div><h2 id=继续拷问>继续拷问</h2><ul><li>本来，一切的一切，到这里都结束了，复用连接，效率极其提高。与服务端无关，仅与客户端有关，客户端交给兄弟部门进行改造即可。</li><li>直到兄弟部门反馈了一个问题——为什么服务端会断开连接？</li><li>我通过网上查询和翻源码的默认值，发现<ol><li>服务端默认支持 8192 连接</li><li>默认客户端连接 30m 超时或永不超时</li></ol></li><li>明显都与事实不符合</li><li>然后兄弟部门开始监听连接状态，发现连接状态快速进入了 CLOSE_WAIT 的状态。明显是服务端接收到了 FIN 包。为了说明该情况，通过抓包，实际证明了兄弟部门代码问题导致发送了 FIN 包。</li><li>由于我非常认可通过抓包和监听连接状态的方式来查找问题，我打算复现一下之前的情况来介绍一下抓包工具和方法。但是复现的过程中，我开始了灵魂拷问</li></ul><h3 id=为什么效率优化这么大>为什么效率优化这么大？</h3><ul><li>按照朴素的思想，复用连接，应该是省略了三次握手和四次挥手，根据上述的了解，应该仅优化 400ms 左右才对。然而事实并非如此，而是秒级别优化，这是为什么？</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 朴素思想中的不复用连接传包</span>
</span></span><span class=line><span class=cl>1. <span class=o>[</span>S<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>F<span class=o>]</span>
</span></span><span class=line><span class=cl>2.                   <span class=o>[</span>S<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>F<span class=o>]</span>
</span></span><span class=line><span class=cl>3.                                     <span class=o>[</span>S<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>F<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=c1># 朴素思想中的复用连接传包</span>
</span></span><span class=line><span class=cl>1. <span class=o>[</span>S<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>]</span>
</span></span><span class=line><span class=cl>2.                <span class=o>[</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>]</span>
</span></span><span class=line><span class=cl>3.                            <span class=o>[</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>F<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ python oss-muti.py --file_input<span class=o>=</span>./1M.data --file_output<span class=o>=</span>./download-1M.data --region<span class=o>=</span>us --model<span class=o>=</span><span class=m>3</span> --range<span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl>encrypted_upload
</span></span><span class=line><span class=cl>http://domain1 upload ./1M.data, encrypt cost 5.02880859375, upload cost 2589.014892578125
</span></span><span class=line><span class=cl>http://domain1 upload ./1M.data, encrypt cost 10.720947265625, upload cost 562.706787109375
</span></span><span class=line><span class=cl>http://domain1 upload ./1M.data, encrypt cost 11.202392578125, upload cost 370.651611328125
</span></span><span class=line><span class=cl>http://domain1 upload ./1M.data, encrypt cost 10.948486328125, upload cost 372.409423828125
</span></span><span class=line><span class=cl>http://domain1 upload ./1M.data, encrypt cost 11.99560546875, upload cost 371.28759765625
</span></span></code></pre></td></tr></table></div></div><ul><li>所以再次抓包进行深究</li></ul><h3 id=100k-数据对比省略返回包>100K 数据对比(省略返回包)</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ python oss.py --file_input<span class=o>=</span>./100K.data --file_output<span class=o>=</span>./100K.data --region<span class=o>=</span>us --model<span class=o>=</span><span class=m>3</span> --range<span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl>encrypted_upload
</span></span><span class=line><span class=cl>http://domain1 upload ./100K.data, encrypt cost 1.81884765625, upload cost 1017.35791015625
</span></span><span class=line><span class=cl>http://domain1 upload ./100K.data, encrypt cost 1.159912109375, upload cost 1021.509521484375
</span></span><span class=line><span class=cl>http://domain1 upload ./100K.data, encrypt cost 1.11669921875, upload cost 1016.612548828125
</span></span><span class=line><span class=cl>http://domain1 upload ./100K.data, encrypt cost 1.128662109375, upload cost 1016.171875
</span></span><span class=line><span class=cl>http://domain1 upload ./100K.data, encrypt cost 0.9912109375, upload cost 1016.228759765625
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo tcpdump -i bond0 <span class=p>|</span> grep x.x.x.x1
</span></span><span class=line><span class=cl>tcpdump: verbose output suppressed, use -v or -vv <span class=k>for</span> full protocol decode
</span></span><span class=line><span class=cl>listening on bond0, link-type EN10MB <span class=o>(</span>Ethernet<span class=o>)</span>, capture size <span class=m>262144</span> bytes
</span></span><span class=line><span class=cl>17:16:03.069540 IP domain1.53580 &gt; x.x.x.x1.http: Flags <span class=o>[</span>S<span class=o>]</span>, seq 4211566581, win 64240, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2596452757</span> ecr 0,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:03.270682 IP x.x.x.x1.http &gt; domain1.53580: Flags <span class=o>[</span>S.<span class=o>]</span>, seq 1741768869, ack 4211566582, win 62643, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2063707002</span> ecr 2596452757,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:03.270850 IP domain1.53580 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:294, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596452958</span> ecr 2063707002<span class=o>]</span>, length 293: HTTP: POST /upload/files HTTP/1.1
</span></span><span class=line><span class=cl>17:16:03.680467 IP domain1.53580 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 72694:74142, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596453367</span> ecr 2063707405<span class=o>]</span>, length 1448: HTTP
</span></span><span class=line><span class=cl>17:16:03.874400 IP domain1.53580 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 101758:103124, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596453561</span> ecr 2063707606<span class=o>]</span>, length 1366: HTTP
</span></span><span class=line><span class=cl>17:16:04.082005 IP x.x.x.x1.http &gt; domain1.53580: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:215, ack 103124, win 442, options <span class=o>[</span>nop,nop,TS val <span class=m>2063707813</span> ecr 2596453561<span class=o>]</span>, length 214: HTTP: HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>17:16:04.083769 IP domain1.53580 &gt; x.x.x.x1.http: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 103124, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596453771</span> ecr 2063707813<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:04.090059 IP domain1.44338 &gt; x.x.x.x1.http: Flags <span class=o>[</span>S<span class=o>]</span>, seq 3876376673, win 64240, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2596453777</span> ecr 0,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:04.284937 IP x.x.x.x1.http &gt; domain1.53580: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 215, ack 103125, win 442, options <span class=o>[</span>nop,nop,TS val <span class=m>2063708016</span> ecr 2596453771<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:04.291110 IP x.x.x.x1.http &gt; domain1.44338: Flags <span class=o>[</span>S.<span class=o>]</span>, seq 27078140, ack 3876376674, win 62643, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2063708023</span> ecr 2596453777,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:04.291270 IP domain1.44338 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:294, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596453978</span> ecr 2063708023<span class=o>]</span>, length 293: HTTP: POST /upload/files HTTP/1.1
</span></span><span class=line><span class=cl>17:16:04.693394 IP domain1.44338 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 42286:43734, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596454380</span> ecr 2063708425<span class=o>]</span>, length 1448: HTTP
</span></span><span class=line><span class=cl>17:16:04.720945 IP domain1.44338 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 72694:74142, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596454408</span> ecr 2063708425<span class=o>]</span>, length 1448: HTTP
</span></span><span class=line><span class=cl>17:16:04.894505 IP domain1.44338 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 101838:103124, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596454582</span> ecr 2063708626<span class=o>]</span>, length 1286: HTTP
</span></span><span class=line><span class=cl>17:16:05.105003 IP x.x.x.x1.http &gt; domain1.44338: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:215, ack 103124, win 442, options <span class=o>[</span>nop,nop,TS val <span class=m>2063708837</span> ecr 2596454582<span class=o>]</span>, length 214: HTTP: HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>17:16:05.106641 IP domain1.44338 &gt; x.x.x.x1.http: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 103124, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596454794</span> ecr 2063708837<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:05.112610 IP domain1.44340 &gt; x.x.x.x1.http: Flags <span class=o>[</span>S<span class=o>]</span>, seq 1962726172, win 64240, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2596454800</span> ecr 0,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:05.307713 IP x.x.x.x1.http &gt; domain1.44338: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 215, ack 103125, win 442, options <span class=o>[</span>nop,nop,TS val <span class=m>2063709039</span> ecr 2596454794<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:05.313623 IP x.x.x.x1.http &gt; domain1.44340: Flags <span class=o>[</span>S.<span class=o>]</span>, seq 2582074627, ack 1962726173, win 62643, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2063709045</span> ecr 2596454800,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:05.313779 IP domain1.44340 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:294, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596455001</span> ecr 2063709045<span class=o>]</span>, length 293: HTTP: POST /upload/files HTTP/1.1
</span></span><span class=line><span class=cl>17:16:05.515156 IP domain1.44340 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 36494:39390, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596455202</span> ecr 2063709246<span class=o>]</span>, length 2896: HTTP
</span></span><span class=line><span class=cl>17:16:05.739645 IP domain1.44340 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 68350:69798, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596455427</span> ecr 2063709448<span class=o>]</span>, length 1448: HTTP
</span></span><span class=line><span class=cl>17:16:05.917341 IP domain1.44340 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 103102:103124, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596455604</span> ecr 2063709649<span class=o>]</span>, length 22: HTTP
</span></span><span class=line><span class=cl>17:16:06.123141 IP x.x.x.x1.http &gt; domain1.44340: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:215, ack 103124, win 442, options <span class=o>[</span>nop,nop,TS val <span class=m>2063709855</span> ecr 2596455604<span class=o>]</span>, length 214: HTTP: HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>17:16:06.124569 IP domain1.44340 &gt; x.x.x.x1.http: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 103124, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596455812</span> ecr 2063709855<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:06.130364 IP domain1.44356 &gt; x.x.x.x1.http: Flags <span class=o>[</span>S<span class=o>]</span>, seq 3551691514, win 64240, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2596455817</span> ecr 0,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:06.325653 IP x.x.x.x1.http &gt; domain1.44340: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 215, ack 103125, win 442, options <span class=o>[</span>nop,nop,TS val <span class=m>2063710057</span> ecr 2596455812<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:06.331375 IP x.x.x.x1.http &gt; domain1.44356: Flags <span class=o>[</span>S.<span class=o>]</span>, seq 3143448434, ack 3551691515, win 62643, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2063710063</span> ecr 2596455817,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:06.331580 IP domain1.44356 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:294, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596456019</span> ecr 2063710063<span class=o>]</span>, length 293: HTTP: POST /upload/files HTTP/1.1
</span></span><span class=line><span class=cl>17:16:06.532839 IP domain1.44356 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 36494:39390, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596456220</span> ecr 2063710264<span class=o>]</span>, length 2896: HTTP
</span></span><span class=line><span class=cl>17:16:06.733906 IP domain1.44356 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 68350:69798, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596456421</span> ecr 2063710465<span class=o>]</span>, length 1448: HTTP
</span></span><span class=line><span class=cl>17:16:06.934842 IP domain1.44356 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 103102:103124, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596456622</span> ecr 2063710666<span class=o>]</span>, length 22: HTTP
</span></span><span class=line><span class=cl>17:16:07.140676 IP x.x.x.x1.http &gt; domain1.44356: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:215, ack 103124, win 442, options <span class=o>[</span>nop,nop,TS val <span class=m>2063710872</span> ecr 2596456622<span class=o>]</span>, length 214: HTTP: HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>17:16:07.142071 IP domain1.44356 &gt; x.x.x.x1.http: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 103124, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596456829</span> ecr 2063710872<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:07.147323 IP domain1.44368 &gt; x.x.x.x1.http: Flags <span class=o>[</span>S<span class=o>]</span>, seq 402085581, win 64240, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2596456834</span> ecr 0,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:07.343075 IP x.x.x.x1.http &gt; domain1.44356: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 215, ack 103125, win 442, options <span class=o>[</span>nop,nop,TS val <span class=m>2063711075</span> ecr 2596456829<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:07.348425 IP x.x.x.x1.http &gt; domain1.44368: Flags <span class=o>[</span>S.<span class=o>]</span>, seq 2536787598, ack 402085582, win 62643, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2063711080</span> ecr 2596456834,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:07.348648 IP domain1.44368 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:294, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596457036</span> ecr 2063711080<span class=o>]</span>, length 293: HTTP: POST /upload/files HTTP/1.1
</span></span><span class=line><span class=cl>17:16:07.550153 IP domain1.44368 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 36494:39390, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596457237</span> ecr 2063711281<span class=o>]</span>, length 2896: HTTP
</span></span><span class=line><span class=cl>17:16:07.751340 IP domain1.44368 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 68350:69798, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596457438</span> ecr 2063711483<span class=o>]</span>, length 1448: HTTP
</span></span><span class=line><span class=cl>17:16:07.952350 IP domain1.44368 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 103102:103124, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596457639</span> ecr 2063711684<span class=o>]</span>, length 22: HTTP
</span></span><span class=line><span class=cl>17:16:08.158407 IP x.x.x.x1.http &gt; domain1.44368: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:215, ack 103124, win 442, options <span class=o>[</span>nop,nop,TS val <span class=m>2063711890</span> ecr 2596457639<span class=o>]</span>, length 214: HTTP: HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>17:16:08.159502 IP domain1.44368 &gt; x.x.x.x1.http: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 103124, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596457847</span> ecr 2063711890<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:08.360623 IP x.x.x.x1.http &gt; domain1.44368: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 215, ack 103125, win 442, options <span class=o>[</span>nop,nop,TS val <span class=m>2063712092</span> ecr 2596457847<span class=o>]</span>, length <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ python oss-muti.py --file_input<span class=o>=</span>./100K.data --file_output<span class=o>=</span>./100K.data --region<span class=o>=</span>us --model<span class=o>=</span><span class=m>3</span> --range<span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl>encrypted_upload
</span></span><span class=line><span class=cl>http://domain1 upload ./100K.data, encrypt cost 1.713134765625, upload cost 1019.947265625
</span></span><span class=line><span class=cl>http://domain1 upload ./100K.data, encrypt cost 1.129638671875, upload cost 438.734375
</span></span><span class=line><span class=cl>http://domain1 upload ./100K.data, encrypt cost 0.930419921875, upload cost 268.240966796875
</span></span><span class=line><span class=cl>http://domain1 upload ./100K.data, encrypt cost 0.880615234375, upload cost 253.253662109375
</span></span><span class=line><span class=cl>http://domain1 upload ./100K.data, encrypt cost 1.1396484375, upload cost 254.03173828125
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo tcpdump -i bond0 <span class=p>|</span> grep x.x.x.x1
</span></span><span class=line><span class=cl>tcpdump: verbose output suppressed, use -v or -vv <span class=k>for</span> full protocol decode
</span></span><span class=line><span class=cl>listening on bond0, link-type EN10MB <span class=o>(</span>Ethernet<span class=o>)</span>, capture size <span class=m>262144</span> bytes
</span></span><span class=line><span class=cl>17:16:58.582227 IP public1.alidns.com.domain &gt; domain1.46151: <span class=m>50311</span> 1/0/1 A x.x.x.x1 <span class=o>(</span>88<span class=o>)</span>
</span></span><span class=line><span class=cl>17:16:58.582538 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>S<span class=o>]</span>, seq 2857978823, win 64240, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2596508270</span> ecr 0,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:58.783718 IP x.x.x.x1.http &gt; domain1.59132: Flags <span class=o>[</span>S.<span class=o>]</span>, seq 4037665047, ack 2857978824, win 62643, options <span class=o>[</span>mss 1460,sackOK,TS val <span class=m>2063762515</span> ecr 2596508270,nop,wscale 7<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:16:58.784028 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:294, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596508471</span> ecr 2063762515<span class=o>]</span>, length 293: HTTP: POST /upload/files HTTP/1.1
</span></span><span class=line><span class=cl>17:16:59.186612 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 42286:43734, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596508874</span> ecr 2063762918<span class=o>]</span>, length 1448: HTTP
</span></span><span class=line><span class=cl>17:16:59.214991 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 72694:74142, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596508902</span> ecr 2063762918<span class=o>]</span>, length 1448: HTTP
</span></span><span class=line><span class=cl>17:16:59.387945 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 101758:103124, ack 1, win 502, options <span class=o>[</span>nop,nop,TS val <span class=m>2596509075</span> ecr 2063763119<span class=o>]</span>, length 1366: HTTP
</span></span><span class=line><span class=cl>17:16:59.594321 IP x.x.x.x1.http &gt; domain1.59132: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 1:215, ack 103124, win 442, options <span class=o>[</span>nop,nop,TS val <span class=m>2063763326</span> ecr 2596509075<span class=o>]</span>, length 214: HTTP: HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>17:16:59.600269 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 103124:103417, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596509288</span> ecr 2063763326<span class=o>]</span>, length 293: HTTP: POST /upload/files HTTP/1.1
</span></span><span class=line><span class=cl>17:16:59.616693 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 141065:142513, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596509304</span> ecr 2063763326<span class=o>]</span>, length 1448: HTTP
</span></span><span class=line><span class=cl>17:16:59.807008 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 171284:172921, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596509494</span> ecr 2063763538<span class=o>]</span>, length 1637: HTTP
</span></span><span class=line><span class=cl>17:16:59.828692 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 206225:206247, ack 215, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596509516</span> ecr 2063763560<span class=o>]</span>, length 22: HTTP
</span></span><span class=line><span class=cl>17:17:00.034796 IP x.x.x.x1.http &gt; domain1.59132: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 215:429, ack 206247, win 1079, options <span class=o>[</span>nop,nop,TS val <span class=m>2063763766</span> ecr 2596509516<span class=o>]</span>, length 214: HTTP: HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>17:17:00.038874 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 206247:206540, ack 429, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596509726</span> ecr 2063763766<span class=o>]</span>, length 293: HTTP: POST /upload/files HTTP/1.1
</span></span><span class=line><span class=cl>17:17:00.080191 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 281836:283284, ack 429, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596509768</span> ecr 2063763766<span class=o>]</span>, length 1448: HTTP
</span></span><span class=line><span class=cl>17:17:00.098087 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 309348:309370, ack 429, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596509786</span> ecr 2063763766<span class=o>]</span>, length 22: HTTP
</span></span><span class=line><span class=cl>17:17:00.304214 IP x.x.x.x1.http &gt; domain1.59132: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 429:643, ack 309370, win 2029, options <span class=o>[</span>nop,nop,TS val <span class=m>2063764036</span> ecr 2596509786<span class=o>]</span>, length 214: HTTP: HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>17:17:00.308554 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 309370:309663, ack 643, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596509996</span> ecr 2063764036<span class=o>]</span>, length 293: HTTP: POST /upload/files HTTP/1.1
</span></span><span class=line><span class=cl>17:17:00.349857 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 412471:412493, ack 643, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596510037</span> ecr 2063764036<span class=o>]</span>, length 22: HTTP
</span></span><span class=line><span class=cl>17:17:00.558243 IP x.x.x.x1.http &gt; domain1.59132: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 643:857, ack 412493, win 3590, options <span class=o>[</span>nop,nop,TS val <span class=m>2063764290</span> ecr 2596510037<span class=o>]</span>, length 214: HTTP: HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>17:17:00.563952 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 412493:412786, ack 857, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596510251</span> ecr 2063764290<span class=o>]</span>, length 293: HTTP: POST /upload/files HTTP/1.1
</span></span><span class=line><span class=cl>17:17:00.605371 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 515594:515616, ack 857, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596510293</span> ecr 2063764290<span class=o>]</span>, length 22: HTTP
</span></span><span class=line><span class=cl>17:17:00.813565 IP x.x.x.x1.http &gt; domain1.59132: Flags <span class=o>[</span>P.<span class=o>]</span>, seq 857:1071, ack 515616, win 5197, options <span class=o>[</span>nop,nop,TS val <span class=m>2063764545</span> ecr 2596510293<span class=o>]</span>, length 214: HTTP: HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>17:17:00.832862 IP domain1.59132 &gt; x.x.x.x1.http: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 515616, ack 1071, win 501, options <span class=o>[</span>nop,nop,TS val <span class=m>2596510520</span> ecr 2063764545<span class=o>]</span>, length <span class=m>0</span>
</span></span><span class=line><span class=cl>17:17:01.033981 IP x.x.x.x1.http &gt; domain1.59132: Flags <span class=o>[</span>F.<span class=o>]</span>, seq 1071, ack 515617, win 5197, options <span class=o>[</span>nop,nop,TS val <span class=m>2063764765</span> ecr 2596510520<span class=o>]</span>, length <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>首先可以明显看出，复用连接后续的 P 包传输数量明显减少，且对应业务打印的时间。包减少了，文件没变小，只能说明传输本身变大了。这时，TCP 的窗口、拥塞的知识开始从我的脑海中复活。</li><li>具体完整窗口变大可以自己进行尝试。可以明显看到，tcp 中，客户端单次发送的数据包逐步增加。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 朴素思想中的不复用连接传包</span>
</span></span><span class=line><span class=cl>1. <span class=o>[</span>S<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>F<span class=o>]</span>
</span></span><span class=line><span class=cl>2.                <span class=o>[</span>S<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>F<span class=o>]</span>
</span></span><span class=line><span class=cl>3.                               <span class=o>[</span>S<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>F<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=c1># 朴素思想中的复用连接传包</span>
</span></span><span class=line><span class=cl>1. <span class=o>[</span>S<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>]</span>
</span></span><span class=line><span class=cl>2.                <span class=o>[</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>]</span>
</span></span><span class=line><span class=cl>3.                            <span class=o>[</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>P<span class=o>][</span>F<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=c1># 实际传包</span>
</span></span><span class=line><span class=cl>1. <span class=o>[</span>S<span class=o>][</span>p<span class=o>][</span>p<span class=o>][</span>p<span class=o>][</span>p<span class=o>]</span>
</span></span><span class=line><span class=cl>2.                <span class=o>{</span>P<span class=o>}{</span>P<span class=o>}</span>
</span></span><span class=line><span class=cl>3.                      <span class=o>{</span>P<span class=o>}{</span>P<span class=o>}[</span>F<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Tcp 窗口适应是指 TCP 根据网络状况动态调整发送和接收窗口的大小，以达到最优的传输效率。TCP 窗口适应涉及到以下几个方面</strong></p><ol><li>接收窗口：接收方通告给发送方的可接收数据的字节数，用于进行流量控制，避免发送方发送过快导致接收方缓冲区溢出。</li><li>拥塞窗口：发送方根据网络拥塞程度自行维护的可发送数据的字节数，用于进行拥塞控制，避免发送方发送过快导致网络拥塞。</li><li>滑动窗口：发送方根据接收窗口和拥塞窗口的较小值确定的可发送数据的字节数，用于进行滑动窗口协议，保证数据的有序和可靠传输。</li><li>窗口缩放：TCP 头部选项中的一种，用于扩展接收窗口的大小，允许接收方通告超过 65535 字节的窗口值，以适应高速网络。</li><li>慢启动：拥塞控制算法中的一种，用于在连接建立后或发生超时重传后，将拥塞窗口初始化为一个较小的值（通常为 1 个 MSS），然后每收到一个 ACK 就将拥塞窗口加 1 个 MSS，使得拥塞窗口呈指数增长，直到达到一个慢启动门限 1（ssthresh）或发生丢包。</li><li>拥塞避免：拥塞控制算法中的一种，用于在拥塞窗口达到慢启动门限后，将拥塞窗口改为每经过一个 RTT 就加 1 个 MSS，使得拥塞窗口呈线性增长，直到发生丢包。</li><li>快速重传：重传机制中的一种，用于在收到三个相同的 ACK 后，不等待超时定时器到期就立即重传丢失的报文段。</li><li>快速恢复：拥塞控制算法中的一种，用于在发生快速重传后，将慢启动门限设为当前拥塞窗口的一半，并将拥塞窗口设为慢启动门限加三个 MSS（对应三个重复 ACK），然后进入拥塞避免阶段。</li></ol><p><strong>连接池，都有优化哪些?</strong></p><ol><li>预创建连接，减少了使用时的创建销毁消耗。</li><li>复用连接，减少了连接本身的创建和销毁。</li><li>根据网络协议和网络现状，优化传输效率</li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2025-12-06&nbsp;<a class=git-hash href=https://github.com/GOODDAYDAY/GOODDAYDAY.github.io/commit/af3d5c9bd409e602f90f3dec7c5441cd7924d96f target=_blank title="commit by haotian(865700600@qq.com) af3d5c9bd409e602f90f3dec7c5441cd7924d96f: Refactor Redis Cluster documentation for clarity and consistency">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>af3d5c9</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/zh-cn/2025/09/network-1.-file-transfer-optimization/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://gooddayday.github.io/zh-cn/2025/09/network-1.-file-transfer-optimization/ data-title="[Network] 1. 文件传输优化分享" data-hashtags=network,tcpdump><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://gooddayday.github.io/zh-cn/2025/09/network-1.-file-transfer-optimization/ data-hashtag=network><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://gooddayday.github.io/zh-cn/2025/09/network-1.-file-transfer-optimization/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://gooddayday.github.io/zh-cn/2025/09/network-1.-file-transfer-optimization/ data-title="[Network] 1. 文件传输优化分享"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://gooddayday.github.io/zh-cn/2025/09/network-1.-file-transfer-optimization/ data-title="[Network] 1. 文件传输优化分享"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://gooddayday.github.io/zh-cn/2025/09/network-1.-file-transfer-optimization/ data-title="[Network] 1. 文件传输优化分享"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/zh-cn/tags/network/>Network</a>,&nbsp;<a href=/zh-cn/tags/tcpdump/>Tcpdump</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/zh-cn/>主页</a></span></section></div><div class=post-nav><a href=/zh-cn/2025/09/github-1.-deploy-github-blog-site/ class=prev rel=prev title="[Github] 1. 部署 GitHub 博客站点"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>[Github] 1. 部署 GitHub 博客站点</a>
<a href=/zh-cn/2025/09/mysql-1.-mysql-fast-query-insights/ class=next rel=next title="[MySQL] 1. 浅谈 MySQL 快速查询">[MySQL] 1. 浅谈 MySQL 快速查询<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><span class=author itemprop=copyrightHolder>&nbsp;<a href=/zh-cn/ target=_blank>GoodyHao</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><link rel=stylesheet href=/css/auto-numbering.css><link rel=stylesheet href=/css/svg-fullwidth.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOPtWtCc4CvteQ",darkTheme:"dark",emitMetadata:"0",inputPosition:"bottom",lang:"zh-CN",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"GOODDAYDAY/GOODDAYDAY.github.io",repoId:"R_kgDOPtWtCQ"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.zh-cn",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>